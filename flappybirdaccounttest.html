<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flappy Bird – Public Accounts & Admin Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet"/>
  <style>
    html,body{margin:0;padding:0;width:100vw;height:100vh;background:#000;overflow:hidden;font-family:Arial,sans-serif}
    #background{position:absolute;top:0;left:0;width:100%;height:100%;background:url('https://app.masonnet.org/lightbg.png')center/cover no-repeat;z-index:0;display:none}
    canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;touch-action:none}
    #score{position:absolute;top:10px;left:10px;font-family:'Press Start 2P',system-ui;font-size:48px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.7);z-index:2}
    #pauseBtn{position:absolute;top:10px;right:10px;display:none;z-index:2;background:#f00;color:#fff;border:none;padding:8px 16px;font-size:16px;cursor:pointer}

    /* PROFILE CARD */
    #profileCard{position:absolute;top:10px;right:10px;width:64px;height:64px;background:rgba(0,0,0,0.7);border:2px solid #f00;border-radius:8px;overflow:hidden;cursor:pointer;z-index:4;transition:width .2s,height .2s}
    #profileCard.expanded{width:280px;height:auto}
    #pc-collapsed{display:flex;align-items:center;justify-content:center;width:100%;height:100%}
    #pc-collapsed img{max-width:56px;max-height:56px;border-radius:50%}
    #pc-collapsed-text{display:none;margin-top:16px;font-size:14px;color:#fff}
    #profileCard.expanded #pc-collapsed{flex-direction:column;padding-top:40px;justify-content:flex-start}
    #profileCard.expanded #pc-collapsed-text{display:block}
    #pc-options{display:none;flex-direction:column;background:rgba(0,0,0,0.8);padding:12px}
    #profileCard.expanded #pc-options{display:flex}
    #pc-options button{width:100%;margin:8px 0;padding:8px 0;font-size:14px;border:none;border-radius:4px;background:#f00;color:#fff;cursor:pointer}

    /* OVERLAYS */
    .overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:3}
    .hidden{display:none}
    .overlay-content{max-width:320px;width:100%;text-align:center;color:#fff}
    .overlay-content h2{margin:0 0 16px;font-size:32px}
    .overlay-content button{background:#f00;color:#fff;border:none;padding:12px 24px;font-size:18px;margin:8px 0;width:200px;cursor:pointer}
    .overlay-content input,.overlay-content textarea{width:100%;padding:8px;margin:8px 0;font-size:16px;border:none;border-radius:4px}
    .overlay-content textarea{min-height:80px}
    .overlay-content label{display:flex;align-items:center;justify-content:center;margin:8px 0}
    .overlay-content label input{margin-right:8px}
    .scroll-list{background:#111;padding:12px;margin:16px 0;max-height:200px;overflow-y:auto;text-align:left;color:#fff;border-radius:4px}
    .scroll-list div{border-bottom:1px solid #333;padding:6px 0}

    /* ADMIN TABS */
    .admin-tabs{display:flex;margin-bottom:12px}
    .admin-tabs button{flex:1;margin:0 4px;padding:8px;background:#222;color:#fff;border:none;cursor:pointer}
    .admin-tab-content{display:none}
    .admin-tab-content.active{display:block}
    .badge-icon{width:16px;height:16px;vertical-align:middle;margin-left:4px}

    /* NEW: CUSTOMIZE PROFILE OVERLAY */
    #customizeOverlay .overlay-content input,
    #customizeOverlay .overlay-content textarea {
      margin:4px 0; font-size:14px;
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <canvas id="canvas"></canvas>
  <div id="score">0</div>
  <button id="pauseBtn">Pause</button>

  <!-- PROFILE CARD -->
  <div id="profileCard">
    <div id="pc-collapsed">
      <img id="pc-avatar" src="https://app.masonnet.org/default-avatar.png" alt="Avatar"/>
      <span id="pc-collapsed-text">Not signed in</span>
    </div>
    <div id="pc-options">
      <button id="pc-authBtn">Sign In</button>
      <button id="pc-feedbackBtn">Submit Feedback</button>
      <button id="pc-accountBtn">Account Settings</button>
      <button id="pc-adminBtn" style="display:none;">Admin</button>
      <button id="pc-searchBtn">Search Profiles…</button>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <label><input id="loginRemember" type="checkbox"/> Remember me</label>
      <button id="loginSubmit">Submit</button>
      <button id="loginCancel">Cancel</button>
    </div>
  </div>

  <!-- MAIN MENU OVERLAY -->
  <div id="menuOverlay" class="overlay">
    <div class="overlay-content">
      <img src="https://app.masonnet.org/fbrc.png" style="max-width:180px"/>
      <h2>Main Menu</h2>
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
    </div>
  </div>

  <!-- ACCOUNT SETTINGS OVERLAY -->
  <div id="accountOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Account Settings</h2>
      <img id="as-avatar" src="https://app.masonnet.org/default-avatar.png"
           style="width:64px;height:64px;border-radius:50%;"/>
      <div>Username: <span id="as-username"></span></div>
      <h3>Your Score History</h3>
      <div id="as-scoreHistory" class="scroll-list"></div>
      <button id="pc-customizeBtn">Customize Profile</button>
      <button id="as-closeBtn">Close</button>
    </div>
  </div>

  <!-- NEW: CUSTOMIZE PROFILE OVERLAY -->
  <div id="customizeOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Customize Profile</h2>
      <input id="cust-avatarUrl" placeholder="Avatar URL"/>
      <input id="cust-username" placeholder="Username"/>
      <input id="cust-firstName" placeholder="First Name"/>
      <input id="cust-lastName" placeholder="Last Name"/>
      <textarea id="cust-description" placeholder="Description"></textarea>
      <button id="custSaveBtn">Save</button>
      <button id="custCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- PROFILE PAGE OVERLAY -->
  <div id="profileOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Profile</h2>
      <img id="pf-avatar" src="https://app.masonnet.org/default-avatar.png"
           style="width:64px;height:64px;border-radius:50%;"/>
      <div><strong id="pf-username"></strong><span id="pf-exclBadges"></span></div>
      <div id="pf-name"></div>
      <div>Description: <span id="pf-description"></span></div>
      <div>High Score: <span id="pf-highscore"></span></div>
      <div>Rank: <span id="pf-rank"></span></div>
      <div id="pf-badges"></div>
      <div id="pf-ownerExtras" class="hidden">
        <h3>Your History</h3>
        <div id="pf-history" class="scroll-list"></div>
      </div>
      <button id="pf-closeBtn">Close</button>
    </div>
  </div>

  <!-- FEEDBACK, SETTINGS, LEADERBOARD, ADMIN, PAUSE, GAME OVER, NAME PROMPT… -->
  <!-- (unchanged from previous snippet) -->

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain: "masonnet-app-official.firebaseapp.com",
      databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official",
      storageBucket: "masonnet-app-official.firebasestorage.app",
      messagingSenderId: "783919367562",
      appId: "1:783919367562:web:b7bb809332a4e873f3b473",
      measurementId: "G-X1YKV5VK7J"
    };
    firebase.initializeApp(firebaseConfig);

    const auth        = firebase.auth(),
          db          = firebase.database(),
          lbRef       = db.ref("leaderboard"),
          fbRef       = db.ref("feedback"),
          profilesRef = db.ref("profiles"),
          roles       = db.ref("roles");

    // Helper functions
    const $ = id => document.getElementById(id),
          elt = (t,c)=>{let e=document.createElement(t);if(c)e.className=c;return e;};
    function clearLoginFields(){
      $('loginEmail').value='';
      $('loginPass').value='';
    }

    // Element refs (including new)
    const profileCard    = $('profileCard'),
          pcCollapsedTxt = $('pc-collapsed-text'),
          pcAvatar       = $('pc-avatar'),
          pcAuthBtn      = $('pc-authBtn'),
          pcFeedbackBtn  = $('pc-feedbackBtn'),
          pcAccountBtn   = $('pc-accountBtn'),
          pcCustomBtn    = $('pc-customizeBtn'),
          pcAdminBtn     = $('pc-adminBtn'),
          pcSearchBtn    = $('pc-searchBtn'),
          loginOverlay   = $('loginOverlay'),
          menuOverlay    = $('menuOverlay'),
          accountOverlay = $('accountOverlay'),
          customizeOverlay = $('customizeOverlay'),
          profileOverlay = $('profileOverlay'),
          feedbackOverlay= $('feedbackOverlay'),
          settingsOverlay= $('settingsOverlay'),
          leaderboardOverlay = $('leaderboardOverlay'),
          adminOverlay   = $('adminOverlay'),
          pauseOverlay   = $('pauseOverlay'),
          gameoverOverlay= $('gameoverOverlay'),
          nameOverlay    = $('nameOverlay'),
          canvas         = document.querySelector('canvas'),
          startBtn       = $('startBtn'),
          leaderboardBtn = $('leaderboardBtn'),
          settingsBtn    = $('settingsBtn'),
          hubBtn         = $('hubBtn'),
          loginRemember  = $('loginRemember'),
          loginSubmit    = $('loginSubmit'),
          loginCancel    = $('loginCancel'),
          fbTypeEls      = document.getElementsByName('fbType'),
          fbSubject      = $('fbSubject'),
          fbDetails      = $('fbDetails'),
          fbSubmit       = $('fbSubmit'),
          fbCancel       = $('fbCancel'),
          asCloseBtn     = $('as-closeBtn'),
          custAvatarUrl  = $('cust-avatarUrl'),
          custUsername   = $('cust-username'),
          custFirstName  = $('cust-firstName'),
          custLastName   = $('cust-lastName'),
          custDescription= $('cust-description'),
          custSaveBtn    = $('custSaveBtn'),
          custCancelBtn  = $('custCancelBtn'),
          pfAvatar       = $('pf-avatar'),
          pfUsername     = $('pf-username'),
          pfExclBadges   = $('pf-exclBadges'),
          pfName         = $('pf-name'),
          pfDescription  = $('pf-description'),
          pfHighscore    = $('pf-highscore'),
          pfRank         = $('pf-rank'),
          pfBadges       = $('pf-badges'),
          pfHistory      = $('pf-history'),
          pfOwnerExtras  = $('pf-ownerExtras'),
          pfCloseBtn     = $('pf-closeBtn'),
          lbList         = $('leaderboardList'),
          lbCloseBtn     = $('lbCloseBtn'),
          adminTabs      = document.querySelectorAll('.admin-tabs button'),
          adminHome      = $('adminHome'),
          adminFeedback  = $('adminFeedback'),
          adminModeration= $('adminModeration'),
          adminOther     = $('adminOther'),
          adminFeedbackList = $('adminFeedbackList'),
          adminCloseBtn  = $('adminCloseBtn'),
          modSearch      = $('modSearch'),
          modSearchBtn   = $('modSearchBtn'),
          modUserInfo    = $('modUserInfo'),
          scoreDiv       = $('score'),
          finalScoreSpan = $('finalScore'),
          newScoreSpan   = $('newScore'),
          nameInput      = $('nameInput');

    // Badge icons
    const badgeIcons = {
      gold:'https://app.masonnet.org/badge-gold.png',
      survivor:'https://app.masonnet.org/badge-survivor.png',
      top10:'https://app.masonnet.org/badge-top10.png',
      accurate:'https://app.masonnet.org/badge-accurate.png',
      verified:'https://app.masonnet.org/badge-verified.png',
      tournament:'https://app.masonnet.org/badge-tourney.png',
      friend:'https://app.masonnet.org/badge-friend.png',
      admin:'https://app.masonnet.org/badge-admin.png',
      employee:'https://app.masonnet.org/badge-employee.png',
      supporter:'https://app.masonnet.org/badge-supporter.png'
    };

    // Sounds preload
    const pointS=new Audio('https://app.masonnet.org/point.mp3'),
          flapS =new Audio('https://app.masonnet.org/flap.mp3'),
          hitS  =new Audio('https://app.masonnet.org/hit.mp3'),
          dieS  =new Audio('https://app.masonnet.org/die.mp3');

    // Canvas setup
    const ctx=canvas.getContext('2d');
    function resizeCanvas(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize',resizeCanvas); resizeCanvas();
    canvas.addEventListener('mousedown',()=>{ if(state==='playing') bird.flap(); });
    canvas.addEventListener('touchstart',e=>{ e.preventDefault(); if(state==='playing') bird.flap(); });

    // Overlay control
    function showOverlay(el){
      [loginOverlay,menuOverlay,accountOverlay,customizeOverlay,profileOverlay,
       feedbackOverlay,settingsOverlay,leaderboardOverlay,
       adminOverlay,pauseOverlay,gameoverOverlay,nameOverlay
      ].forEach(o=>o.classList.add('hidden'));
      if(el) el.classList.remove('hidden');
      profileCard.style.display = (el===menuOverlay?'block':'none');
      profileCard.classList.remove('expanded');
    }

    // Render user+badges
    function renderUserSpan(name,excl=[]){
      const span=elt('span'); span.textContent=name;
      excl.forEach(id=>{const i=elt('img','badge-icon');i.src=badgeIcons[id];span.appendChild(i);});
      return span;
    }

    // Profile card toggle
    profileCard.onclick = e=>{ e.stopPropagation(); profileCard.classList.toggle('expanded'); };
    document.body.addEventListener('click', ()=> profileCard.classList.remove('expanded'));

    // Auth state & role checks
    auth.onAuthStateChanged(user=>{
      if(user){
        profilesRef.child(user.uid).once('value',snap=>{
          const p=snap.val()||{}; pcAvatar.src=p.avatarUrl||pcAvatar.src;
        });
        pcCollapsedTxt.textContent=''; pcAuthBtn.textContent='Sign Out';
        pcFeedbackBtn.style.display='block'; pcAccountBtn.style.display='block';

        // show customize
        pcCustomBtn.style.display = 'block';
        // show admin if role=admin
        roles.child(userBtn.style.display = 'block';
        // show admin if role=admin
        roles.child(user.uid).once('value',snap=>{
          pcAdminBtn.style.display = snap.val()==='admin'?'block':'none';
        });
      } else {
        pcAvatar.src='https://app.masonnet.org/default-avatar.png';
        pcCollapsedTxt.textContent='Not signed in';
        pcAuthBtn.textContent='Sign In';
        pcFeedbackBtn.style.display='none';
        pcAccountBtn.style.display='none';
        pcCustomBtn.style.display='none';
        pcAdminBtn.style.display='none';
      }
      showOverlay(menuOverlay);
    });

    // PROFILE CARD BUTTONS
    pcAuthBtn.onclick     = ()=> auth.currentUser? auth.signOut() : showOverlay(loginOverlay);
    pcFeedbackBtn.onclick = ()=> showOverlay(feedbackOverlay);
    pcAccountBtn.onclick  = ()=> showOverlay(accountOverlay);
    pcCustomBtn.onclick   = ()=> {
      // load existing
      const u=auth.currentUser; if(!u) return alert("Sign in first");
      profilesRef.child(u.uid).once('value',snap=>{
        const p=snap.val()||{};
        custAvatarUrl.value   = p.avatarUrl||'';
        custUsername.value    = p.username||'';
        custFirstName.value   = p.firstName||'';
        custLastName.value    = p.lastName||'';
        custDescription.value = p.description||'';
        showOverlay(customizeOverlay);
      });
    };
    pcAdminBtn.onclick    = ()=>{
      const pwd=prompt('Enter admin password:',''); if(!pwd)return;
      const user=auth.currentUser;
      const cred=firebase.auth.EmailAuthProvider.credential(user.email,pwd);
      user.reauthenticateWithCredential(cred)
        .then(()=> showOverlay(adminOverlay))
        .catch(()=> alert('Invalid admin password'));
    };
    pcSearchBtn.onclick   = ()=> { const q=prompt("Search username or UID:","").trim(); if(q) performSearch(q); };

    // LOGIN FLOW (clear fields on close or success)
    $('loginCancel').onclick = ()=>{
      clearLoginFields();
      showOverlay(menuOverlay);
    };
    $('loginSubmit').onclick = ()=>{
      const ev=loginEmail.value.trim(), pw=loginPass.value.trim();
      auth.setPersistence(loginRemember.checked
        ?firebase.auth.Auth.Persistence.LOCAL
        :firebase.auth.Auth.Persistence.SESSION)
      .then(()=> auth.signInWithEmailAndPassword(ev,pw))
      .then(()=>{
        clearLoginFields();
        showOverlay(menuOverlay);
      })
      .catch(err=> alert(err.message));
    };

    // ACCOUNT SETTINGS CLOSE
    asCloseBtn.onclick = ()=> showOverlay(menuOverlay);

    // CUSTOMIZE PROFILE SAVE/CANCEL
    custCancelBtn.onclick = ()=> showOverlay(accountOverlay);
    custSaveBtn.onclick = ()=>{
      const u=auth.currentUser; if(!u) return alert("Sign in first");
      const data={
        avatarUrl:   custAvatarUrl.value.trim(),
        username:    custUsername.value.trim(),
        firstName:   custFirstName.value.trim(),
        lastName:    custLastName.value.trim(),
        description: custDescription.value.trim()
      };
      profilesRef.child(u.uid).update(data)
        .then(()=>{
          // refresh profile card avatar & collapsed text
          pcAvatar.src   = data.avatarUrl||pcAvatar.src;
          pcCollapsedTxt.textContent = data.username|| '';
          showOverlay(accountOverlay);
        })
        .catch(err=> alert(err.message));
    };

    // ACCOUNT SETTINGS NAV
    $('as-closeBtn').onclick = ()=> showOverlay(menuOverlay);

    // MAIN MENU NAV
    startBtn.onclick       = ()=> startGame();
    leaderboardBtn.onclick = ()=> loadLeaderboard();
    settingsBtn.onclick    = ()=> showOverlay(settingsOverlay);
    hubBtn.onclick         = ()=> window.location.href='https://app.masonnet.org/flappybirdhub';

    // SEARCH & PROFILE DISPLAY
    function performSearch(q){
      profilesRef.orderByChild('username')
        .startAt(q).endAt(q+"\uf8ff").limitToFirst(1)
        .once('value',snap=>{
          const data=snap.val(), uid = data?Object.keys(data)[0]:null;
          uid? openProfile(uid):alert("No user found");
        });
    }
    function openProfile(uid){
      profilesRef.child(uid).once('value',snap=>{
        const p=snap.val()||{}; 
        pfAvatar.src      = p.avatarUrl||pfAvatar.src;
        pfUsername.innerHTML = ''; pfUsername.appendChild(renderUserSpan(p.username,p.badges?.exclusive));
        pfName.textContent   = `${p.firstName||''} ${p.lastName||''}`;
        $('pf-description').textContent = p.description|| '';
        pfHighscore.textContent = p.highscore||0;
        lbRef.orderByChild('score').once('value',ls=>{
          const arr=Object.values(ls.val()||{}).sort((a,b)=>b.score-a.score),
                idx=arr.findIndex(e=>e.uid===uid);
          pfRank.textContent = idx>=0?idx+1:'—';
        });
        pfBadges.innerHTML='';
        (p.badges?.standard||[]).forEach(id=>{
          const i=elt('img','badge-icon'); i.src=badgeIcons[id]; pfBadges.appendChild(i);
        });
        if(auth.currentUser?.uid===uid){
          pfOwnerExtras.classList.remove('hidden');
          pfHistory.innerHTML='';
          db.ref(`scores/${uid}`).orderByKey().once('value',h=>{
            h.forEach(ch=>{
              const r=ch.val(), d=elt('div');
              d.textContent=`${new Date(+ch.key).toLocaleDateString()} – ${r.score} pts, ${Math.floor(r.durationMs/1000)}s`;
              pfHistory.appendChild(d);
            });
          });
        } else pfOwnerExtras.classList.add('hidden');
        showOverlay(profileOverlay);
      });
    }
    pfCloseBtn.onclick = ()=> showOverlay(menuOverlay);

    // FEEDBACK
    fbSubmit.onclick = ()=>{
      const u=auth.currentUser; if(!u) return alert("Sign in first");
      const t=[...fbTypeEls].find(e=>e.checked).value;
      fbRef.push({uid:u.uid,type:t,subject:fbSubject.value.trim(),
                  message:fbDetails.value.trim(),timestamp:Date.now()});
      alert("Thanks!"); showOverlay(menuOverlay);
    };
    fbCancel.onclick = ()=> showOverlay(menuOverlay);

    // LEADERBOARD
    function loadLeaderboard(){
      lbList.innerHTML='';
      lbRef.orderByChild('score').limitToLast(10).once('value',snap=>{
        Object.values(snap.val()||{}).sort((a,b)=>b.score-a.score).forEach(e=>{
          const row=elt('div'), span=renderUserSpan(e.name,e.badges?.exclusive);
          row.appendChild(span); row.append(`: ${e.score}`); row.onclick=()=>openProfile(e.uid);
          lbList.appendChild(row);
        });
        showOverlay(leaderboardOverlay);
      });
    }
    lbCloseBtn.onclick = ()=> showOverlay(menuOverlay);

    // SETTINGS
    $('settingsCloseBtn').onclick = ()=> showOverlay(menuOverlay);
    let soundOn=true,darkMode=false,skipOn=false;
    $('soundToggle').onclick = ()=>{soundOn=!soundOn;$('soundToggle').textContent=soundOn?'🔊 Sound':'🔇 Mute';};
    $('themeToggle').onclick = ()=>{
      darkMode=!darkMode; $('themeToggle').textContent=darkMode?'☀️ Light':'🌙 Dark';
      $('background').style.backgroundImage=darkMode?"url('https://app.masonnet.org/darkbg.png')":"url('https://app.masonnet.org/lightbg.png')";
    };
    $('skipToggle').onclick = ()=>{skipOn=!skipOn;$('skipToggle').textContent=skipOn?'🚀 Skip: On':'🚀 Skip: Off';};

    // ADMIN CONSOLE NAV
    adminTabs.forEach(btn=>{
      btn.onclick=()=>{
        adminTabs.forEach(b=>b.disabled=false); btn.disabled=true;
        [adminHome,adminFeedback,adminModeration,adminOther].forEach(c=>c.classList.remove('active'));
        if(btn.id==='tabHomeBtn')      adminHome.classList.add('active');
        if(btn.id==='tabFeedbackBtn')  adminFeedback.classList.add('active');
        if(btn.id==='tabModerationBtn')adminModeration.classList.add('active');
        if(btn.id==='tabOtherBtn')     adminOther.classList.add('active');
      };
    });
    adminCloseBtn.onclick = ()=> showOverlay(menuOverlay);
    $('tabFeedbackBtn').onclick();
    $('tabFeedbackBtn').onclick = ()=>{
      adminFeedbackList.innerHTML='';
      fbRef.orderByChild('timestamp').once('value',snap=>{
        Object.entries(snap.val()||{}).forEach(([k,f])=>{
          const d=elt('div');
          d.innerHTML=`<strong>${f.type}</strong>: ${f.subject}<br/>by ${f.uid}<br/>${f.message}`;
          adminFeedbackList.appendChild(d);
        });
      });
      $('tabFeedbackBtn').click();
    };
    modSearchBtn.onclick = ()=>{
      const q=modSearch.value.trim();
      profilesRef.orderByChild('username').startAt(q).endAt(q+"\uf8ff").limitToFirst(1)
        .once('value',snap=>{
          const data=snap.val(),uid=data?Object.keys(data)[0]:null;
          if(!uid)return alert("User not found");
          profilesRef.child(uid).once('value',snap2=>{
            const p=snap2.val();
            modUserInfo.innerHTML=`
              <strong>${p.username}</strong> (${uid})<br/>
              Status: ${p.moderation?.status||'active'}<br/>
              <button id="banBtn">Ban</button>
              <button id="suspendBtn">Suspend</button>
              <button id="reinstateBtn">Reinstate</button>`;
            $('banBtn').onclick     = ()=> setStatus(uid,'banned');
            $('suspendBtn').onclick = ()=> setStatus(uid,'suspended');
            $('reinstateBtn').onclick= ()=> setStatus(uid,'active');
          });
        });
    };
    function setStatus(uid,s){
      profilesRef.child(uid+'/moderation').set({status:s,timestamp:Date.now()});
      alert(`User ${s}`);
    }

    // CORE GAME LOGIC
    let state='menu',bird,pipes,score,frame,rafId,collided=false;
    class Bird {
      constructor(){this.w=36;this.h=30;this.x=50;this.y=canvas.height*0.4;this.vy=0;this.g=0.25;}
      update(){
        if(state!=='playing') return; this.vy+=this.g; this.y+=this.vy;
        if(this.y<0){this.y=0;this.vy=0;} if(this.y+this.h>canvas.height){this.y=canvas.height-this.h;this.die();}
      }
      draw(){ctx.drawImage(birdImg,this.x,this.y,this.w,this.h);}
      flap(){this.vy=-6;if(soundOn){flapS.currentTime=0;try{flapS.play();}catch{}}}
      collides(p){return!(this.x+this.w<p.x||this.x>p.x+p.w||this.y+this.h<p.y||this.y>p.y+p.h);}
      die(){
        if(state!=='playing'||collided) return; collided=true;state='dying';cancelAnimationFrame(rafId);pauseBtn.style.display='none';
        if(soundOn){hitS.currentTime=0;try{hitS.play();}catch{};hitS.onended=()=>{
          dieS.currentTime=0;try{dieS.play();}catch{};dieS.onended=endGame;
        }} else endGame();
      }
    }
    function spawnPipes(){
      const x=canvas.width,h=20+Math.random()*(canvas.height/2-20),gap=120+Math.random()*80;
      if(!pipes.length||x-pipes[pipes.length-1].x>180){
        pipes.push({x,y:0,w:60,h,passed:false});
        pipes.push({x,y:h+gap,w:60,h:canvas.height-h-gap,passed:false});
      }
    }
    function loop(){
      if(state!=='playing') return; rafId=requestAnimationFrame(loop); frame++;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      pipes.forEach(p=>{p.x-=1.8;ctx.drawImage(pipeImg,p.x,p.y,p.w,p.h);
        if(!collided&&bird.collides(p)) bird.die();
        if(!p.passed&&p.y>0&&bird.x>p.x+p.w){p.passed=true;score++;scoreDiv.textContent=score;if(soundOn){try{pointS.play();}catch{}}}
      });
      pipes=pipes.filter(p=>p.x+p.w>0); bird.update();bird.draw();
      if(frame===1||frame%150===0) spawnPipes();
    }
    function startGame(){state='playing';bird=new Bird();pipes=[];score=0;frame=0;collided=false;scoreDiv.textContent='0';
      $('background').style.display='block';pauseBtn.style.display='block';showOverlay(null);loop();
    }
    startBtn.onclick=startGame;
    function endGame(){showOverlay(gameoverOverlay);finalScoreSpan.textContent=score;
      lbRef.orderByChild('score').limitToLast(10).once('value',snap=>{
        const arr=Object.values(snap.val()||{}),minScore=arr.length<10?0:Math.min(...arr.map(e=>e.score));
        if(score>minScore){newScoreSpan.textContent=score;nameInput.value='';showOverlay(nameOverlay);}
      });
    }
    pauseBtn.onclick=()=>{
      if(state!=='playing') return;state='paused';cancelAnimationFrame(rafId);showOverlay(pauseOverlay);
    };
    $('resumeBtn').onclick   =()=>{showOverlay(null);pauseBtn.style.display='block';state='playing';loop();};
    $('pauseMenuBtn').onclick=()=>{cancelAnimationFrame(rafId);pauseBtn.style.display='none';state='menu';showOverlay(menuOverlay);};
    $('restartBtn').onclick  =startGame;
    $('goMenuBtn').onclick   =()=> showOverlay(menuOverlay);
    $('saveNameBtn').onclick =()=>{
      const n=nameInput.value.trim()||'Anonymous';
      lbRef.push({name:n,score,uid:auth.currentUser?.uid||null,timestamp:Date.now()});
      showOverlay(gameoverOverlay);
    };
    $('skipNameBtn').onclick =()=> showOverlay(gameoverOverlay);
    // Preload images
    const birdImg=new Image(),pipeImg=new Image();
    birdImg.src='https://app.masonnet.org/bird.png';pipeImg.src='https://app.masonnet.org/pipe-green.png';
  });
  </script>
</body>
</html>
