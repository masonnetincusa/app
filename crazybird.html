<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird â€“ Fixed Firebase Top-10</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      background:#000; color:#fff;
      overflow:hidden;
    }
    #game-container { position:relative; width:100%; height:100%; }
    canvas { display:block; width:100%; height:100%; }
    .overlay {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.8);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; font-family:Arial,sans-serif;
      z-index:10;
    }
    .hidden { display:none; }
    button {
      background:#e74c3c; border:none; color:#fff;
      padding:12px 24px; margin:8px; font-size:16px;
      cursor:pointer; touch-action:manipulation;
    }
    #score {
      position:absolute; top:10px; left:10px;
      font-size:48px; font-weight:bold; z-index:5;
    }
    #pauseBtn {
      position:absolute; top:10px; right:10px;
      display:none; z-index:5;
    }
    #lb-list, #lb-list-go {
      text-align:left; width:80%;
      max-height:150px; overflow-y:auto;
      margin:12px 0;
    }
    #lb-list div, #lb-list-go div {
      border-bottom:1px solid #444;
      padding:4px 0;
    }
  </style>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="score">0</div>
    <button id="pauseBtn">Pause</button>

    <!-- Main Menu -->
    <div id="menu" class="overlay">
      <h1>Flappy Bird</h1>
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
    </div>

    <!-- Global Leaderboard -->
    <div id="leaderboard" class="overlay hidden">
      <h2>Global Top 10</h2>
      <div id="lb-list"></div>
      <button id="backFromLbBtn">Back</button>
    </div>

    <!-- Pause Menu -->
    <div id="pause" class="overlay hidden">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="backFromPauseBtn">Main Menu</button>
    </div>

    <!-- Game Over -->
    <div id="gameover" class="overlay hidden">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <div id="lb-list-go"></div>
      <button id="restartBtn">Restart</button>
      <button id="backFromGameOverBtn">Main Menu</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ----- CONFIGURE FIREBASE -----
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
  authDomain: "masonnet-app-official.firebaseapp.com",
  databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
  projectId: "masonnet-app-official",
  storageBucket: "masonnet-app-official.firebasestorage.app",
  messagingSenderId: "783919367562",
  appId: "1:783919367562:web:b7bb809332a4e873f3b473",
  measurementId: "G-X1YKV5VK7J"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("leaderboard");
    // -------------------------------

    // UI Elements
    const canvas      = document.getElementById("canvas");
    const ctx         = canvas.getContext("2d");
    const scoreDiv    = document.getElementById("score");
    const pauseBtn    = document.getElementById("pauseBtn");
    const finalScoreE = document.getElementById("finalScore");
    const overlays    = {
      menu:        document.getElementById("menu"),
      leaderboard: document.getElementById("leaderboard"),
      pause:       document.getElementById("pause"),
      gameover:    document.getElementById("gameover")
    };

    let state="menu", bird, pipes, score, frame, animId;

    // Resize canvas
    function resize(){
      canvas.width  = innerWidth;
      canvas.height = innerHeight;
    }
    window.addEventListener("resize", resize);
    resize();

    // Bird Class
    class Bird {
      constructor(){
        this.w=30; this.h=30;
        this.x=50; this.y=(canvas.height-this.h)/2;
        this.vy=0; this.g=0.3;
      }
      update(){
        this.vy += this.g; this.y += this.vy;
        if (this.y<0){
          this.y=0; this.vy=0;
        }
        if (this.y+this.h>=canvas.height){
          this.y=canvas.height-this.h;
          endGame();
        }
      }
      draw(){
        ctx.fillStyle="yellow";
        ctx.fillRect(this.x,this.y,this.w,this.h);
      }
      flap(){ this.vy=-6; }
      collides(p){
        return !(
          this.x+this.w < p.x ||
          this.x > p.x+p.w ||
          this.y+this.h < p.y ||
          this.y > p.y+p.h
        );
      }
    }

    // Spawn pipes
    function spawnPipes(){
      const x   = canvas.width;
      const h   = 20 + Math.random()*(canvas.height/2-20);
      const gap = 120 + Math.random()*80;
      pipes = pipes.filter(p=>p.x+p.w>0);
      if (pipes.length<2 || x - pipes[pipes.length-2].x > 200){
        pipes.push({ x, y:0,    w:40, h,                 passed:false, isTop:true });
        pipes.push({ x, y:h+gap,w:40, h:canvas.height-h-gap, passed:false, isTop:false });
      }
    }

    // Main loop
    function loop(){
      if (state!=="playing") return;
      frame++;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (frame===1 || frame%150===0) spawnPipes();
      pipes.forEach(p=>{
        p.x-=2;
        ctx.fillStyle="green";
        ctx.fillRect(p.x,p.y,p.w,p.h);
      });
      pipes = pipes.filter(p=>p.x+p.w>0);

      bird.update();
      bird.draw();

      pipes.forEach(p=>{
        if (bird.collides(p)){
          endGame(); return;
        }
        if (p.isTop && !p.passed && bird.x > p.x + p.w){
          p.passed=true;
          score++;
          scoreDiv.textContent = score;
        }
      });

      animId = requestAnimationFrame(loop);
    }

    // Show/hide overlays
    function hideAll(){
      Object.values(overlays).forEach(o=>o.classList.add("hidden"));
      pauseBtn.style.display="none";
    }
    function show(id){
      hideAll();
      if (id==="playing"){
        pauseBtn.style.display="block";
      } else if (overlays[id]){
        overlays[id].classList.remove("hidden");
      }
    }

    // Render the global top-10
    function renderGlobalLB(selector){
      const container = document.querySelector(selector);
      container.innerHTML = "";

      db.orderByChild("score")
        .limitToLast(10)
        .once("value", snap => {
          const data = snap.val() || {};
          const entries = Object.values(data);
          // sort descending
          entries.sort((a,b)=>b.score - a.score);
          // display
          entries.forEach((e,i) => {
            const div = document.createElement("div");
            div.textContent = `${i+1}. ${e.name}: ${e.score}`;
            container.appendChild(div);
          });
        });
    }

    // Game actions
    function startGame(){
      state="playing"; bird=new Bird(); pipes=[]; score=0; frame=0;
      scoreDiv.textContent=score;
      show("playing"); cancelAnimationFrame(animId); loop();
    }

    function showLeaderboard(){
      state="leaderboard";
      renderGlobalLB("#lb-list");
      show("leaderboard");
    }

    function pauseGame(){
      if (state!=="playing") return;
      state="paused"; cancelAnimationFrame(animId); show("pause");
    }

    function resumeGame(){
      if (state!=="paused") return;
      state="playing"; show("playing"); cancelAnimationFrame(animId); loop();
    }

    function backToMenu(){
      state="menu"; show("menu");
    }

    function endGame(){
      cancelAnimationFrame(animId);
      state="gameover";
      finalScoreE.textContent = score;

      // determine the 10th-place threshold
      db.orderByChild("score")
        .limitToLast(10)
        .once("value", snap => {
          const data = snap.val() || {};
          const entries = Object.values(data);
          entries.sort((a,b)=>b.score - a.score);
          const threshold = entries.length < 10
            ? 0
            : entries[entries.length-1].score;

          if (score > threshold) {
            const name = prompt("ðŸŽ‰ New High Score! Enter your name:", "Anon")||"Anon";
            db.push({ name, score })
              .then(() => {
                renderGlobalLB("#lb-list-go");
                show("gameover");
              });
          } else {
            renderGlobalLB("#lb-list-go");
            show("gameover");
          }
        });
    }

    function restartGame(){
      startGame();
    }

    // Bind UI buttons
    function bind(id, fn){
      const el = document.getElementById(id);
      el.addEventListener("click", fn);
      el.addEventListener("touchend", e=>{ e.preventDefault(); fn(); });
    }
    bind("startBtn", startGame);
    bind("leaderboardBtn", showLeaderboard);
    bind("backFromLbBtn", backToMenu);
    bind("pauseBtn", pauseGame);
    bind("resumeBtn", resumeGame);
    bind("backFromPauseBtn", backToMenu);
    bind("restartBtn", restartGame);
    bind("backFromGameOverBtn", backToMenu);

    // Controls: Space, K, tap/click
    window.addEventListener("keydown", e => {
      if (e.code==="Space" && state==="playing") { bird.flap(); e.preventDefault(); }
      if (e.key==="k" && state==="playing") { pauseGame(); }
    });
    window.addEventListener("touchstart", e => {
      if (state==="playing") { bird.flap(); e.preventDefault(); }
    });
    canvas.addEventListener("click", e => {
      if (state==="playing") { bird.flap(); e.preventDefault(); }
    });
    canvas.addEventListener("mousedown", e => {
      if (state==="playing") { bird.flap(); e.preventDefault(); }
    });

    // start at main menu
    show("menu");
  });
  </script>
</body>
</html>
