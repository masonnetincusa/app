<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Bird – Reliable Taps</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Retro Font for Score -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet" />

  <style>
    html,body { margin:0; padding:0; width:100%; height:100%; background:#000; color:#fff; overflow:hidden }
    #game-container { position:relative; width:100%; height:100% }
    canvas { display:block; width:100%; height:100% }
    #score {
      position:absolute; top:10px; left:10px;
      font-family:'Press Start 2P',system-ui; font-size:48px;
      text-shadow:2px 2px 4px rgba(0,0,0,0.7); z-index:5
    }
    #pauseBtn {
      position:absolute; top:10px; right:10px; display:none;
      background:#f00; border:none; color:#fff;
      padding:8px 16px; cursor:pointer; z-index:6;
    }
    .overlay {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; z-index:10;
      font-family:Arial,sans-serif;
    }
    .hidden { display:none }
    .overlay button {
      background:#f00; border:none; color:#fff;
      padding:12px 24px; margin:8px; font-size:16px;
      cursor:pointer;
    }
    .scroll-list {
      width:80%; max-height:200px;
      overflow-y:auto; text-align:left;
      margin:12px 0; color:#fff
    }
    .scroll-list div {
      border-bottom:1px solid #444; padding:6px 0
    }
    #loginOverlay input {
      display:block; width:200px; padding:6px; margin:8px 0; font-size:14px
    }
    #loginOverlay label {
      display:flex; align-items:center; color:#fff; margin:8px 0
    }
    #loginOverlay label input { margin-right:6px }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="score">0</div>
    <button id="pauseBtn">Pause</button>

    <!-- LOGIN -->
    <div id="loginOverlay" class="overlay hidden">
      <h2>Sign In</h2>
      <input id="loginEmail" placeholder="Email">
      <input id="loginPass" type="password" placeholder="Password">
      <label><input id="loginRemember" type="checkbox">Remember me</label>
      <button id="loginSubmit">Sign In</button>
      <button id="loginCancel">Cancel</button>
    </div>

    <!-- MAIN MENU -->
    <div id="menuOverlay" class="overlay">
      <img src="https://app.masonnet.org/fbrc.png"
           style="width:240px;margin-bottom:24px" alt="Logo">
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="adminBtn" class="hidden">Admin Console</button>
      <button id="signOutBtn" class="hidden">Sign Out</button>
    </div>

    <!-- LEADERBOARD -->
    <div id="leaderboardOverlay" class="overlay hidden">
      <h2>Global Top 10</h2>
      <div id="leaderboardList" class="scroll-list"></div>
      <button id="backFromLbBtn">Back</button>
    </div>

    <!-- SETTINGS -->
    <div id="settingsOverlay" class="overlay hidden">
      <h2>Settings</h2>
      <div>
        <button id="soundToggle">🔊 Sound</button>
        <p>Toggle SFX on/off.</p>
      </div>
      <div>
        <button id="themeToggle">🌙 Dark Mode</button>
        <p>Switch background theme.</p>
      </div>
      <div>
        <button id="skipToggle">🚀 Skip to GO: Off</button>
        <p>Immediate Game Over. No SFX if enabled.</p>
      </div>
      <div>
        <button id="authBtn">Sign In</button>
        <p id="authDesc">Sign in to access admin console.</p>
      </div>
      <button id="closeSettingsBtn">Close</button>
    </div>

    <!-- ADMIN -->
    <div id="adminOverlay" class="overlay hidden">
      <h2>Feedback Submissions</h2>
      <div id="adminList" class="scroll-list"></div>
      <button id="closeAdminBtn">Back</button>
    </div>

    <!-- PAUSE -->
    <div id="pauseOverlay" class="overlay hidden">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="backFromPauseBtn">Main Menu</button>
    </div>

    <!-- GAME OVER -->
    <div id="gameoverOverlay" class="overlay hidden">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button id="restartBtn">Restart</button>
      <button id="backFromGOBtn">Main Menu</button>
    </div>

    <!-- EFFECT -->
    <div id="effectOverlay" class="overlay hidden">
      <h2>Playing sound effects…</h2>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const OBSTACLE_WIDTH   = 60;
    const PIPE_GAP_MIN     = 120;
    const PIPE_GAP_MAX     = 200;
    const FLAP_COOLDOWN_MS = 200;
    const PARALLAX_SPEEDS  = [0.3,0.8,2];

    firebase.initializeApp({
      apiKey:    "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain:"masonnet-app-official.firebaseapp.com",
      databaseURL:"https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official"
    });
    const auth  = firebase.auth(),
          db    = firebase.database(),
          lbRef = db.ref("leaderboard"),
          fbRef = db.ref("feedback"),
          roles = db.ref("roles");

    // Overlays helper
    const overlays = {
      login: $('loginOverlay'),
      menu:  $('menuOverlay'),
      leaderboard: $('leaderboardOverlay'),
      settings: $('settingsOverlay'),
      admin: $('adminOverlay'),
      pause: $('pauseOverlay'),
      gameover: $('gameoverOverlay'),
      effect: $('effectOverlay')
    };
    function showOverlay(name) {
      Object.values(overlays).forEach(o=>o.classList.add('hidden'));
      if (name) overlays[name].classList.remove('hidden');
    }

    // UI refs
    const canvas        = $('canvas'),
          ctx           = canvas.getContext('2d'),
          scoreDiv      = $('score'),
          pauseBtn      = $('pauseBtn'),
          loginEmail    = $('loginEmail'),
          loginPass     = $('loginPass'),
          loginRem      = $('loginRemember'),
          loginSubmit   = $('loginSubmit'),
          loginCancel   = $('loginCancel'),
          authBtn       = $('authBtn'),
          signOutBtn    = $('signOutBtn'),
          adminBtn      = $('adminBtn'),
          authDesc      = $('authDesc'),
          startBtn      = $('startBtn'),
          leaderboardBtn= $('leaderboardBtn'),
          settingsBtn   = $('settingsBtn'),
          closeSettingsBtn = $('closeSettingsBtn'),
          closeAdminBtn = $('closeAdminBtn'),
          backFromLbBtn = $('backFromLbBtn'),
          resumeBtn     = $('resumeBtn'),
          backFromPauseBtn = $('backFromPauseBtn'),
          restartBtn    = $('restartBtn'),
          backFromGOBtn = $('backFromGOBtn'),
          leaderboardList = $('leaderboardList'),
          adminList     = $('adminList'),
          finalScore    = $('finalScore');

    // Assets
    const lightBg = new Image(), darkBg = new Image(),
          birdImg = new Image(), pipeImg = new Image();
    lightBg.src = 'https://app.masonnet.org/lightbg.png';
    darkBg.src  = 'https://app.masonnet.org/darkbg.png';
    birdImg.src = 'https://app.masonnet.org/bird.png';
    pipeImg.src = 'https://app.masonnet.org/pipe-green.png';

    const pointS = new Audio('https://app.masonnet.org/point.mp3'),
          flapS  = new Audio('https://app.masonnet.org/flap.mp3'),
          hitS   = new Audio('https://app.masonnet.org/hit.mp3'),
          dieS   = new Audio('https://app.masonnet.org/die.mp3');

    function $(id){ return document.getElementById(id); }

    // Responsive canvas
    function resize() {
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // State
    let state = 'menu', bird, pipes, score, frame, rafId;
    let soundOn = true, darkMode=false, skipOn=false;
    let bg=lightBg, collided=false, lastFlap=0, parOff=[0,0,0], isAdmin=false;

    // Toggles
    function updateSound(){ $('soundToggle').textContent = soundOn?'🔊 Sound':'🔇 Mute'; }
    function updateTheme(){ $('themeToggle').textContent = darkMode?'☀️ Light':'🌙 Dark'; }
    function updateSkip(){ $('skipToggle').textContent = skipOn?'🚀 Skip: On':'🚀 Skip: Off'; }

    // Auth listener
    auth.onAuthStateChanged(u=>{
      if(!u){
        isAdmin=false;adminBtn.classList.add('hidden');signOutBtn.classList.add('hidden');
        authBtn.textContent='Sign In';authDesc.textContent='Sign in for admin';
        showOverlay('menu');return;
      }
      roles.child(u.uid).once('value',snap=>{
        isAdmin=snap.val()==='admin';
        adminBtn.classList.toggle('hidden',!isAdmin);
      });
      authBtn.textContent='Sign Out';
      authDesc.textContent='Signed in as '+u.email;
      signOutBtn.classList.remove('hidden');
      showOverlay('menu');
    });

    // Login handlers
    loginSubmit.onclick = ()=>{
      const pers = loginRem.checked
        ? firebase.auth.Auth.Persistence.LOCAL
        : firebase.auth.Auth.Persistence.SESSION;
      auth.setPersistence(pers)
        .then(()=>auth.signInWithEmailAndPassword(loginEmail.value,loginPass.value))
        .catch(e=>alert(e.message));
    };
    loginCancel.onclick = ()=>showOverlay('settings');
    authBtn.onclick     = ()=>auth.currentUser? auth.signOut(): showOverlay('login');
    signOutBtn.onclick  = ()=>auth.signOut();

    // Bird
    class Bird {
      constructor(){
        this.w=36;this.h=30;this.x=50;
        this.y=(canvas.height-this.h)/2;
        this.vy=0;this.g=0.25;
      }
      update(){
        this.vy+=this.g;this.y+=this.vy;
        if(this.y<0){this.y=0;this.vy=0;}
        if(this.y+this.h>=canvas.height){
          this.y=canvas.height-this.h;this.die();
        }
      }
      draw(){ctx.drawImage(birdImg,this.x,this.y,this.w,this.h);}
      flap(){
        const now=Date.now();
        if(soundOn&&now-lastFlap>=FLAP_COOLDOWN_MS){
          flapS.currentTime=0;flapS.play();lastFlap=now;
        }
        this.vy=-6;
      }
      collides(p){return!(this.x+this.w<p.x||this.x>p.x+p.w||this.y+this.h<p.y||this.y>p.y+p.h);}
      die(){
        if(collided)return;
        state='dying';collided=true;
        cancelAnimationFrame(rafId);
        pauseBtn.style.display='none';
        showOverlay('effect');
        if(skipOn||!soundOn){return endGame();}
        hitS.currentTime=0;hitS.play();
        hitS.onended=()=>{
          dieS.currentTime=0;dieS.play();
          dieS.onended=endGame;
        };
      }
    }

    function spawnPipes(){
      const x=canvas.width,
            h=20+Math.random()*(canvas.height/2-20),
            gap=PIPE_GAP_MIN+Math.random()*(PIPE_GAP_MAX-PIPE_GAP_MIN);
      pipes=pipes.filter(p=>p.x+p.w>0);
      if(!pipes.length||x-pipes[pipes.length-1].x>OBSTACLE_WIDTH*3){
        pipes.push({x,y:0,w:OBSTACLE_WIDTH,h,passed:false,top:true});
        pipes.push({x,y:h+gap,w:OBSTACLE_WIDTH,h:canvas.height-h-gap,passed:false,top:false});
      }
    }

    function endGame(){
      showOverlay('gameover');
      finalScore.textContent=score;
    }

    function loop(){
      if(state!=='playing')return;
      rafId=requestAnimationFrame(loop);
      frame++;
      PARALLAX_SPEEDS.forEach((spd,i)=>{
        parOff[i]=(parOff[i]+spd)%canvas.width;
        ctx.drawImage(bg,-parOff[i],0,canvas.width,canvas.height);
        ctx.drawImage(bg,canvas.width-parOff[i],0,canvas.width,canvas.height);
      });
      if(frame===1||frame%150===0)spawnPipes();
      pipes.forEach(p=>{
        p.x-=1.8;ctx.drawImage(pipeImg,p.x,p.y,p.w,p.h);
        if(!collided&&bird.collides(p))bird.die();
        if(p.top&&!p.passed&&bird.x>p.x+p.w){
          p.passed=true;score++;scoreDiv.textContent=score;
          if(soundOn){pointS.currentTime=0;pointS.play();}
        }
      });
      pipes=pipes.filter(p=>p.x+p.w>0);
      bird.update();bird.draw();
    }

    function startGame(){
      state='playing';bird=new Bird();pipes=[];score=0;frame=0;
      collided=false;parOff=[0,0,0];bg=darkMode?darkBg:lightBg;
      scoreDiv.textContent=score;showOverlay(null);pauseBtn.style.display='block';
      loop();
    }

    function pauseGame(){
      if(state!=='playing')return;
      state='paused';cancelAnimationFrame(rafId);
      showOverlay('pause');
    }

    function renderLeaderboard(){
      leaderboardList.innerHTML='';
      lbRef.orderByChild('score').limitToLast(10)
        .once('value',snap=>{
          Object.values(snap.val()||{}).sort((a,b)=>b.score-a.score)
            .forEach((e,i)=>{
              const d=document.createElement('div');
              d.textContent=`${i+1}. ${e.name}: ${e.score}`;
              leaderboardList.appendChild(d);
            });
          showOverlay('leaderboard');
        });
    }

    function renderAdmin(){
      adminList.innerHTML='';
      fbRef.orderByChild('timestamp')
        .once('value',snap=>{
          Object.entries(snap.val()||{}).reverse()
            .forEach(([,v])=>{
              const d=document.createElement('div');
              d.innerHTML=`<strong>${v.type}</strong> – ${v.subject}<br>
                           ${v.message}<br>
                           <em>${new Date(v.timestamp).toLocaleString()}</em>`;
              adminList.appendChild(d);
            });
          showOverlay('admin');
        });
    }

    // Bind
    startBtn.onclick         = startGame;
    leaderboardBtn.onclick   = renderLeaderboard;
    settingsBtn.onclick      = () => showOverlay('settings');
    closeSettingsBtn.onclick = () => showOverlay('menu');
    adminBtn.onclick         = renderAdmin;
    closeAdminBtn.onclick    = () => showOverlay('menu');
    backFromLbBtn.onclick    = () => showOverlay('menu');
    resumeBtn.onclick        = () => { state='playing'; loop(); };
    backFromPauseBtn.onclick = () => showOverlay('menu');
    restartBtn.onclick       = startGame;
    backFromGOBtn.onclick    = () => showOverlay('menu');
    pauseBtn.onclick         = pauseGame;

    $('soundToggle').onclick = () => { soundOn=!soundOn; updateSound(); };
    $('themeToggle').onclick = () => { darkMode=!darkMode; updateTheme(); };
    $('skipToggle').onclick  = () => { skipOn=!skipOn; updateSkip(); };

    // Register ANY canvas tap
    ['pointerdown','mousedown','touchstart','click'].forEach(ev=>{
      canvas.addEventListener(ev, e=>{
        if(state==='playing') { bird.flap(); e.preventDefault(); }
      });
    });
    // Spacebar
    window.addEventListener('keydown', e=>{
      if(e.code==='Space'&&state==='playing'){ bird.flap(); e.preventDefault(); }
      if(e.key==='k'     &&state==='playing') pauseGame();
    });

    // Init labels & show menu
    updateSound(); updateTheme(); updateSkip();
    showOverlay('menu');
  });
  </script>
</body>
</html>
