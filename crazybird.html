<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird – Freeze & Sound-Effect Overlay</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Google Font for Score Counter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000; color: #fff;
    }
    #game-container {
      position: relative;
      width: 100%; height: 100%;
    }
    canvas {
      display: block;
      width: 100%; height: 100%;
    }
    /* Score Counter */
    #score {
      position: absolute;
      top: 10px; left: 10px;
      font-family: 'Press Start 2P', system-ui;
      font-size: 48px; color: #fff;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
      z-index: 5;
    }
    /* Pause Button */
    #pauseBtn {
      position: absolute;
      top: 10px; right: 10px;
      display: none;
      background: #FF0000; color: #fff;
      border: none; padding: 8px 16px;
      font-size: 16px; cursor: pointer; user-select: none;
      z-index: 6;
    }
    /* Overlays */
    .overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      text-align: center; font-family: Arial, sans-serif;
      z-index: 10;
    }
    .hidden { display: none; }
    .overlay button {
      background: #FF0000; border: none;
      color: #fff; padding: 12px 24px;
      margin: 8px; font-size: 16px; cursor: pointer;
      user-select: none;
    }
    #settings button { width: 180px; }
    #lb-list, #lb-list-go {
      text-align: left; width: 80%;
      max-height: 150px; overflow-y: auto;
      margin: 12px 0;
    }
    #lb-list div, #lb-list-go div {
      border-bottom: 1px solid #444; padding: 4px 0;
    }
  </style>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="score">0</div>
    <button id="pauseBtn">Pause</button>

    <!-- Menus & Overlays -->
    <div id="menu" class="overlay">
      <img src="https://app.masonnet.org/fbrc.png" alt="Logo"
           style="width:240px;margin-bottom:24px;user-select:none;">
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
      <button id="linkBtn">Flappy Bird Hub</button>
      <button id="settingsBtn">Settings</button>
    </div>

    <div id="leaderboard" class="overlay hidden">
      <h2>Global Top 10</h2>
      <div id="lb-list"></div>
      <button id="backFromLbBtn">Back</button>
    </div>

    <div id="settings" class="overlay hidden">
      <h2>Settings</h2>
      <button id="soundToggle">🔊 Sound</button>
      <button id="themeToggle">🌙 Dark Mode</button>
      <button id="closeSettingsBtn">Close</button>
    </div>

    <div id="pause" class="overlay hidden">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="backFromPauseBtn">Main Menu</button>
      <button id="settingsBtnPause">Settings</button>
    </div>

    <div id="gameover" class="overlay hidden">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <div id="lb-list-go"></div>
      <button id="restartBtn">Restart</button>
      <button id="backFromGameOverBtn">Main Menu</button>
    </div>

    <!-- New: Sound-Effects Overlay -->
    <div id="effectOverlay" class="overlay hidden">
      <h2>Playing sound effects...</h2>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain: "masonnet-app-official.firebaseapp.com",
      databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official",
      storageBucket: "masonnet-app-official.firebasestorage.app",
      messagingSenderId: "783919367562",
      appId: "1:783919367562:web:b7bb809332a4e873f3b473",
      measurementId: "G-X1YKV5VK7J"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("leaderboard");

    // Asset URLs
    const LIGHT_BG_URL = "https://app.masonnet.org/lightbg.png";
    const DARK_BG_URL  = "https://app.masonnet.org/darkbg.png";
    const BIRD_URL     = "https://app.masonnet.org/bird.png";
    const PIPE_URL     = "https://app.masonnet.org/pipe-green.png";
    const POINT_SOUND  = "https://app.masonnet.org/point.mp3";
    const FLAP_SOUND   = "https://app.masonnet.org/flap.mp3";
    const HIT_SOUND    = "https://app.masonnet.org/hit.mp3";
    const DIE_SOUND    = "https://app.masonnet.org/die.mp3";
    const HUB_LINK     = "https://app.masonnet.org/flappybirdhub";

    // Preload
    const lightBgImg = new Image(); lightBgImg.src = LIGHT_BG_URL;
    const darkBgImg  = new Image(); darkBgImg.src  = DARK_BG_URL;
    const birdImg    = new Image(); birdImg.src    = BIRD_URL;
    const pipeImg    = new Image(); pipeImg.src    = PIPE_URL;
    const scoreSound = new Audio(POINT_SOUND);
    const flapSound  = new Audio(FLAP_SOUND);
    const hitSound   = new Audio(HIT_SOUND);
    const dieSound   = new Audio(DIE_SOUND);

    Promise.all([
      new Promise(r=>lightBgImg.onload=r),
      new Promise(r=>darkBgImg.onload=r),
      new Promise(r=>birdImg.onload=r),
      new Promise(r=>pipeImg.onload=r)
    ]).then(init);

    function init() {
      // UI refs
      const canvas          = document.getElementById("canvas");
      const ctx             = canvas.getContext("2d");
      const scoreDiv        = document.getElementById("score");
      const pauseBtn        = document.getElementById("pauseBtn");
      const effectOverlay   = document.getElementById("effectOverlay");
      const overlays        = {
        menu:        document.getElementById("menu"),
        leaderboard: document.getElementById("leaderboard"),
        settings:    document.getElementById("settings"),
        pause:       document.getElementById("pause"),
        gameover:    document.getElementById("gameover")
      };
      const finalScoreEl    = document.getElementById("finalScore");
      const startBtn        = document.getElementById("startBtn");
      const leaderboardBtn  = document.getElementById("leaderboardBtn");
      const linkBtn         = document.getElementById("linkBtn");
      const settingsBtn     = document.getElementById("settingsBtn");
      const settingsBtnPause= document.getElementById("settingsBtnPause");
      const closeSettingsBtn= document.getElementById("closeSettingsBtn");
      const soundToggle     = document.getElementById("soundToggle");
      const themeToggle     = document.getElementById("themeToggle");
      const backFromLbBtn   = document.getElementById("backFromLbBtn");
      const resumeBtn       = document.getElementById("resumeBtn");
      const backFromPauseBtn= document.getElementById("backFromPauseBtn");
      const restartBtn      = document.getElementById("restartBtn");
      const backFromGameOverBtn = document.getElementById("backFromGameOverBtn");

      // State & game vars
      let state        = "menu";
      let bird, pipes, score, frame, animId;
      let soundEnabled = true;
      let darkMode     = false;
      let bgImg        = lightBgImg;
      let collided     = false;

      // Parallax & flap cooldown
      let offsets = [0,0,0], speeds=[0.3,0.8,2];
      const FLAP_COOLDOWN = 200;
      let lastFlapTime    = 0;

      // Resize
      function resize() {
        canvas.width  = innerWidth;
        canvas.height = innerHeight;
      }
      window.addEventListener("resize", resize);
      resize();

      // Bird class
      class Bird {
        constructor() {
          this.w=36; this.h=30;
          this.x=50; this.y=(canvas.height-this.h)/2;
          this.vy=0; this.g=0.3;
        }
        update() {
          this.vy+=this.g; this.y+=this.vy;
          if (this.y<0) { this.y=0; this.vy=0; }
          if (this.y+this.h>=canvas.height) {
            this.y=canvas.height-this.h;
            scheduleGameOver();
          }
        }
        draw() {
          ctx.drawImage(birdImg,this.x,this.y,this.w,this.h);
        }
        flap() {
          const now = Date.now();
          if (soundEnabled && now - lastFlapTime >= FLAP_COOLDOWN) {
            flapSound.currentTime=0;
            flapSound.play();
            lastFlapTime = now;
          }
          this.vy = -6;
        }
      }

      // Spawn pipes
      function spawnPipes() {
        const x=canvas.width;
        const h=20+Math.random()*(canvas.height/2-20);
        const gap=120+Math.random()*80;
        pipes=pipes.filter(p=>p.x+p.w>0);
        if (!pipes.length||x-pipes[pipes.length-1].x>200) {
          pipes.push({x,y:0,w:40,h,passed:false,isTop:true});
          pipes.push({x,y:h+gap,w:40,h:canvas.height-h-gap,passed:false,isTop:false});
        }
      }

      // Freeze & show effect overlay, chain sounds
      function scheduleGameOver() {
        if (collided) return;
        collided = true;
        state    = "dying";
        cancelAnimationFrame(animId);
        pauseBtn.style.display = "none";
        // hide all menus & show effectOverlay
        Object.values(overlays).forEach(o=>o.classList.add("hidden"));
        effectOverlay.classList.remove("hidden");

        if (!soundEnabled) {
          performGameOver();
          return;
        }

        // play hit -> die -> then finalize
        hitSound.currentTime = 0;
        hitSound.play();
        hitSound.addEventListener("ended", () => {
          dieSound.currentTime = 0;
          dieSound.play();
          dieSound.addEventListener("ended", performGameOver, { once: true });
        }, { once: true });
      }

      // finalize: hide effectOverlay, show Game Over + leaderboard
      function performGameOver() {
        effectOverlay.classList.add("hidden");
        state = "gameover";
        finalScoreEl.textContent = score;

        db.orderByChild("score").limitToLast(10)
          .once("value", snap => {
            const data = snap.val()||{};
            const list = Object.values(data)
              .sort((a,b)=>b.score-a.score);
            const threshold = list.length<10?0:list[list.length-1].score;

            const pushScore = () => {
              const name = prompt("🎉 New High Score! Enter name:","Anon")||"Anon";
              return db.push({name,score});
            };

            Promise.resolve(score>threshold ? pushScore() : null)
              .then(() => renderGameOverList());
          });
      }

      function renderGameOverList() {
        const container = document.getElementById("lb-list-go");
        container.innerHTML = "";
        db.orderByChild("score").limitToLast(10)
          .once("value", snap => {
            Object.values(snap.val()||{})
              .sort((a,b)=>b.score-a.score)
              .forEach((e,i)=>{
                const d = document.createElement("div");
                d.textContent = `${i+1}. ${e.name}: ${e.score}`;
                container.appendChild(d);
              });
            show("gameover");
          });
      }

      // Main loop
      function loop() {
        if (state !== "playing") return;
        frame++;

        // parallax background
        for (let i=0; i<3; i++){
          offsets[i] = (offsets[i] + speeds[i]) % canvas.width;
          ctx.drawImage(bgImg, -offsets[i], 0, canvas.width, canvas.height);
          ctx.drawImage(bgImg, canvas.width - offsets[i], 0, canvas.width, canvas.height);
        }

        // pipes, collision, scoring
        if (frame===1||frame%150===0) spawnPipes();
        pipes.forEach(p=>{
          p.x -= 2;
          ctx.drawImage(pipeImg,p.x,p.y,p.w,p.h);
          if (!collided && bird.collides && (
               bird.x < p.x + p.w &&
               bird.x + bird.w > p.x &&
               bird.y < p.y + p.h &&
               bird.y + bird.h > p.y
             )) {
            scheduleGameOver();
          }
          if (p.isTop && !p.passed && bird.x>p.x+p.w) {
            p.passed = true;
            score++;
            scoreDiv.textContent = score;
            if (soundEnabled) {
              scoreSound.currentTime = 0; scoreSound.play();
            }
          }
        });
        pipes = pipes.filter(p=>p.x+p.w>0);

        bird.update();
        bird.draw();

        animId = requestAnimationFrame(loop);
      }

      // Overlay helpers
      function hideAll() {
        Object.values(overlays).forEach(o=>o.classList.add("hidden"));
        pauseBtn.style.display = "none";
      }
      function show(id) {
        hideAll();
        if (id==="playing") pauseBtn.style.display="block";
        else overlays[id].classList.remove("hidden");
      }

      // Leaderboard menu
      function renderGlobalLB() {
        const c = document.getElementById("lb-list");
        c.innerHTML = "";
        db.orderByChild("score").limitToLast(10)
          .once("value", snap => {
            Object.values(snap.val()||{})
              .sort((a,b)=>b.score-a.score)
              .forEach((e,i)=>{
                const d = document.createElement("div");
                d.textContent = `${i+1}. ${e.name}: ${e.score}`;
                c.appendChild(d);
              });
            show("leaderboard");
          });
      }

      // UI toggles
      function updateSoundToggle() {
        soundToggle.textContent = soundEnabled ? "🔊 Sound" : "🔇 Mute";
      }
      function updateThemeToggle() {
        themeToggle.textContent = darkMode ? "☀️ Light Mode" : "🌙 Dark Mode";
      }

      // Actions
      function startGame() {
        state    = "playing";
        bird     = new Bird();
        pipes    = [];
        score    = 0;
        frame    = 0;
        collided = false;
        offsets  = [0,0,0];
        bgImg    = darkMode ? darkBgImg : lightBgImg;
        scoreDiv.textContent = score;
        show("playing");
        cancelAnimationFrame(animId);
        loop();
      }
      function showLeaderboardMenu() { renderGlobalLB(); }
      function pauseGame() {
        if (state!=="playing") return;
        state="paused";
        cancelAnimationFrame(animId);
        show("pause");
      }
      function resumeGame() {
        if (state!=="paused") return;
        state="playing";
        show("playing");
        loop();
      }
      function backToMenu() { state="menu"; show("menu"); }
      function openSettings() { hideAll(); show("settings"); }
      function closeSettings() {
        hideAll();
        state==="pause"? show("pause") : show("menu");
      }
      function restartGame() { startGame(); }

      // Bindings
      function bind(id, fn) {
        const el = document.getElementById(id);
        el.addEventListener("click", fn);
        el.addEventListener("touchend", e=>{ e.preventDefault(); fn(); });
      }
      bind("startBtn",    startGame);
      bind("leaderboardBtn", showLeaderboardMenu);
      bind("linkBtn",     ()=>location.href=HUB_LINK);
      bind("settingsBtn", openSettings);
      bind("settingsBtnPause", openSettings);
      bind("closeSettingsBtn", closeSettings);
      bind("pauseBtn",    pauseGame);
      bind("resumeBtn",   resumeGame);
      bind("backFromPauseBtn", backToMenu);
      bind("backFromLbBtn", backToMenu);
      bind("restartBtn",  restartGame);
      bind("backFromGameOverBtn", backToMenu);

      // Settings
      soundToggle.addEventListener("click", () => {
        soundEnabled = !soundEnabled; updateSoundToggle();
      });
      themeToggle.addEventListener("click", () => {
        darkMode = !darkMode; updateThemeToggle();
      });

      // Controls
      window.addEventListener("keydown", e => {
        if (e.code==="Space" && state==="playing") { bird.flap(); e.preventDefault(); }
        if (e.key==="k" && state==="playing") pauseGame();
      });
      ['click','mousedown','touchstart'].forEach(evt => {
        canvas.addEventListener(evt, e => {
          if (state==="playing") { bird.flap(); e.preventDefault(); }
        });
      });

      // Init UI
      updateSoundToggle();
      updateThemeToggle();
      show("menu");
    }
  });
  </script>
</body>
</html>
