<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird – Fixed Collision on Mute</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; color:#fff; }
    #game-container { position:relative; width:100%; height:100%; }
    canvas { display:block; width:100%; height:100%; }
    #score {
      position:absolute; top:10px; left:10px;
      font-family:'Press Start 2P',system-ui; font-size:48px;
      color:#fff; text-shadow:2px 2px 4px rgba(0,0,0,0.7); z-index:5;
    }
    #pauseBtn {
      position:absolute; top:10px; right:10px; display:none;
      background:#FF0000; color:#fff; border:none; padding:8px 16px;
      font-size:16px; cursor:pointer; user-select:none; z-index:6;
    }
    .overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.8); display:flex;
      flex-direction:column; align-items:center;
      justify-content:center; text-align:center;
      font-family:Arial,sans-serif; z-index:10;
    }
    .hidden { display:none; }
    .overlay button {
      background:#FF0000; border:none; color:#fff;
      padding:12px 24px; margin:8px; font-size:16px;
      cursor:pointer; user-select:none;
    }
    #settings button { width:180px; }
    #lb-list, #lb-list-go {
      text-align:left; width:80%; max-height:150px;
      overflow-y:auto; margin:12px 0;
    }
    #lb-list div, #lb-list-go div { border-bottom:1px solid #444; padding:4px 0; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="score">0</div>
    <button id="pauseBtn">Pause</button>

    <!-- Main Menu -->
    <div id="menu" class="overlay">
      <img src="https://app.masonnet.org/fbrc.png" alt="Logo"
           style="width:240px; margin-bottom:24px; user-select:none;">
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
      <button id="linkBtn">Flappy Bird Hub</button>
      <button id="settingsBtn">Settings</button>
    </div>

    <!-- Leaderboard -->
    <div id="leaderboard" class="overlay hidden">
      <h2>Global Top 10</h2>
      <div id="lb-list"></div>
      <button id="backFromLbBtn">Back</button>
    </div>

    <!-- Settings -->
    <div id="settings" class="overlay hidden">
      <h2>Settings</h2>
      <button id="soundToggle">🔊 Sound</button>
      <button id="themeToggle">🌙 Dark Mode</button>
      <button id="closeSettingsBtn">Close</button>
    </div>

    <!-- Pause Menu -->
    <div id="pause" class="overlay hidden">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="backFromPauseBtn">Main Menu</button>
      <button id="settingsBtnPause">Settings</button>
    </div>

    <!-- Game Over -->
    <div id="gameover" class="overlay hidden">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <div id="lb-list-go"></div>
      <button id="restartBtn">Restart</button>
      <button id="backFromGameOverBtn">Main Menu</button>
    </div>

    <!-- Sound-Effect Overlay -->
    <div id="effectOverlay" class="overlay hidden">
      <h2>Playing sound effects...</h2>
    </div>

  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain: "masonnet-app-official.firebaseapp.com",
      databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official",
      storageBucket: "appspot.com",
      messagingSenderId: "783919367562",
      appId: "1:783919367562:web:b7bb809332a4e873f3b473",
      measurementId: "G-X1YKV5VK7J"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("leaderboard");

    // Assets & sounds
    const LIGHT_BG = "https://app.masonnet.org/lightbg.png";
    const DARK_BG  = "https://app.masonnet.org/darkbg.png";
    const BIRD_IMG = "https://app.masonnet.org/bird.png";
    const PIPE_IMG = "https://app.masonnet.org/pipe-green.png";
    const SFX_POINT = "https://app.masonnet.org/point.mp3";
    const SFX_FLAP  = "https://app.masonnet.org/flap.mp3";
    const SFX_HIT   = "https://app.masonnet.org/hit.mp3";
    const SFX_DIE   = "https://app.masonnet.org/die.mp3";
    const HUB_LINK  = "https://app.masonnet.org/flappybirdhub";

    const lightBgImg = new Image(); lightBgImg.src = LIGHT_BG;
    const darkBgImg  = new Image(); darkBgImg.src  = DARK_BG;
    const birdImg    = new Image(); birdImg.src    = BIRD_IMG;
    const pipeImg    = new Image(); pipeImg.src    = PIPE_IMG;
    const pointSound = new Audio(SFX_POINT);
    const flapSound  = new Audio(SFX_FLAP);
    const hitSound   = new Audio(SFX_HIT);
    const dieSound   = new Audio(SFX_DIE);

    Promise.all([
      new Promise(r=>lightBgImg.onload=r),
      new Promise(r=>darkBgImg.onload=r),
      new Promise(r=>birdImg.onload=r),
      new Promise(r=>pipeImg.onload=r)
    ]).then(init);

    function init() {
      // UI references
      const canvas          = document.getElementById("canvas");
      const ctx             = canvas.getContext("2d");
      const scoreDiv        = document.getElementById("score");
      const pauseBtn        = document.getElementById("pauseBtn");
      const effectOverlay   = document.getElementById("effectOverlay");
      const overlays        = {
        menu:        document.getElementById("menu"),
        leaderboard: document.getElementById("leaderboard"),
        settings:    document.getElementById("settings"),
        pause:       document.getElementById("pause"),
        gameover:    document.getElementById("gameover")
      };
      const finalScoreEl    = document.getElementById("finalScore");
      const startBtn        = document.getElementById("startBtn");
      const lbBtn           = document.getElementById("leaderboardBtn");
      const linkBtn         = document.getElementById("linkBtn");
      const settingsBtn     = document.getElementById("settingsBtn");
      const settingsBtnPause= document.getElementById("settingsBtnPause");
      const closeSettingsBtn= document.getElementById("closeSettingsBtn");
      const soundToggle     = document.getElementById("soundToggle");
      const themeToggle     = document.getElementById("themeToggle");
      const backFromLbBtn   = document.getElementById("backFromLbBtn");
      const resumeBtn       = document.getElementById("resumeBtn");
      const backFromPauseBtn= document.getElementById("backFromPauseBtn");
      const restartBtn      = document.getElementById("restartBtn");
      const backFromGOBtn   = document.getElementById("backFromGameOverBtn");

      let state        = "menu";
      let bird, pipes, score, frame, animId;
      let soundEnabled = true;
      let darkMode     = false;
      let bgImg        = lightBgImg;
      let collided     = false;

      // parallax
      let offsets = [0,0,0];
      const speeds = [0.3,0.8,2];

      // flap cooldown
      const FLAP_CD = 200;
      let lastFlap = 0;

      // resize
      function resize() {
        canvas.width  = innerWidth;
        canvas.height = innerHeight;
      }
      window.addEventListener("resize", resize);
      resize();

      // Bird
      class Bird {
        constructor(){
          this.w=36; this.h=30;
          this.x=50; this.y=(canvas.height-this.h)/2;
          this.vy=0; this.g=0.3;
        }
        update(){
          this.vy+=this.g; this.y+=this.vy;
          if(this.y<0){ this.y=0; this.vy=0; }
          if(this.y+this.h>=canvas.height){
            this.y=canvas.height-this.h;
            scheduleGameOver();
          }
        }
        draw(){
          ctx.drawImage(birdImg,this.x,this.y,this.w,this.h);
        }
        flap(){
          const now=Date.now();
          if(soundEnabled && now-lastFlap>=FLAP_CD){
            flapSound.currentTime=0; flapSound.play();
            lastFlap=now;
          }
          this.vy=-6;
        }
        collides(pipe){
          return !(this.x+this.w<pipe.x ||
                   this.x>pipe.x+pipe.w ||
                   this.y+this.h<pipe.y ||
                   this.y>pipe.y+pipe.h);
        }
      }

      // spawn pipes
      function spawnPipes(){
        const x=canvas.width;
        const h=20+Math.random()*(canvas.height/2-20);
        const gap=120+Math.random()*80;
        pipes=pipes.filter(p=>p.x+p.w>0);
        if(!pipes.length||x-pipes[pipes.length-1].x>200){
          pipes.push({x,y:0,w:40,h,passed:false,isTop:true});
          pipes.push({x,y:h+gap,w:40,h:canvas.height-h-gap,passed:false,isTop:false});
        }
      }

      // freeze & effect overlay
      function scheduleGameOver(){
        if(collided) return;
        collided=true;
        state="dying";
        cancelAnimationFrame(animId);
        pauseBtn.style.display="none";
        Object.values(overlays).forEach(o=>o.classList.add("hidden"));
        effectOverlay.classList.remove("hidden");

        if(!soundEnabled){
          performGameOver();
          return;
        }
        hitSound.currentTime=0; hitSound.play();
        hitSound.addEventListener("ended",()=>{
          dieSound.currentTime=0; dieSound.play();
          dieSound.addEventListener("ended",performGameOver,{once:true});
        },{once:true});
      }

      // show game over UI
      function performGameOver(){
        effectOverlay.classList.add("hidden");
        state="gameover";
        finalScoreEl.textContent=score;
        db.orderByChild("score").limitToLast(10)
          .once("value",snap=>{
            const data=snap.val()||{};
            const list=Object.values(data).sort((a,b)=>b.score-a.score);
            const thresh=list.length<10?0:list[list.length-1].score;
            const pushScore=()=>{
              const name=prompt("🎉 New High Score! Enter name:","Anon")||"Anon";
              return db.push({name,score});
            };
            Promise.resolve(score>thresh?pushScore():null)
              .then(()=>renderGameOverList());
          });
      }

      function renderGameOverList(){
        const c=document.getElementById("lb-list-go");
        c.innerHTML="";
        db.orderByChild("score").limitToLast(10)
          .once("value",snap=>{
            Object.values(snap.val()||{})
              .sort((a,b)=>b.score-a.score)
              .forEach((e,i)=>{
                const d=document.createElement("div");
                d.textContent=`${i+1}. ${e.name}: ${e.score}`;
                c.appendChild(d);
              });
            show("gameover");
          });
      }

      // main loop
      function loop(){
        if(state!=="playing") return;
        frame++;
        // parallax bg
        for(let i=0;i<3;i++){
          offsets[i]=(offsets[i]+speeds[i])%canvas.width;
          ctx.drawImage(bgImg,-offsets[i],0,canvas.width,canvas.height);
          ctx.drawImage(bgImg,canvas.width-offsets[i],0,canvas.width,canvas.height);
        }
        // pipes & collision & score
        if(frame===1||frame%150===0) spawnPipes();
        pipes.forEach(p=>{
          p.x-=2;
          ctx.drawImage(pipeImg,p.x,p.y,p.w,p.h);
          if(!collided && bird.collides(p)){
            scheduleGameOver();
          }
          if(p.isTop && !p.passed && bird.x>p.x+p.w){
            p.passed=true; score++;
            scoreDiv.textContent=score;
            if(soundEnabled){
              pointSound.currentTime=0; pointSound.play();
            }
          }
        });
        pipes=pipes.filter(p=>p.x+p.w>0);

        bird.update(); bird.draw();
        animId=requestAnimationFrame(loop);
      }

      // overlay helpers
      function hideAll(){
        Object.values(overlays).forEach(o=>o.classList.add("hidden"));
        pauseBtn.style.display="none";
      }
      function show(id){
        hideAll();
        if(id==="playing") pauseBtn.style.display="block";
        else overlays[id].classList.remove("hidden");
      }

      // leaderboard menu
      function renderLeaderboardMenu(){
        const c=document.getElementById("lb-list");
        c.innerHTML="";
        db.orderByChild("score").limitToLast(10)
          .once("value",snap=>{
            Object.values(snap.val()||{})
              .sort((a,b)=>b.score-a.score)
              .forEach((e,i)=>{
                const d=document.createElement("div");
                d.textContent=`${i+1}. ${e.name}: ${e.score}`;
                c.appendChild(d);
              });
            show("leaderboard");
          });
      }

      // UI toggles
      function updateSoundToggle(){
        soundToggle.textContent=soundEnabled?"🔊 Sound":"🔇 Mute";
      }
      function updateThemeToggle(){
        themeToggle.textContent=darkMode?"☀️ Light Mode":"🌙 Dark Mode";
      }

      // actions
      function startGame(){
        state="playing";
        bird=new Bird(); pipes=[]; score=0; frame=0;
        collided=false; offsets=[0,0,0];
        bgImg=darkMode?darkBgImg:lightBgImg;
        scoreDiv.textContent=score;
        show("playing");
        cancelAnimationFrame(animId);
        loop();
      }
      function pauseGame(){
        if(state!=="playing") return;
        state="paused"; cancelAnimationFrame(animId); show("pause");
      }
      function resumeGame(){
        if(state!=="paused") return;
        state="playing"; show("playing"); loop();
      }
      function backToMenu(){ state="menu"; show("menu"); }
      function openSettings(){ hideAll(); show("settings"); }
      function closeSettings(){
        hideAll(); state==="pause"?show("pause"):show("menu");
      }
      function restartGame(){ startGame(); }

      // bind
      function bind(id,fn){
        const el=document.getElementById(id);
        el.addEventListener("click",fn);
        el.addEventListener("touchend",e=>{e.preventDefault();fn();});
      }
      bind("startBtn",startGame);
      bind("leaderboardBtn",renderLeaderboardMenu);
      bind("linkBtn",()=>location.href=HUB_LINK);
      bind("settingsBtn",openSettings);
      bind("settingsBtnPause",openSettings);
      bind("closeSettingsBtn",closeSettings);
      bind("pauseBtn",pauseGame);
      bind("resumeBtn",resumeGame);
      bind("backFromPauseBtn",backToMenu);
      bind("backFromLbBtn",backToMenu);
      bind("restartBtn",restartGame);
      bind("backFromGameOverBtn",backToMenu);

      // settings
      soundToggle.addEventListener("click",()=>{
        soundEnabled=!soundEnabled; updateSoundToggle();
      });
      themeToggle.addEventListener("click",()=>{
        darkMode=!darkMode; updateThemeToggle();
      });

      // controls
      window.addEventListener("keydown",e=>{
        if(e.code==="Space"&&state==="playing"){bird.flap();e.preventDefault();}
        if(e.key==="k"&&state==="playing") pauseGame();
      });
      ["click","mousedown","touchstart"].forEach(evt=>{
        canvas.addEventListener(evt,e=>{
          if(state==="playing"){bird.flap();e.preventDefault();}
        });
      });

      updateSoundToggle();
      updateThemeToggle();
      show("menu");
    }
  });
  </script>
</body>
</html>
