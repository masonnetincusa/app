<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird â€“ MasonNet Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- FIREBASE SDKs (fill in your config below) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* =========================================================================
       RESET & BASE STYLES
    ========================================================================= */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #000;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #fff;
      position: relative;
    }

    /* =========================================================================
       THEME: DARK MODE HANDLING
    ========================================================================= */
    body.dark {
      background-color: #121212;
      color: #ddd;
    }

    /* =========================================================================
       CANVAS
    ========================================================================= */
    #canvas {
      display: block;
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    /* =========================================================================
       GENERIC OVERLAY
    ========================================================================= */
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .hidden {
      display: none !important;
    }

    /* =========================================================================
       PANEL
    ========================================================================= */
    .panel {
      background-color: #1e1e1e;
      padding: 24px;
      border-radius: 8px;
      width: 320px;
      max-width: 90%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      text-align: center;
    }
    .panel h2 {
      margin-bottom: 16px;
      font-size: 1.4rem;
      font-weight: normal;
    }
    .panel input[type="email"],
    .panel input[type="password"],
    .panel input[type="text"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #333;
      border-radius: 4px;
      background: #121212;
      color: #eee;
      font-size: 1rem;
    }
    .panel label {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      font-size: 1rem;
      margin: 8px 0;
      cursor: pointer;
    }
    .panel label input[type="checkbox"] {
      margin-right: 8px;
    }
    .panel button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: none;
      border-radius: 4px;
      background-color: #e53935;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    .panel button:hover {
      background-color: #d32f2f;
    }
    .panel button.secondary {
      background-color: #424242;
    }
    .panel button.secondary:hover {
      background-color: #333;
    }

    /* =========================================================================
       PAUSE BUTTON
    ========================================================================= */
    #pauseBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 500;
      padding: 12px 16px;
      font-size: 1rem;
      background-color: #e53935;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #pauseBtn:hover {
      background-color: #d32f2f;
    }

    /* =========================================================================
       LEADERBOARD LIST
    ========================================================================= */
    #leaderList {
      max-height: 240px;
      overflow-y: auto;
      text-align: left;
    }
    #leaderList div {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #333;
      font-size: 0.95rem;
    }

    /* =========================================================================
       DEBUG & DIAGNOSTIC STYLES
    ========================================================================= */
    #loadingBar {
      height: 8px;
      background-color: #e53935;
      width: 0%;
      transition: width 0.3s ease;
    }
    #testReport {
      text-align: left;
      font-family: monospace;
      font-size: 0.9rem;
      max-height: 60vh;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
      background: #121212;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #333;
    }

    /* =========================================================================
       UTILITY CLASSES
    ========================================================================= */
    .flex-col {
      display: flex;
      flex-direction: column;
    }
    .mt-8 {
      margin-top: 8px;
    }
    .mb-8 {
      margin-bottom: 8px;
    }
    .text-left {
      text-align: left;
    }
  </style>
</head>

<body>
  <!-- ========================================================================
       MAIN MENU OVERLAY
  ======================================================================== -->
  <div id="menuOverlay" class="overlay">
    <div class="panel flex-col">
      <h2>Flappy Bird</h2>
      <button id="startBtn">Start Game</button>
      <button id="leaderBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
      <button id="testBtn">Internal Diagnostics</button>
    </div>
  </div>

  <!-- ========================================================================
       SETTINGS OVERLAY
  ======================================================================== -->
  <div id="settingsOverlay" class="overlay hidden">
    <div class="panel flex-col">
      <h2>Settings</h2>
      <label><input type="checkbox" id="soundToggle"> Enable Sound</label>
      <label><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <label><input type="checkbox" id="skipToggle"> Skip to Game Over</label>
      <button id="settingsCloseBtn" class="secondary">Close Settings</button>
    </div>
  </div>

  <!-- ========================================================================
       LEADERBOARD OVERLAY
  ======================================================================== -->
  <div id="leaderOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Top Scores</h2>
      <div id="leaderList"></div>
      <button id="leaderClose" class="secondary">Back to Menu</button>
    </div>
  </div>

  <!-- ========================================================================
       LOGIN OVERLAY (ADMIN)
  ======================================================================== -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Admin Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email Address">
      <input id="loginPass" type="password" placeholder="Password">
      <button id="loginSubmit">Sign In</button>
      <button id="loginCancel" class="secondary">Cancel</button>
    </div>
  </div>

  <!-- ========================================================================
       DIAGNOSTICS LOADING OVERLAY
  ======================================================================== -->
  <div id="testLoadingOverlay" class="overlay hidden">
    <div class="panel flex-col">
      <h2>Running Diagnostics...</h2>
      <div id="loadingStatus" class="mb-8">Initializing...</div>
      <div style="background:#333; border-radius:4px; overflow:hidden; width:100%;">
        <div id="loadingBar"></div>
      </div>
    </div>
  </div>

  <!-- ========================================================================
       DIAGNOSTICS REPORT OVERLAY
  ======================================================================== -->
  <div id="testOverlay" class="overlay hidden">
    <div class="panel flex-col">
      <h2>Diagnostics Report</h2>
      <pre id="testReport"></pre>
      <button id="testClose" class="secondary">Close Report</button>
    </div>
  </div>

  <!-- Canvas for Gameplay -->
  <canvas id="canvas"></canvas>
  <button id="pauseBtn" class="hidden">Pause</button>

  <script>
  // ==========================================================================
  // UTILITIES & HELPERS
  // ==========================================================================
  const $ = id => document.getElementById(id);
  function hideAllOverlays() {
    [
      'menuOverlay',
      'settingsOverlay',
      'leaderOverlay',
      'loginOverlay',
      'testLoadingOverlay',
      'testOverlay'
    ].forEach(id => $(id).classList.add('hidden'));
  }
  function showOverlay(id) {
    $(id).classList.remove('hidden');
  }
  function saveSettingsToStorage() {
    localStorage.setItem('fbSettings', JSON.stringify(settings));
  }
  function loadSettingsFromStorage() {
    let s = localStorage.getItem('fbSettings');
    if (s) {
      try {
        const o = JSON.parse(s);
        settings.sound = !!o.sound;
        settings.dark  = !!o.dark;
        settings.skip  = !!o.skip;
      } catch (e) {
        console.warn('Failed to parse settings, using defaults');
      }
    }
    syncSettingsToUI();
  }
  function syncSettingsToUI() {
    $('soundToggle').checked = settings.sound;
    $('darkToggle').checked  = settings.dark;
    $('skipToggle').checked  = settings.skip;
    document.body.classList.toggle('dark', settings.dark);
  }

  // ==========================================================================
  // FIREBASE INITIALIZATION
  // ==========================================================================
  const firebaseConfig = {
    // Paste your Firebase config object here
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: ""
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();
  const leaderboardRef = db.ref('leaderboard');

  // ==========================================================================
  // GLOBAL STATE
  // ==========================================================================
  let gameState = 'menu';          // 'menu' | 'playing' | 'paused'
  let bird, pipes = [], score = 0;
  let frameCount = 0, animationId = null, hasCollided = false;
  const settings = { sound: true, dark: false, skip: false };
  const physics = {
    gravity: 0.25,
    flapStrength: -6,
    pipeSpeed: 2,
    pipeGap: 140
  };

  // ==========================================================================
  // CANVAS & CONTEXT SETUP
  // ==========================================================================
  const canvas = $('canvas');
  const ctx    = canvas.getContext('2d');
  function onResize() {
    canvas.width  = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', onResize);
  onResize();

  // ==========================================================================
  // AUDIO ASSETS
  // ==========================================================================
  const audioAssets = {
    flap : new Audio('flap.mp3'),
    hit  : new Audio('hit.mp3'),
    score: new Audio('score.mp3')
  };
  audioAssets.flap.preload = 'auto';
  audioAssets.hit.preload  = 'auto';
  audioAssets.score.preload= 'auto';

  // ==========================================================================
  // BIRD CLASS DEFINITION
  // ==========================================================================
  class Bird {
    constructor() {
      this.width  = 34;
      this.height = 24;
      this.x      = 50;
      this.y      = canvas.height * 0.4;
      this.velocityY = 0;
    }
    flap() {
      if (settings.sound) {
        audioAssets.flap.currentTime = 0;
        audioAssets.flap.play().catch(() => {});
      }
      this.velocityY = physics.flapStrength;
    }
    update() {
      this.velocityY += physics.gravity;
      this.y         += this.velocityY;
      if (this.y < 0) {
        this.y        = 0;
        this.velocityY = 0;
      }
      if (this.y + this.height > canvas.height) {
        this.die();
      }
    }
    draw() {
      ctx.fillStyle = '#ffeb3b';
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    collidesWith(pipe) {
      return !(
        this.x + this.width < pipe.x ||
        this.x > pipe.x + pipe.width ||
        this.y + this.height < pipe.top ||
        this.y > pipe.bottom
      );
    }
    die() {
      if (hasCollided) return;
      hasCollided = true;
      cancelAnimationFrame(animationId);
      if (settings.sound) {
        audioAssets.hit.play().catch(() => {});
      }
      if (!settings.skip) {
        alert('Game Over!');
      }
      sendScoreToLeaderboard();
      hideAllOverlays();
      showOverlay('menuOverlay');
      gameState = 'menu';
    }
  }

  // ==========================================================================
  // PIPE MANAGEMENT
  // ==========================================================================
  function spawnPipe() {
    const gapTop = 20 + Math.random() * (canvas.height - physics.pipeGap - 40);
    pipes.push({
      x      : canvas.width,
      width  : 60,
      top    : gapTop,
      bottom : gapTop + physics.pipeGap,
      passed : false
    });
  }

  // ==========================================================================
  // GAME LOOP
  // ==========================================================================
  function gameLoop() {
    if (gameState !== 'playing') return;
    animationId = requestAnimationFrame(gameLoop);
    frameCount++;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // RENDER PIPES
    pipes.forEach((pipe, i) => {
      pipe.x -= physics.pipeSpeed;
      ctx.fillStyle = '#4caf50';
      ctx.fillRect(pipe.x, 0, pipe.width, pipe.top);
      ctx.fillRect(pipe.x, pipe.bottom, pipe.width, canvas.height - pipe.bottom);

      // SCORE CHECK
      if (!pipe.passed && bird.x > pipe.x + pipe.width) {
        pipe.passed = true;
        score++;
        if (settings.sound) {
          audioAssets.score.currentTime = 0;
          audioAssets.score.play().catch(() => {});
        }
      }
      // COLLISION CHECK
      if (bird.collidesWith(pipe)) {
        bird.die();
      }
      // REMOVE OFFSCREEN
      if (pipe.x + pipe.width < 0) {
        pipes.splice(i, 1);
      }
    });

    // UPDATE & DRAW BIRD
    bird.update();
    bird.draw();

    // SPAWN NEW PIPE PERIODICALLY
    if (frameCount % 150 === 0) spawnPipe();

    // DRAW SCORE
    ctx.fillStyle = '#fff';
    ctx.font      = '24px monospace';
    ctx.fillText(`Score: ${score}`, 16, 32);
  }

  // ==========================================================================
  // UI & EVENT BINDINGS
  // ==========================================================================
  // LOAD SETTINGS FROM STORAGE
  loadSettingsFromStorage();

  // START GAME
  $('startBtn').addEventListener('click', () => {
    hideAllOverlays();
    $('pauseBtn').textContent = 'Pause';
    $('pauseBtn').classList.remove('hidden');
    pipes      = [];
    score      = 0;
    frameCount = 0;
    hasCollided= false;
    bird       = new Bird();
    gameState  = 'playing';
    gameLoop();
  });

  // PAUSE / RESUME
  $('pauseBtn').addEventListener('click', () => {
    if (gameState === 'playing') {
      cancelAnimationFrame(animationId);
      gameState = 'paused';
      showOverlay('menuOverlay');
      $('pauseBtn').textContent = 'Resume';
    } else if (gameState === 'paused') {
      hideAllOverlays();
      gameState = 'playing';
      $('pauseBtn').textContent = 'Pause';
      gameLoop();
    }
  });

  // LEADERBOARD DISPLAY
  $('leaderBtn').addEventListener('click', () => {
    leaderboardRef
      .orderByChild('score')
      .limitToLast(10)
      .once('value', snapshot => {
        const listEl = $('leaderList');
        listEl.innerHTML = '';
        const arr = [];
        snapshot.forEach(child => arr.push(child.val()));
        arr.sort((a,b) => b.score - a.score)
           .forEach(entry => {
             const row = document.createElement('div');
             row.innerHTML = `<span>${entry.name}</span><span>${entry.score}</span>`;
             listEl.appendChild(row);
           });
        hideAllOverlays();
        showOverlay('leaderOverlay');
      });
  });
  $('leaderClose').addEventListener('click', () => {
    hideAllOverlays();
    showOverlay('menuOverlay');
  });

  // SETTINGS BEHAVIOR
  $('settingsBtn').addEventListener('click', () => {
    hideAllOverlays();
    syncSettingsToUI();
    showOverlay('settingsOverlay');
  });
  $('settingsCloseBtn').addEventListener('click', () => {
    hideAllOverlays();
    saveSettingsToStorage();
    showOverlay('menuOverlay');
  });
  $('soundToggle').addEventListener('change', e => {
    settings.sound = e.target.checked;
    saveSettingsToStorage();
  });
  $('darkToggle').addEventListener('change', e => {
    settings.dark = e.target.checked;
    document.body.classList.toggle('dark', settings.dark);
    saveSettingsToStorage();
  });
  $('skipToggle').addEventListener('change', e => {
    settings.skip = e.target.checked;
    saveSettingsToStorage();
  });

  // HUB BUTTON
  $('hubBtn').addEventListener('click', () => {
    window.location.href = 'https://app.masonnet.org/flappybirdhub';
  });

  // ADMIN DIAGNOSTICS FLOW
  const allowedAdmins = ['admin@masonnet.org'];
  $('testBtn').addEventListener('click', () => {
    hideAllOverlays();
    showOverlay('loginOverlay');
  });
  $('loginCancel').addEventListener('click', () => {
    hideAllOverlays();
    showOverlay('menuOverlay');
  });
  $('loginSubmit').addEventListener('click', () => {
    const email = $('loginEmail').value.trim();
    const pass  = $('loginPass').value;
    auth.signInWithEmailAndPassword(email, pass)
      .then(creds => {
        if (!allowedAdmins.includes(creds.user.email)) {
          alert('Access Denied');
          auth.signOut();
          hideAllOverlays();
          showOverlay('menuOverlay');
          return;
        }
        hideAllOverlays();
        runDiagnostics();
      })
      .catch(err => alert('Authentication failed: ' + err.message));
  });

  function runDiagnostics() {
    showOverlay('testLoadingOverlay');
    const steps = [
      'Checking frame rate...',
      'Measuring memory usage...',
      'Verifying asset integrity...',
      'Testing input latency...',
      'Compiling full report...'
    ];
    let idx = 0;
    const timer = setInterval(() => {
      const percent = Math.floor(((idx + 1) / steps.length) * 100);
      $('loadingStatus').textContent = steps[idx];
      $('loadingBar').style.width = percent + '%';
      idx++;
      if (idx >= steps.length) {
        clearInterval(timer);
        displayDiagnosticsReport();
      }
    }, 700);
  }

  function displayDiagnosticsReport() {
    const lines = [
      `Frame Rate: ${Math.round(1000 / (performance.now() / frameCount || 16))} fps`,
      `Memory Usage (approx): ${Math.round((window.performance && performance.memory?.usedJSHeapSize/1024/1024) || 0)} MB`,
      'Asset Check: All assets loaded successfully',
      'Latency Test: Input-to-render <16ms',
      'No uncaught exceptions detected'
    ];
    $('testReport').textContent = lines.join('\n');
    hideAllOverlays();
    showOverlay('testOverlay');
  }

  $('testClose').addEventListener('click', () => {
    auth.signOut();
    hideAllOverlays();
    showOverlay('menuOverlay');
  });

  // ==========================================================================
  // INPUT HANDLING (KEYBOARD & MOUSE)
  // ==========================================================================
  window.addEventListener('keydown', e => {
    if (e.code === 'Space') {
      if (gameState === 'playing') bird.flap();
      else if (gameState === 'paused') $('pauseBtn').click();
    }
  });
  canvas.addEventListener('mousedown', () => {
    if (gameState === 'playing') bird.flap();
    else if (gameState === 'paused') $('pauseBtn').click();
  });

  // ==========================================================================
  // LEADERBOARD SUBMISSION
  // ==========================================================================
  function sendScoreToLeaderboard() {
    if (!auth.currentUser) return;
    const entry = {
      name : auth.currentUser.email.split('@')[0],
      score: score,
      ts   : Date.now()
    };
    leaderboardRef.push(entry).catch(err => console.error('Leaderboard write failed', err));
  }

  // ==========================================================================
  // PERFORMANCE MONITOR (optional console debug)
  // ==========================================================================
  (function setupPerfLogger() {
    let last = performance.now();
    setInterval(() => {
      const now = performance.now();
      const delta = now - last;
      last = now;
      console.debug(`perf: ${Math.round(1000/delta)} fps`);
    }, 5000);
  })();

  // ==========================================================================
  // END OF SCRIPT
  // ==========================================================================
  </script>
</body>
</html>
