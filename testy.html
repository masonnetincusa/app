<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Bird Hub</title>
  <style>
    /* === Theme Variables === */
    :root {
      --bg-light: #fff;
      --text-light: #000;
      --btn-bg-light: #ffcd00;
      --bg-dark: #000;
      --text-dark: #fff;
      --btn-bg-dark: #444;
    }

    /* === Base Styles === */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.theme-light {
      background: var(--bg-light);
      color: var(--text-light);
    }
    body.theme-dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    #titleImg {
      position: absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 6;
      width: 240px;
    }

    .panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 5;
      display: none;
    }
    .panel.visible {
      display: block;
    }

    button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    body.theme-light button {
      background: var(--btn-bg-light);
      color: var(--text-light);
    }
    body.theme-dark button {
      background: var(--btn-bg-dark);
      color: var(--text-dark);
    }
    button:hover {
      opacity: 0.85;
    }

    #profileCard {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 10;
    }
    #profileCard img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      vertical-align: middle;
    }
    #profileCard button {
      margin-left: 8px;
      padding: 5px 10px;
      font-size: 0.9em;
    }

    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
      display: none;
    }

    #overlayContainer {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 15;
      pointer-events: none;
    }
    .overlay {
      background: rgba(0,0,0,0.7);
      color: #ffcd00;
      padding: 5px 10px;
      margin-top: 5px;
      border-radius: 3px;
      animation: fadeOut 1s ease-out 1 forwards;
    }
    @keyframes fadeOut {
      to { opacity: 0; transform: translateY(-20px); }
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="theme-light">

  <!-- Profile & Auth -->
  <div id="profileCard">
    <img id="avatar" src="https://app.masonnet.org/default-avatar.png" alt="Avatar" />
    <button id="authBtn">Sign In</button>
  </div>

  <!-- Branded Title -->
  <img id="titleImg" src="https://app.masonnet.org/fbrc.png" alt="Flappy Bird Hub" />

  <!-- Main Menu -->
  <div id="menuPanel" class="panel visible">
    <button id="startBtn">Start Game</button>
    <button id="leaderboardBtn">Leaderboard</button>
    <button id="settingsBtn">Settings</button>
    <button id="hubBtn">Flappy Bird Hub</button>
    <button id="testBtn" style="display:none;">Admin Test</button>
  </div>

  <!-- Leaderboard Panel -->
  <div id="leaderboardPanel" class="panel">
    <h2>Leaderboard</h2>
    <ol id="scoresList"></ol>
    <button id="backFromLeaderboard">Back</button>
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel" class="panel">
    <h2>Settings</h2>
    <label>
      <input type="checkbox" id="sfxToggle" checked />
      Sound Effects
    </label>
    <label>
      <input type="checkbox" id="themeToggle" />
      Dark Mode
    </label>
    <button id="backFromSettings">Back</button>
  </div>

  <!-- Admin Debug Panel -->
  <div id="testPanel" class="panel">
    <h2>Admin Debug</h2>
    <pre id="debugInfo">Loading...</pre>
    <button id="backFromTest">Back</button>
  </div>

  <!-- Game Canvas -->
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <!-- Overlays -->
  <div id="overlayContainer"></div>

  <script>
  // ===== Firebase Initialization =====
  const firebaseConfig = {
    apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0F9E7axOIxE",
    authDomain: "masonnet-app-official.firebaseapp.com",
    databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
    projectId: "masonnet-app-official",
    storageBucket: "masonnet-app-official.firebasestorage.app",
    messagingSenderId: "783919367562",
    appId: "1:783919367562:web:b7bb809332a4e873f3b473",
    measurementId: "G-X1YKV5VK7J"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.database();

  // ===== DOM & State =====
  const panels      = {
    menu: document.getElementById('menuPanel'),
    leaderboard: document.getElementById('leaderboardPanel'),
    settings: document.getElementById('settingsPanel'),
    test: document.getElementById('testPanel')
  };
  const canvas      = document.getElementById('gameCanvas');
  const ctx         = canvas.getContext('2d');
  const titleImg    = document.getElementById('titleImg');
  const overlays    = document.getElementById('overlayContainer');
  let gameState     = 'MENU';   // MENU | GAME | OVER
  let isAdmin       = false;
  let settingsObj   = { sfx: true, theme: localStorage.getItem('theme') || 'light' };

  // ===== Load & Apply Theme =====
  document.body.classList.remove('theme-light','theme-dark');
  document.body.classList.add(`theme-${settingsObj.theme}`);
  document.getElementById('themeToggle').checked = settingsObj.theme === 'dark';

  // ===== Sprite Assets =====
  const bgImg        = new Image();
  bgImg.src          = 'https://app.masonnet.org/bg-day.png';
  const birdImg      = new Image();
  birdImg.src        = 'https://app.masonnet.org/bird.png';
  const pipeNorthImg = new Image();
  pipeNorthImg.src   = 'https://app.masonnet.org/pipeNorth.png';
  const pipeSouthImg = new Image();
  pipeSouthImg.src   = 'https://app.masonnet.org/pipeSouth.png';

  // Audio Assets
  const sounds = {
    flap:  new Audio('https://app.masonnet.org/flap.mp3'),
    point: new Audio('https://app.masonnet.org/point.mp3'),
    hit:   new Audio('https://app.masonnet.org/hit.mp3'),
    die:   new Audio('https://app.masonnet.org/die.mp3')
  };

  // ===== Utilities =====
  function showPanel(name) {
    Object.values(panels).forEach(p => p.classList.remove('visible'));
    if (name && panels[name]) {
      panels[name].classList.add('visible');
      canvas.style.display = 'none';
      titleImg.style.display  = name === 'menu' ? 'block' : 'none';
    }
  }
  function toast(msg) {
    const div = document.createElement('div');
    div.className = 'overlay';
    div.textContent = msg;
    overlays.append(div);
    setTimeout(() => div.remove(), 1000);
  }

  // ===== Auth & Admin Gating =====
  document.getElementById('authBtn').onclick = () => {
    if (auth.currentUser) auth.signOut();
    else auth.signInAnonymously();
  };
  auth.onAuthStateChanged(user => {
    const btn = document.getElementById('authBtn');
    btn.textContent = user ? 'Sign Out' : 'Sign In';
    isAdmin = false;
    if (user) {
      user.getIdTokenResult().then(token => {
        isAdmin = !!token.claims.admin;
        document.getElementById('testBtn').style.display = isAdmin ? 'block' : 'none';
      });
    } else {
      document.getElementById('testBtn').style.display = 'none';
    }
  });

  // ===== Menu Hooks =====
  document.getElementById('startBtn').onclick = () => {
    Object.values(panels).forEach(p => p.classList.remove('visible'));
    titleImg.style.display = 'none';
    canvas.style.display   = 'block';
    startGame();
  };
  document.getElementById('leaderboardBtn').onclick = () => {
    loadLeaderboard();
    showPanel('leaderboard');
  };
  document.getElementById('settingsBtn').onclick = () => {
    document.getElementById('sfxToggle').checked = settingsObj.sfx;
    document.getElementById('themeToggle').checked = settingsObj.theme === 'dark';
    showPanel('settings');
  };
  document.getElementById('hubBtn').onclick = () => {
    window.location = 'https://app.masonnet.org/flappybirdhub';
  };
  document.getElementById('testBtn').onclick = () => showPanel('test');
  document.getElementById('backFromLeaderboard').onclick = () => showPanel('menu');
  document.getElementById('backFromSettings').onclick  = () => showPanel('menu');
  document.getElementById('backFromTest').onclick      = () => showPanel('menu');

  document.getElementById('sfxToggle').onchange = e => {
    settingsObj.sfx = e.target.checked;
    toast('SFX ' + (settingsObj.sfx ? 'On' : 'Off'));
  };
  document.getElementById('themeToggle').onchange = e => {
    const theme = e.target.checked ? 'dark' : 'light';
    settingsObj.theme = theme;
    localStorage.setItem('theme', theme);
    document.body.classList.toggle('theme-dark', theme==='dark');
    document.body.classList.toggle('theme-light', theme==='light');
    toast(theme.charAt(0).toUpperCase() + theme.slice(1) + ' Mode');
  };

  // ===== Leaderboard =====
  function loadLeaderboard() {
    const list = document.getElementById('scoresList');
    list.innerHTML = '<li>Loading...</li>';
    db.ref('scores').orderByChild('score').limitToLast(10)
      .once('value', snap => {
        const items = [];
        snap.forEach(c => items.push(c.val()));
        items.reverse();
        list.innerHTML = items.map(o => `<li>${o.name}: ${o.score}</li>`).join('');
      });
  }

  // ===== Game Logic =====
  let bird, pipes, frameCount, score, animRef;
  function startGame() {
    bird       = { x: 50, y: 320, w: 34, h: 24, vel: 0 };
    pipes      = [];
    frameCount = 0;
    score      = 0;
    gameState  = 'GAME';
    loop();
  }
  function loop() {
    animRef = requestAnimationFrame(loop);
    update();
    draw();
    if (gameState==='OVER') {
      cancelAnimationFrame(animRef);
      endGame();
    }
  }
  function update() {
    frameCount++;
    bird.vel += 0.5; bird.y += bird.vel;

    if (frameCount % 100 === 0) {
      const gap = 120;
      const topH = Math.random()*(canvas.height-gap-200)+50;
      pipes.push({ x:480, y:0, w:52, h:topH, passed:false });
      pipes.push({ x:480, y:topH+gap, w:52, h:canvas.height, passed:false });
    }

    pipes.forEach(p => {
      p.x -= 2;
      if (!p.passed && p.x+p.w < bird.x) {
        score++; p.passed=true;
        if (settingsObj.sfx) sounds.point.play();
      }
      if (bird.x<p.x+p.w && bird.x+bird.w>p.x &&
          bird.y<p.y+p.h && bird.y+bird.h>p.y) {
        gameState='OVER'; if (settingsObj.sfx) sounds.hit.play();
      }
    });

    if (bird.y+bird.h>canvas.height||bird.y<0) {
      gameState='OVER'; if (settingsObj.sfx) sounds.die.play();
    }
  }
  function draw() {
    // background
    ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

    // pipes
    pipes.forEach(p=>{
      if(p.y===0) ctx.drawImage(pipeNorthImg,p.x,p.y,p.w,p.h);
      else        ctx.drawImage(pipeSouthImg,p.x,p.y,p.w,p.h);
    });

    // bird
    ctx.drawImage(birdImg,bird.x,bird.y,bird.w,bird.h);

    // score
    ctx.fillStyle = settingsObj.theme==='dark'?'#fff':'#000';
    ctx.font = '30px Arial';
    ctx.fillText(score,canvas.width/2-10,50);
  }
  function endGame() {
    const uid = auth.currentUser?auth.currentUser.uid:'anon';
    const name= uid.slice(0,5);
    db.ref('scores').push({ name, score });
    toast('Game Over! Score: '+score);
    setTimeout(()=> showPanel('menu'),2000);
  }

  // ===== Input =====
  window.addEventListener('keydown',e=>{
    if(e.code==='Space'&&gameState==='GAME'){
      bird.vel=-8; if(settingsObj.sfx) sounds.flap.play();
    }
  });
  canvas.addEventListener('click',()=>{
    if(gameState==='GAME'){
      bird.vel=-8; if(settingsObj.sfx) sounds.flap.play();
    }
  });

  // ===== Admin Debug Info =====
  setInterval(()=>{
    if(isAdmin){
      document.getElementById('debugInfo').textContent =
        JSON.stringify({ frame:frameCount, pipes:pipes.length, score },null,2);
    }
  },500);
  </script>
</body>
</html>
