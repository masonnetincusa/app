<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flappy Bird Hub</title>
  <style>
    /* Layered UI: canvas (z-index 1), overlays (z-index 2) */
    #layer-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
      display: none;
    }
    #ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    .panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.5);
      pointer-events: auto;
    }
    .panel.visible { display: flex; }
    .btn {
      background: #e63946;
      color: white;
      border: none;
      padding: 12px 24px;
      margin: 8px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .btn:hover { background: #d62839; }
    ul { list-style: none; padding: 0; color: white; }
    ul li { font-size: 1.5rem; margin: 4px 0; }
  </style>

  <!-- Firebase SDKs (v9 modular) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      limit,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

    // TODO: replace with your Firebase config
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
  authDomain: "masonnet-app-official.firebaseapp.com",
  databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
  projectId: "masonnet-app-official",
  storageBucket: "masonnet-app-official.firebasestorage.app",
  messagingSenderId: "783919367562",
  appId: "1:783919367562:web:b7bb809332a4e873f3b473",
  measurementId: "G-X1YKV5VK7J"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Record a new score in Firestore
    function recordScore(score) {
      return addDoc(collection(db, 'leaderboard'), {
        score,
        timestamp: serverTimestamp()
      }).catch(console.error);
    }

    // Load top 10 scores and render in the UL
    async function loadScores() {
      const q = query(
        collection(db, 'leaderboard'),
        orderBy('score', 'desc'),
        limit(10)
      );
      const snapshot = await getDocs(q);
      const list = document.getElementById('scores-list');
      list.innerHTML = '';
      snapshot.forEach(doc => {
        const li = document.createElement('li');
        li.textContent = doc.data().score;
        list.appendChild(li);
      });
    }

    // Expose to global so UI code can call
    window.recordScore = recordScore;
    window.loadScores = loadScores;
  </script>
</head>

<body>
  <div id="layer-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
      <!-- Main Menu -->
      <div id="main-menu" class="panel visible">
        <h1 style="color:white">Flappy Bird Hub</h1>
        <button id="start-button" class="btn">Start Game</button>
        <button id="settings-button" class="btn">Settings</button>
        <button id="leaderboard-button" class="btn">Leaderboard</button>
      </div>

      <!-- Settings -->
      <div id="settings" class="panel">
        <h2 style="color:white">Settings</h2>
        <!-- add your controls here -->
        <button id="settings-back" class="btn">Back</button>
      </div>

      <!-- Leaderboard -->
      <div id="leaderboard" class="panel">
        <h2 style="color:white">Leaderboard</h2>
        <ul id="scores-list"></ul>
        <button id="leaderboard-back" class="btn">Back</button>
      </div>

      <!-- Game Over -->
      <div id="game-over" class="panel">
        <h2 style="color:white">Game Over</h2>
        <p style="color:white">Your score: <span id="final-score">0</span></p>
        <button id="restart-button" class="btn">Play Again</button>
        <button id="menu-button" class="btn">Main Menu</button>
      </div>
    </div>
  </div>

  <script>
    // Sound assets
    const SFX = {
      flap: new Audio('https://app.masonnet.org/flap.mp3'),
      hit: new Audio('https://app.masonnet.org/hit.mp3'),
      die: new Audio('https://app.masonnet.org/die.mp3'),
      point: new Audio('https://app.masonnet.org/point.mp3')
    };

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const panels = {
      main:    document.getElementById('main-menu'),
      settings:document.getElementById('settings'),
      leaderboard: document.getElementById('leaderboard'),
      gameOver: document.getElementById('game-over')
    };

    let bird, pipes, score, gameState, loopHandle;

    // Show exactly one panel (or none for gameplay)
    function showPanel(name) {
      Object.entries(panels).forEach(([key, el]) => {
        el.classList.toggle('visible', key === name);
      });
      // Hide canvas whenever a panel is visible
      canvas.style.display = name ? 'none' : 'block';
      gameState = name || 'playing';
      if (name === 'leaderboard') window.loadScores();
    }

    // Resize to full viewport
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    window.addEventListener('DOMContentLoaded', () => {
      resizeCanvas();
      showPanel('main');
    });
    window.addEventListener('resize', resizeCanvas);

    // Button bindings
    document.getElementById('start-button').onclick     = () => { resetGame(); showPanel(''); };
    document.getElementById('settings-button').onclick  = () => { showPanel('settings'); };
    document.getElementById('leaderboard-button').onclick = () => { showPanel('leaderboard'); };
    document.getElementById('settings-back').onclick    = () => { showPanel('main'); };
    document.getElementById('leaderboard-back').onclick = () => { showPanel('main'); };
    document.getElementById('restart-button').onclick   = () => { resetGame(); showPanel(''); };
    document.getElementById('menu-button').onclick      = () => { showPanel('main'); };

    // Game setup & loop
    function resetGame() {
      bird = { x: 100, y: canvas.height/2, dy: 0, size: 30 };
      pipes = [];
      score = 0;
      loopHandle && cancelAnimationFrame(loopHandle);
      gameLoop();
    }

    function gameLoop() {
      update();
      render();
      if (gameState === 'playing') {
        loopHandle = requestAnimationFrame(gameLoop);
      }
    }

    function update() {
      bird.dy += 0.6;
      bird.y += bird.dy;

      if (!update.bound) {
        update.bound = true;
        window.addEventListener('keydown', e => { if (e.code === 'Space') flap(); });
        canvas.addEventListener('mousedown', flap);
      }

      if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) {
        const gap = 150;
        const topH = Math.random() * (canvas.height - gap - 100) + 50;
        pipes.push({ x: canvas.width, yTop: topH, gap, passed: false });
      }

      pipes.forEach(pipe => {
        pipe.x -= 3;
        if (!pipe.passed && pipe.x + 50 < bird.x) {
          pipe.passed = true;
          score++;
          SFX.point.play();
        }
      });

      // Collision
      pipes.forEach(pipe => {
        if (
          bird.x + bird.size/2 > pipe.x &&
          bird.x - bird.size/2 < pipe.x + 50 &&
          (bird.y - bird.size/2 < pipe.yTop ||
           bird.y + bird.size/2 > pipe.yTop + pipe.gap)
        ) endGame();
      });

      if (bird.y + bird.size/2 > canvas.height ||
          bird.y - bird.size/2 < 0) {
        endGame();
      }

      pipes = pipes.filter(pipe => pipe.x + 50 > 0);
    }

    function render() {
      ctx.fillStyle = '#70c5ce';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#228b22';
      pipes.forEach(pipe => {
        ctx.fillRect(pipe.x, 0, 50, pipe.yTop);
        ctx.fillRect(pipe.x, pipe.yTop + pipe.gap, 50, canvas.height);
      });

      ctx.fillStyle = '#ff0';
      ctx.beginPath();
      ctx.arc(bird.x, bird.y, bird.size/2, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#fff';
      ctx.font = '48px sans-serif';
      ctx.fillText(score, canvas.width / 2 - 12, 60);
    }

    function flap() {
      bird.dy = -10;
      SFX.flap.play();
    }

    function endGame() {
      gameState = 'ended';
      SFX.hit.play();
      setTimeout(() => {
        SFX.die.play();
        document.getElementById('final-score').textContent = score;
        window.recordScore(score);
        showPanel('gameOver');
      }, 200);
    }
  </script>
</body>
</html>
