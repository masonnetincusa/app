<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flappy Bird Hub</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    /* ========== GLOBAL RESET & BASE ========== */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #70c5ce;
      font-family: 'Segoe UI', sans-serif;
      overflow: hidden;
    }
    canvas { display: block; margin: 0 auto; background: #4ec0ca; }

    /* ========== GAME OVER OVERLAY ========== */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      z-index: 10;
    }
    .hidden { display: none; }
    .overlay button {
      margin: 1rem;
      padding: .5rem 1.5rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #f5a623;
      color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* ========== LEADERBOARD MODAL ========== */
    .modal {
      position: fixed;
      top:50%; left:50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 360px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 20;
      display: none;
    }
    .modal.active { display: block; }
    .modal-header {
      padding: 1rem;
      background: #f5a623;
      color: #fff;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 { margin: 0; font-size: 1.25rem; }
    .close-btn {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.25rem;
      cursor: pointer;
    }
    .modal-body {
      padding: 1rem;
    }
    .modal-body ol {
      list-style-position: inside;
      padding-left: 0;
    }
    .modal-body li {
      margin: .5rem 0;
      font-size: 1rem;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- CANVAS -->
  <canvas id="game" width="320" height="480"></canvas>

  <!-- GAME OVER / CONTROLS -->
  <div id="overlay" class="overlay hidden">
    <div style="text-align:center;">
      <h1>Game Over</h1>
      <button id="viewLeaderboard">View Leaderboard</button>
      <button id="restart">Restart</button>
    </div>
  </div>

  <!-- LEADERBOARD MODAL -->
  <div id="leaderboard" class="modal">
    <div class="modal-header">
      <h2>Leaderboard</h2>
      <button id="closeModal" class="close-btn">&times;</button>
    </div>
    <div class="modal-body">
      <ol id="scoresList"></ol>
    </div>
  </div>

  <script>
    // ======= FIREBASE SETUP =======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ======= ASSETS =======
    const SFX = {
      point: new Audio('https://app.masonnet.org/point.mp3'),
      flap:  new Audio('https://app.masonnet.org/flap.mp3'),
      hit:   new Audio('https://app.masonnet.org/hit.mp3'),
      die:   new Audio('https://app.masonnet.org/die.mp3'),
    };

    // ======= CANVAS & CONTEXT =======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // ======= GAME VARIABLES =======
    let frames = 0, score = 0, gameSpeed = 2, gravity = 0.25;
    let bird = { x: 60, y: 150, w: 34, h: 24, dy: 0 };
    const pipes = [];

    // ======= CONTROLS =======
    document.addEventListener('keydown', e => {
      if (e.code === 'Space') jump();
    });
    canvas.addEventListener('mousedown', jump);
    function jump() {
      bird.dy = -4.6;
      SFX.flap.play();
    }

    // ======= SPAWN PIPES =======
    function spawnPipe() {
      const topHeight = Math.random() * (canvas.height/2);
      const gap = 90;
      pipes.push({
        x: canvas.width,
        top: topHeight,
        bottom: topHeight + gap,
        w: 52
      });
    }

    // ======= COLLISION CHECK =======
    function isCollide(pipe) {
      // bird-box vs pipe-top/bottom-box
      return (
        bird.x < pipe.x + pipe.w &&
        bird.x + bird.w > pipe.x &&
        (bird.y < pipe.top || bird.y + bird.h > pipe.bottom)
      );
    }

    // ======= GAME OVER HANDLER =======
    function lose() {
      SFX.die.play();
      clearInterval(gameLoop);
      document.getElementById('overlay').classList.remove('hidden');
      pushScoreAndFetchLeaderboard();
    }

    // ======= PUSH & PULL LEADERBOARD =======
    function pushScoreAndFetchLeaderboard() {
      const user = prompt('Enter your name','Anonymous') || 'Anonymous';
      db.collection('scores')
        .add({ username: user, score, ts: firebase.firestore.FieldValue.serverTimestamp() })
        .then(fetchTopScores)
        .catch(console.error);
    }

    function fetchTopScores() {
      db.collection('scores')
        .orderBy('score','desc')
        .limit(10)
        .get()
        .then(snap => {
          const list = document.getElementById('scoresList');
          list.innerHTML = '';
          snap.forEach(doc => {
            const data = doc.data();
            const li = document.createElement('li');
            li.textContent = `${data.username}: ${data.score}`;
            list.appendChild(li);
          });
          document.getElementById('leaderboard').classList.add('active');
        })
        .catch(console.error);
    }

    // ======= DRAW & UPDATE =======
    function draw() {
      // background
      ctx.fillStyle = '#4ec0ca';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // bird
      ctx.fillStyle = '#ffeb3b';
      ctx.fillRect(bird.x, bird.y, bird.w, bird.h);

      // pipes
      ctx.fillStyle = '#5cae23';
      pipes.forEach(p => {
        ctx.fillRect(p.x, 0, p.w, p.top);
        ctx.fillRect(p.x, p.bottom, p.w, canvas.height - p.bottom);
      });

      // score
      ctx.fillStyle = '#fff';
      ctx.font = '24px Segoe UI';
      ctx.fillText(score, canvas.width/2 - 6, 50);
    }

    function update() {
      frames++;
      // bird physics
      bird.dy += gravity;
      bird.y += bird.dy;

      // floor or ceiling?
      if (bird.y + bird.h >= canvas.height || bird.y < 0) lose();

      // pipe movement & collision
      pipes.forEach((p, i) => {
        p.x -= gameSpeed;
        if (!p.passed && p.x + p.w < bird.x) {
          score++; p.passed = true; SFX.point.play();
        }
        if (isCollide(p)) {
          SFX.hit.play();
          lose();
        }
        if (p.x + p.w < 0) pipes.splice(i, 1);
      });

      // spawn new pipes
      if (frames % 100 === 0) spawnPipe();
    }

    function loop() {
      update();
      draw();
    }

    // ======= START & RESTART =======
    let gameLoop = setInterval(loop, 1000/60);
    document.getElementById('restart').onclick = () => {
      // reset everything
      bird = { x: 60, y: 150, w: 34, h: 24, dy: 0 };
      pipes.length = 0; frames = 0; score = 0;
      document.getElementById('overlay').classList.add('hidden');
      if (gameLoop) clearInterval(gameLoop);
      gameLoop = setInterval(loop, 1000/60);
    };

    // ======= MODAL CONTROLS =======
    document.getElementById('viewLeaderboard').onclick = fetchTopScores;
    document.getElementById('closeModal').onclick = () =>
      document.getElementById('leaderboard').classList.remove('active');
  </script>
</body>
</html>
