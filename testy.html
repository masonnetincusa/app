<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flappy Bird Recreated – Test Mode</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    html, body {
      width:100%; height:100%; overflow:hidden;
      background:#000; color:#fff; font-family:Arial,sans-serif;
    }
    button, input { font-family:inherit }
    .hidden { display:none !important }
    .overlay {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex; align-items:center; justify-content:center;
      z-index:100;
    }
    .panel {
      background:#111; padding:20px; border-radius:8px;
      width:320px; max-width:90%; text-align:center;
      border:2px solid transparent;
    }
    .panel button {
      width:100%; background:red; color:#fff; border:none;
      font-size:20px; padding:16px; margin:12px 0;
      cursor:pointer; border-radius:4px;
    }
    .panel button:hover { background:#d10000 }

    /* Expand Leaderboard */
    #leaderOverlay .panel {
      width:400px; max-width:95%; border-color:red;
    }
    .scroll-list {
      max-height:240px; overflow-y:auto;
      background:#222; padding:8px; border-radius:4px;
      margin:12px 0; font-family:'Press Start 2P',monospace;
      font-size:14px; color:#fff; text-align:left;
    }
    .scroll-list div {
      display:flex; justify-content:space-between;
      align-items:center; gap:16px; padding:8px 0;
      border-bottom:1px solid #333;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Test button */
    #testBtn { display:none; }

    /* Loading overlay */
    #testLoadingOverlay .panel { border-color:red }
    #loadingStatus { margin:12px 0; }
    #loadingTime { font-size:12px; color:#aaa; }
    #loadingProgress {
      background:#444; height:10px; border-radius:4px; overflow:hidden;
      margin-top:8px;
    }
    #loadingBar {
      background:red; width:0%; height:100%; transition:width .3s;
    }
  </style>
</head>
<body>

  <!-- MAIN MENU -->
  <div id="menuOverlay" class="overlay">
    <div class="panel">
      <img src="https://app.masonnet.org/fbrc.png" alt="Flappy Bird" style="width:100%;max-width:280px;margin-bottom:20px;"/>
      <button id="startBtn">Start</button>
      <button id="leaderBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
      <button id="testBtn">Test (INTERNAL ONLY)</button>
    </div>
  </div>

  <!-- PROFILE CARD -->
  <div id="profileCard">
    <div id="pc-collapsed">
      <img id="pc-avatar" src="https://app.masonnet.org/default-avatar.png" alt="Avatar" style="width:48px;height:48px;border-radius:50%"/>
    </div>
    <div id="pc-options">
      <button id="pc-authBtn">Sign In</button>
      <button id="pc-searchBtn">Search Profiles…</button>
    </div>
  </div>

  <!-- Overlays: login, search, leader, settings, pause, gameover, name, sfx -->
  <div id="loginOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="searchOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="leaderOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="settingsOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="pauseOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="gameoverOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="nameOverlay" class="overlay hidden"><div class="panel">…</div></div>
  <div id="sfxPopup" class="overlay hidden"><div class="panel">…</div></div>

  <!-- TEST LOADING OVERLAY -->
  <div id="testLoadingOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Running Diagnostics…</h2>
      <div id="loadingStatus">Initializing tests…</div>
      <div id="loadingTime">Estimated time remaining: --s</div>
      <div id="loadingProgress"><div id="loadingBar"></div></div>
    </div>
  </div>

  <!-- TEST REPORT OVERLAY -->
  <div id="testOverlay" class="overlay hidden">
    <div class="panel" style="border-color:red">
      <h2>🧪 Diagnostics Report</h2>
      <div id="testReport" class="scroll-list" style="max-height:300px;"></div>
      <button id="testClose">Close</button>
    </div>
  </div>

  <!-- CANVAS & PAUSE BUTTON -->
  <canvas id="canvas"></canvas>
  <button id="pauseBtn">Pause</button>

  <!-- FIREBASE SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

  <script>
  // === TEST MODE FLAG ===
  window.TEST_MODE = true;

  document.addEventListener('DOMContentLoaded', () => {
    const $ = id => document.getElementById(id);
    const overlays = [
      'menuOverlay','loginOverlay','searchOverlay','leaderOverlay',
      'settingsOverlay','pauseOverlay','gameoverOverlay','nameOverlay',
      'sfxPopup','testLoadingOverlay','testOverlay'
    ];
    let gameState = 'menu', bird, pipes = [], score = 0, frame = 0, rafId, collided = false;
    const gravity = .25, flapPower = -6, speed = 2;

    // === CORE FUNCTIONS ===
    function hideAll() {
      overlays.forEach(id => $(id)?.classList.add('hidden'));
    }
    function showOverlay(id) {
      if ((id==='sfxPopup'||id==='nameOverlay') && gameState!=='dying') return;
      hideAll();
      if (id) {
        $(id)?.classList.remove('hidden');
        $('canvas')?.style.setProperty('display','none');
        $('pauseBtn')?.style.setProperty('display','none');
      } else {
        $('canvas')?.style.setProperty('display','block');
        $('pauseBtn')?.style.setProperty('display','block');
      }
    }
    function bind(id, ev, fn) {
      const el = $(id);
      if (el) el.addEventListener(ev, fn);
    }

    // === FIREBASE INIT ===
    const firebaseConfig = {
      apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain: "masonnet-app-official.firebaseapp.com",
      databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();
    const lbRef = db.ref("leaderboard");
    const adminEmail = 'admin@masonnet.org';

    // === CANVAS SETUP ===
    const canvas = $('canvas'), ctx = canvas.getContext('2d');
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', resize); resize();

    // === BIRD & GAME LOOP ===
    class Bird { /* … existing code … */ }
    function spawnPipe(){ /* … */ }
    function loop(){ /* … */ }
    function startGame(){ /* … */ }
    function endGame(){ /* … */ }

    // === BASIC UI BINDINGS ===
    bind('startBtn','click', startGame);
    bind('pauseBtn','click', ()=>{ /* pause logic */ });
    bind('resumeBtn','click', ()=>{ /* resume logic */ });
    bind('leaderBtn','click', ()=>{ /* live leaderboard */ });
    bind('settingsBtn','click', ()=> showOverlay('settingsOverlay'));
    bind('hubBtn','click', ()=> window.location.href='https://app.masonnet.org/flappybirdhub');
    // … other binds …

    // === TEST BUTTON VISIBILITY ===
    if (window.TEST_MODE) {
      const t = $('testBtn');
      if (t) t.style.display = 'block';
    }

    // === DIAGNOSTICS WORKFLOW ===
    bind('testBtn','click', async () => {
      const pwd = prompt('Enter admin password:');
      if (!pwd) return alert('Password required');
      try {
        await auth.signInWithEmailAndPassword(adminEmail, pwd);
      } catch {
        return alert('Invalid admin credentials');
      }
      await runDiagnostics();
    });
    bind('testClose','click', () => {
      showOverlay('menuOverlay');
      auth.signOut().catch(()=>{});
    });

    async function runDiagnostics() {
      const report = $('testReport');
      const status = $('loadingStatus');
      const timeEl = $('loadingTime');
      const bar = $('loadingBar');
      const tests = [];
      let passed = 0;

      // Define tests
      tests.push({
        label: 'Canvas exists',
        fn: () => !!$('canvas')
      });
      tests.push({
        label: 'Pause button exists',
        fn: () => !!$('pauseBtn')
      });
      tests.push({
        label: 'Overlay system',
        fn: () => typeof showOverlay === 'function'
      });
      tests.push({
        label: 'startGame defined',
        fn: () => typeof startGame === 'function'
      });
      tests.push({
        label: 'Firebase initialized',
        fn: () => !!firebase.app().name
      });
      tests.push({
        label: 'Leaderboard fetch',
        fn: async () => {
          const snap = await lbRef.limitToLast(1).once('value');
          return snap.exists();
        }
      });
      tests.push({
        label: 'Login overlay inputs',
        fn: () => !!$('loginEmail') && !!$('loginPass')
      });
      tests.push({
        label: 'Search overlay input',
        fn: () => !!$('searchInput') && !!$('searchResults')
      });
      tests.push({
        label: 'Settings toggles',
        fn: () => !!$('soundToggle') && !!$('darkToggle') && !!$('skipToggle')
      });
      tests.push({
        label: 'Profile card toggle',
        fn: () => !!$('profileCard')
      });
      tests.push({
        label: 'Pause menu overlay',
        fn: () => !!$('pauseOverlay')
      });
      tests.push({
        label: 'Image assets load',
        fn: () => {
          return Promise.all([
            loadImage('https://app.masonnet.org/bird.png'),
            loadImage('https://app.masonnet.org/pipe-green.png')
          ]).then(() => true).catch(()=>false);
        }
      });
      tests.push({
        label: 'Sound assets load',
        fn: () => {
          return Promise.all([
            loadAudio('https://app.masonnet.org/flap.mp3'),
            loadAudio('https://app.masonnet.org/point.mp3')
          ]).then(() => true).catch(()=>false);
        }
      });
      tests.push({
        label: 'Design consistency (leader panel width)',
        fn: () => {
          const w = parseInt(getComputedStyle($('leaderOverlay').querySelector('.panel')).width);
          return w >= 380;
        }
      });

      // Show loading overlay
      showOverlay('testLoadingOverlay');

      // Run tests sequentially
      const total = tests.length;
      const start = Date.now();
      report.innerHTML = '';
      for (let i = 0; i < total; i++) {
        const t = tests[i];
        status.textContent = `Testing: ${t.label}`;
        const result = await Promise.resolve(t.fn());
        const div = document.createElement('div');
        div.innerHTML = result
          ? `✅ ${t.label}`
          : `❌ ${t.label}`;
        report.appendChild(div);
        if (result) passed++;
        // update progress
        const pct = Math.round(((i+1)/total)*100);
        bar.style.width = pct + '%';
        // update time estimate
        const elapsed = (Date.now() - start)/1000;
        const rem = Math.max(0,(elapsed/ (i+1) * (total-(i+1))).toFixed(1));
        timeEl.textContent = `Estimated time remaining: ${rem}s`;
      }

      status.textContent = `Diagnostics complete: ${passed}/${total} passed`;
      setTimeout(() => showOverlay('testOverlay'), 500);
    }

    function loadImage(src) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res();
        img.onerror = () => rej();
        img.src = src;
      });
    }

    function loadAudio(src) {
      return new Promise((res, rej) => {
        const a = new Audio(src);
        a.oncanplaythrough = () => res();
        a.onerror = () => rej();
      });
    }

    // Initial state
    showOverlay('menuOverlay');
  });
  </script>
</body>
</html>
