<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flappy Bird â€“ MasonNet Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <style>
    /* ------------------------------------------------------------
       BASE
    ------------------------------------------------------------ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: 'Press Start 2P', monospace;
    }
    button, input {
      font-family: inherit;
    }
    .hidden { display: none !important; }

    /* ------------------------------------------------------------
       OVERLAYS & PANELS
    ------------------------------------------------------------ */
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .panel {
      background: #111;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      max-width: 90%;
      text-align: center;
      border: 2px solid transparent;
    }
    .panel h2 {
      margin-bottom: 16px;
      font-size: 18px;
    }
    .panel button {
      width: 100%;
      background: red;
      color: #fff;
      border: none;
      font-size: 16px;
      padding: 12px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 4px;
    }
    .panel button:hover {
      background: #d10000;
    }

    /* ------------------------------------------------------------
       GLOBAL INPUT STYLES
    ------------------------------------------------------------ */
    input {
      width: calc(100% - 20px);
      padding: 10px;
      margin: 10px 0;
      font-size: 14px;
      border: 2px solid #555;
      border-radius: 4px;
      background: #222;
      color: #fff;
    }
    input:focus {
      outline: none;
      border-color: red;
    }

    /* ------------------------------------------------------------
       MAIN MENU
    ------------------------------------------------------------ */
    #menuOverlay .panel img {
      width: 100%;
      max-width: 280px;
      margin-bottom: 20px;
    }

    /* ------------------------------------------------------------
       PROFILE CARD
    ------------------------------------------------------------ */
    #profileCard {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 64px;
      height: 64px;
      background: rgba(0,0,0,0.7);
      border: 2px solid red;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      z-index: 110;
      transition: width .2s, height .2s;
    }
    #profileCard.expanded {
      width: 240px;
      height: auto;
    }
    #pc-collapsed {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 8px;
    }
    #pc-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }
    #pc-options {
      display: none;
      flex-direction: column;
      background: rgba(0,0,0,0.85);
      padding: 8px;
    }
    #profileCard.expanded #pc-options {
      display: flex;
    }
    #pc-options button {
      margin: 6px 0;
      font-size: 14px;
      padding: 8px;
    }

    /* ------------------------------------------------------------
       LEADERBOARD OVERLAY
    ------------------------------------------------------------ */
    #leaderOverlay .panel {
      width: 400px;
      max-width: 95%;
      border-color: red;
    }
    #leaderOverlay h2 {
      margin-bottom: 12px;
      font-size: 18px;
    }
    .scroll-list {
      background: #222;
      padding: 8px;
      border-radius: 4px;
      font-size: 14px;
      text-align: left;
      color: #fff;
      max-height: 240px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .scroll-list div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #333;
    }
    /* Score right-aligned */
    .scroll-list div span:last-child {
      text-align: right;
      flex: 1;
    }

    /* ------------------------------------------------------------
       OTHER OVERLAYS
    ------------------------------------------------------------ */
    /* Settings, pause, gameover, name, sfx are identical panels */
    #settingsOverlay .panel button, 
    #pauseOverlay .panel button,
    #gameoverOverlay .panel button,
    #nameOverlay .panel button {
      margin: 8px 0;
    }

    /* ------------------------------------------------------------
       PAUSE BUTTON
    ------------------------------------------------------------ */
    #pauseBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: red;
      color: #fff;
      border: none;
      padding: 12px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      z-index: 20;
    }
    #pauseBtn:hover {
      background: #d10000;
    }

    /* ------------------------------------------------------------
       TEST LOADING OVERLAY
    ------------------------------------------------------------ */
    #testLoadingOverlay .panel {
      border-color: red;
    }
    #loadingStatus {
      margin: 12px 0;
      font-size: 14px;
    }
    #loadingTime {
      font-size: 12px;
      color: #aaa;
    }
    #loadingProgress {
      background: #444;
      height: 10px;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    #loadingBar {
      background: red;
      width: 0%;
      height: 100%;
      transition: width .3s;
    }

    /* ------------------------------------------------------------
       TEST REPORT OVERLAY (ENLARGED)
    ------------------------------------------------------------ */
    #testOverlay .panel {
      width: 600px;
      max-width: 95%;
      height: 80%;
      overflow: auto;
      border-color: red;
    }
    #testReport {
      background: #222;
      padding: 8px;
      border-radius: 4px;
      max-height: 60vh;
      overflow-y: auto;
      text-align: left;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>

  <!-- MAIN MENU OVERLAY -->
  <div id="menuOverlay" class="overlay">
    <div class="panel">
      <img src="https://app.masonnet.org/fbrc.png" alt="Flappy Bird"/>
      <button id="startBtn">Start</button>
      <button id="leaderBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
      <button id="testBtn">Test (INTERNAL ONLY)</button>
    </div>
  </div>

  <!-- PROFILE CARD -->
  <div id="profileCard">
    <div id="pc-collapsed">
      <img id="pc-avatar" src="https://app.masonnet.org/default-avatar.png" alt="Avatar"/>
    </div>
    <div id="pc-options">
      <button id="pc-authBtn">Sign In</button>
      <button id="pc-feedbackBtn">Submit Feedback</button>
      <button id="pc-settingsBtn">Account Settings</button>
      <button id="pc-adminBtn">Admin</button>
      <button id="pc-searchBtn">Search Profilesâ€¦</button>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <label>
        <input id="loginRemember" type="checkbox"/>
        Remember me
      </label>
      <button id="loginSubmit">Submit</button>
      <button id="loginCancel">Cancel</button>
    </div>
  </div>

  <!-- SEARCH OVERLAY -->
  <div id="searchOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Search Profiles</h2>
      <input id="searchInput" placeholder="Username"/>
      <button id="searchSubmit">Search</button>
      <button id="searchCancel">Cancel</button>
      <div id="searchResults" class="scroll-list"></div>
    </div>
  </div>

  <!-- LEADERBOARD OVERLAY -->
  <div id="leaderOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Leaderboard (Top 10)</h2>
      <div id="leaderList" class="scroll-list"></div>
      <button id="leaderClose">Back</button>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->
  <div id="settingsOverlay" class="overlay hidden">
    <div class="panel">
      <button id="soundToggle">ðŸ”Š Sound: On</button>
      <button id="darkToggle">ðŸŒ™ Dark Mode: Off</button>
      <button id="skipToggle">ðŸš€ Skip to GO: Off</button>
      <button id="settingsCloseBtn">Close</button>
    </div>
  </div>

  <!-- PAUSE OVERLAY -->
  <div id="pauseOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="pauseMenuBtn">Main Menu</button>
    </div>
  </div>

  <!-- GAME OVERLAY -->
  <div id="gameoverOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button id="restartBtn">Restart</button>
      <button id="goMenuBtn">Main Menu</button>
    </div>
  </div>

  <!-- NEW HIGH SCORE OVERLAY -->
  <div id="nameOverlay" class="overlay hidden">
    <div class="panel">
      <h2>ðŸŽ‰ New High Score!</h2>
      <p>Score: <span id="newScore">0</span></p>
      <input id="nameInput" placeholder="Enter your nameâ€¦"/>
      <button id="saveNameBtn">Save</button>
      <button id="skipNameBtn">Skip</button>
    </div>
  </div>

  <!-- SFX POPUP -->
  <div id="sfxPopup" class="overlay hidden">
    <div class="panel">
      <p>Playing sound effectsâ€¦</p>
    </div>
  </div>

  <!-- TEST LOADING OVERLAY -->
  <div id="testLoadingOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Running Diagnosticsâ€¦</h2>
      <div id="loadingStatus">Initializing testsâ€¦</div>
      <div id="loadingTime">Estimated time remaining: --s</div>
      <div id="loadingProgress"><div id="loadingBar"></div></div>
    </div>
  </div>

  <!-- TEST REPORT OVERLAY -->
  <div id="testOverlay" class="overlay hidden">
    <div class="panel">
      <h2>ðŸ§ª Diagnostics Report</h2>
      <div id="testReport" class="scroll-list"></div>
      <button id="testClose">Close</button>
    </div>
  </div>

  <!-- CANVAS & PAUSE BUTTON -->
  <canvas id="canvas"></canvas>
  <button id="pauseBtn">Pause</button>

  <!-- FIREBASE SDKS -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

  <script>
  // ================================
  //  TEST MODE FLAG
  // ================================
  window.TEST_MODE = true;

  // ================================
  //  DOM UTILITIES
  // ================================
  const $ = id => document.getElementById(id);

  const overlays = [
    'menuOverlay','loginOverlay','searchOverlay','leaderOverlay',
    'settingsOverlay','pauseOverlay','gameoverOverlay','nameOverlay',
    'sfxPopup','testLoadingOverlay','testOverlay'
  ];
  function hideAll() {
    overlays.forEach(id => $(id)?.classList.add('hidden'));
  }
  function showOverlay(id) {
    if ((id==='sfxPopup'||id==='nameOverlay') && gameState!=='dying') return;
    hideAll();
    if (id) {
      $(id).classList.remove('hidden');
      $('canvas').style.display = 'none';
      $('pauseBtn').style.display = 'none';
    } else {
      $('canvas').style.display = 'block';
      $('pauseBtn').style.display = 'block';
    }
  }
  function bind(id, ev, fn) {
    const el = $(id);
    if (el) el.addEventListener(ev, fn);
  }

  // ================================
  //  FIREBASE INITIALIZATION
  // ================================
  const firebaseConfig = {
    apiKey:    "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
    authDomain:"masonnet-app-official.firebaseapp.com",
    databaseURL:"https://masonnet-app-official-default-rtdb.firebaseio.com",
    projectId: "masonnet-app-official"
  };
  firebase.initializeApp(firebaseConfig);
  const auth     = firebase.auth();
  const db       = firebase.database();
  const lbRef    = db.ref("leaderboard");
  const rolesRef = db.ref("roles");

  const adminEmail = 'admin@masonnet.org';
  const adminUID   = 'Y4ZoHRQaIrVhdvZr15Ebz90Byh62';
  const userEmail  = 'user@masonnet.org';
  const userUID    = 'YQZhZsoC4OUd7oa11APl3D00gjz2';

  let currentUser = null;
  let currentRole = 'user';

  // ================================
  //  PROFILE CARD LOGIC
  // ================================
  const pc = $('profileCard');
  // Toggle expand/collapse
  pc.addEventListener('click', e => {
    e.stopPropagation();
    pc.classList.toggle('expanded');
  });
  // Collapse when clicking elsewhere
  document.addEventListener('click', () => {
    if (pc.classList.contains('expanded')) {
      pc.classList.remove('expanded');
    }
  });

  // Render Profile Card items based on auth + role
  function renderProfileCard() {
    const opts = $('pc-options');
    opts.innerHTML = '';

    if (!currentUser) {
      // Not signed in â†’ show Sign In
      const btn = document.createElement('button');
      btn.id = 'pc-authBtn';
      btn.textContent = 'Sign In';
      btn.addEventListener('click', () => showOverlay('loginOverlay'));
      opts.appendChild(btn);
      return;
    }

    // Signed in â†’ build menu
    const items = [
      { id:'sign-out',       label:'Sign Out',       fn:() => auth.signOut() },
      { id:'submit-feedback',label:'Submit Feedback',fn:() => showOverlay('sfxPopup') },
      { id:'account-settings',label:'Account Settings',fn:() => showOverlay('settingsOverlay') },
      { id:'search-profiles',label:'Search Profilesâ€¦',fn:() => showOverlay('searchOverlay') }
    ];
    // Admin-only
    if (currentRole==='admin') {
      items.splice(3,0,{ id:'admin', label:'Admin', fn:()=> showOverlay('testLoadingOverlay') });
    }

    items.forEach(it => {
      const b = document.createElement('button');
      b.id = `pc-${it.id}`;
      b.textContent = it.label;
      b.addEventListener('click', it.fn);
      opts.appendChild(b);
    });
  }

  // React to auth changes
  auth.onAuthStateChanged(async u => {
    currentUser = u;
    if (!u) {
      currentRole = 'user';
      renderProfileCard();
      return;
    }
    // Fetch role from Realtime DB
    const snap = await rolesRef.child(u.uid).once('value');
    currentRole = snap.val() === 'admin' ? 'admin' : 'user';
    renderProfileCard();
  });

  // ================================
  //  LOGIN HANDLERS
  // ================================
  bind('loginSubmit','click', async () => {
    const email = $('loginEmail').value.trim();
    const pass  = $('loginPass').value.trim();
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      showOverlay('menuOverlay');
    } catch (err) {
      alert('Login failed: ' + err.message);
    }
  });
  bind('loginCancel','click', ()=> showOverlay('menuOverlay'));

  // ================================
  //  SEARCH HANDLERS
  // ================================
  bind('searchSubmit','click', ()=>{
    const q = $('searchInput').value.trim();
    const res = $('searchResults');
    res.innerHTML = q ? `<div>${q}: search result</div>` : '';
    showOverlay('searchOverlay');
  });
  bind('searchCancel','click', ()=> showOverlay('menuOverlay'));

  // ================================
  //  SETTINGS TOGGLES
  // ================================
  bind('soundToggle','click', ()=>{
    const b=$('soundToggle');
    b.textContent = b.textContent.includes('On') ? 'ðŸ”‡ Sound: Off' : 'ðŸ”Š Sound: On';
  });
  bind('darkToggle','click', ()=>{
    document.body.classList.toggle('dark-mode');
    const b=$('darkToggle');
    b.textContent = b.textContent.includes('Off') ? 'ðŸŒ™ Dark Mode: On' : 'â˜€ï¸ Light Mode: Off';
  });
  bind('skipToggle','click', ()=>{
    const b=$('skipToggle');
    b.textContent = b.textContent.includes('Off') ? 'ðŸš€ Skip to GO: On' : 'ðŸš€ Skip to GO: Off';
  });
  bind('settingsCloseBtn','click', ()=> showOverlay('menuOverlay'));

  // ================================
  //  CANVAS + GAME LOGIC
  // ================================
  let gameState = 'menu';
  const gravity = .25, flapPower = -6, speed = 2;
  let bird, pipes = [], score = 0, frame = 0, rafId, collided = false;
  const canvas = $('canvas'), ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  window.addEventListener('resize', resize); resize();

  class Bird {
    constructor(){
      this.x = 50; this.y = canvas.height*0.4;
      this.vy = 0; this.w = 34; this.h = 24;
    }
    flap(){ this.vy = flapPower; }
    update(){
      this.vy += gravity; this.y += this.vy;
      if(this.y<0) this.y=0;
      if(this.y+this.h>canvas.height) this.die();
    }
    draw(){
      ctx.fillStyle='yellow';
      ctx.fillRect(this.x,this.y,this.w,this.h);
    }
    collides(p){
      return !(this.x+this.w<p.x ||
               this.x>p.x+p.w ||
               this.y+this.h<p.top ||
               this.y>p.bottom);
    }
    die(){
      if(gameState!=='playing'||collided) return;
      collided=true; gameState='dying';
      cancelAnimationFrame(rafId);
      showOverlay('sfxPopup');
      setTimeout(()=>{ showOverlay(); endGame(); }, 800);
    }
  }

  function spawnPipe(){
    const gap = 120;
    const top = 20 + Math.random()*(canvas.height-gap-40);
    pipes.push({ x: canvas.width, w: 60, top, bottom: top+gap, passed: false });
  }

  function loop(){
    if(gameState!=='playing') return;
    rafId = requestAnimationFrame(loop);
    frame++; ctx.clearRect(0,0,canvas.width,canvas.height);
    pipes.forEach((p,i)=>{
      p.x -= speed;
      ctx.fillStyle='green';
      ctx.fillRect(p.x, 0, p.w, p.top);
      ctx.fillRect(p.x, p.bottom, p.w, canvas.height-p.bottom);
      if(!p.passed && bird.x>p.x+p.w){ p.passed=true; score++; }
      if(bird.collides(p)) bird.die();
      if(p.x+p.w<0) pipes.splice(i,1);
    });
    bird.update(); bird.draw();
    if(frame%150===0) spawnPipe();
    ctx.fillStyle='#fff';
    ctx.font='32px "Press Start 2P"';
    ctx.fillText(score, 20, 50);
  }

  function startGame(){
    if(gameState==='playing') return;
    gameState='playing'; pipes=[]; score=0; frame=0; collided=false;
    bird = new Bird(); hideAll(); $('pauseBtn').style.display='block'; loop();
  }

  function endGame(){
    if(gameState!=='dying') return;
    gameState='menu';
    $('finalScore').textContent = score;
    showOverlay('gameoverOverlay');
  }

  window.addEventListener('mousedown', ()=> bird?.flap());
  window.addEventListener('touchstart', ()=> bird?.flap(), { passive: true });

  bind('startBtn','click', startGame);
  bind('pauseBtn','click', ()=>{
    if(gameState==='playing'){
      cancelAnimationFrame(rafId);
      gameState='paused';
      showOverlay('pauseOverlay');
    }
  });
  bind('resumeBtn','click', ()=>{ gameState='playing'; hideAll(); loop(); });
  bind('pauseMenuBtn','click', ()=> showOverlay('menuOverlay'));
  bind('restartBtn','click', startGame);
  bind('goMenuBtn','click', ()=> showOverlay('menuOverlay'));
  bind('hubBtn','click', ()=> window.location.href='https://app.masonnet.org/flappybirdhub');

  // ================================
  //  LEADERBOARD LOGIC
  // ================================
  bind('leaderBtn','click', ()=>{
    const list = $('leaderList');
    list.innerHTML = '';
    lbRef.orderByChild('score').limitToLast(10)
      .once('value', snap=>{
        const arr = Object.values(snap.val()||{}).sort((a,b)=>b.score-a.score);
        arr.slice(0,10).forEach(p=>{
          const div = document.createElement('div');
          div.innerHTML = `<span>${p.name}</span><span>${p.score}</span>`;
          list.appendChild(div);
        });
        showOverlay('leaderOverlay');
      });
  });
  bind('leaderClose','click', ()=> showOverlay('menuOverlay'));

  // ================================
  //  TEST MENU & DIAGNOSTICS
  // ================================
  if(window.TEST_MODE){
    const t = $('testBtn');
    if(t) t.style.display = 'block';
  }

  bind('testBtn','click', async ()=>{
    const pwd = prompt('Admin password:');
    if(!pwd) return;
    try {
      const cred = await auth.signInWithEmailAndPassword(adminEmail, pwd);
      const snap = await rolesRef.child(cred.user.uid).once('value');
      if(snap.val()!=='admin') throw new Error();
    } catch {
      return alert('Invalid admin credentials');
    }
    runDiagnostics();
  });

  bind('testClose','click', ()=>{
    showOverlay('menuOverlay');
    auth.signOut();
  });

  async function runDiagnostics(){
    const report = $('testReport');
    const status = $('loadingStatus');
    const timeEl = $('loadingTime');
    const bar    = $('loadingBar');
    const tests  = [];
    let passed = 0;

    function add(label, fn){
      tests.push({ label, fn });
    }

    // CORE TESTS
    add('Canvas exists', ()=>!!$('canvas'));
    add('Overlay system', ()=>typeof showOverlay==='function');
    add('startGame defined', ()=>typeof startGame==='function');
    add('Firebase initialized', ()=>!!firebase.app().name);

    // ROLE STRUCTURE
    add('Roles node exists',async ()=>{
      const r = await rolesRef.once('value');
      return r.exists();
    });

    // LEADERBOARD TESTS
    add('Leaderboard title correct', ()=>{
      const h = $('#leaderOverlay .panel h2');
      return h && h.textContent==='Leaderboard (Top 10)';
    });
    add('Leaderboard layout (scores right)', ()=>{
      const div = $('leaderList .scroll-list div');
      if(!div) return false;
      const spans = div.querySelectorAll('span');
      const rightAlign = window.getComputedStyle(spans[1]).textAlign==='right';
      return rightAlign;
    });
    add('Leaderboard fetch works', async ()=>{
      const s = await lbRef.limitToLast(1).once('value');
      return s.exists();
    });

    // LOGIN INPUTS
    add('Login inputs style', ()=>{
      const ie = $('loginEmail'), ip = $('loginPass');
      if(!ie||!ip) return false;
      const se = getComputedStyle(ie), sp = getComputedStyle(ip);
      return ie.type==='email'
        && se.padding.includes('10px')
        && parseInt(se.fontSize)>=14
        && ip.type==='password'
        && sp.padding.includes('10px')
        && parseInt(sp.fontSize)>=14;
    });

    // SIGN-IN FLOW
    add('Admin sign-in works', async ()=>{
      await auth.signInWithEmailAndPassword(adminEmail,'admin123');
      const u = auth.currentUser;
      await auth.signOut();
      return u && u.uid===adminUID;
    });

    // PROFILE CARD
    add('ProfileCard toggle works', ()=>{
      const pc = $('profileCard');
      pc.classList.remove('expanded');
      pc.click();
      const exp = pc.classList.contains('expanded');
      pc.click();
      const col = !pc.classList.contains('expanded');
      return exp && col;
    });
    add('Admin menu items count', ()=>{
      if(currentRole!=='admin') return false;
      const cnt = $('pc-options').querySelectorAll('button').length;
      return cnt===5;
    });

    // DESIGN
    add('Body background is black', ()=> getComputedStyle(document.body).backgroundColor==='rgb(0, 0, 0)');

    // IMAGE LOADS
    add('Logo loads', ()=> loadImage('https://app.masonnet.org/fbrc.png').then(()=>true).catch(()=>false));
    add('Avatar loads', ()=> loadImage('https://app.masonnet.org/default-avatar.png').then(()=>true).catch(()=>false));

    // PAUSE/RESUME
    add('Pause/resume works', async ()=>{
      showOverlay('pauseOverlay');
      hideAll();
      return true;
    });

    // RUN TESTS
    showOverlay('testLoadingOverlay');
    report.innerHTML = '';
    const total = tests.length, start = Date.now();
    for(let i=0;i<total;i++){
      status.textContent = `Testing: ${tests[i].label}`;
      let ok = false;
      try { ok = await tests[i].fn(); } catch{}
      const li = document.createElement('div');
      li.textContent = (ok?'âœ… ':'âŒ ') + tests[i].label;
      report.appendChild(li);
      if(ok) passed++;
      const pct = Math.round(((i+1)/total)*100);
      bar.style.width = pct + '%';
      const elapsed = (Date.now()-start)/1000;
      const rem = Math.max(0, ((elapsed/(i+1))*(total-(i+1))).toFixed(1));
      timeEl.textContent = `Estimated time remaining: ${rem}s`;
    }
    status.textContent = `Diagnostics complete: ${passed}/${total} passed`;
    setTimeout(()=> showOverlay('testOverlay'), 500);
  }

  function loadImage(src){
    return new Promise((res, rej)=>{
      const img = new Image();
      img.onload = res; img.onerror = rej;
      img.src = src;
    });
  }
  function loadAudio(src){
    return new Promise((res, rej)=>{
      const a = new Audio(src);
      a.oncanplaythrough = res; a.onerror = rej;
      a.src = src;
    });
  }

  // INITIAL SHOW MENU
  showOverlay('menuOverlay');
  </script>
</body>
</html>
