<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flappy Bird – Test Mode</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body {
      width:100%; height:100%; overflow:hidden;
      background:#000; color:#fff; font-family:Arial,sans-serif;
    }
    button, input { font-family:inherit; }
    .hidden { display:none!important; }

    /* inputs */
    input {
      width:calc(100% - 20px); margin:12px 0; padding:10px;
      font-size:16px; border:2px solid #555; border-radius:4px;
      background:#222; color:#fff;
    }
    input:focus { outline:none; border-color:red; }

    /* overlays */
    .overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85);
      display:flex; align-items:center; justify-content:center;
      z-index:100;
    }
    .panel {
      background:#111; padding:20px; border-radius:8px;
      width:320px; max-width:90%; text-align:center;
      border:2px solid transparent;
    }
    .panel button {
      width:100%; background:red; color:#fff; border:none;
      font-size:20px; padding:16px; margin:12px 0;
      cursor:pointer; border-radius:4px;
    }
    .panel button:hover { background:#d10000; }

    /* leaderboard */
    #leaderOverlay .panel { width:400px; max-width:95%; border-color:red; }
    .scroll-list {
      max-height:240px; overflow-y:auto;
      background:#222; padding:8px; border-radius:4px;
      margin:12px 0; font-family:'Press Start 2P',monospace;
      font-size:14px; text-align:left;
    }

    /* profile card */
    #profileCard {
      position:absolute; top:20px; right:20px;
      width:64px; height:64px; background:rgba(0,0,0,0.7);
      border:2px solid red; border-radius:8px;
      overflow:hidden; cursor:pointer; z-index:110;
      transition:width .2s,height .2s;
    }
    #profileCard.expanded { width:220px; height:auto; }
    #pc-collapsed {
      display:flex; align-items:center; justify-content:center;
      width:100%; height:100%; padding:8px;
    }
    #pc-avatar { width:48px; height:48px; border-radius:50%; }
    #pc-options {
      display:none; flex-direction:column;
      background:rgba(0,0,0,0.85); padding:8px;
    }
    #profileCard.expanded #pc-options { display:flex; }
    #pc-options button { margin:6px 0; font-size:14px; padding:8px; }

    /* pause button */
    #pauseBtn {
      position:absolute; top:20px; right:20px;
      background:red; color:#fff; border:none;
      padding:16px; font-size:20px;
      cursor:pointer; border-radius:4px; z-index:20;
    }
    #pauseBtn:hover { background:#d10000; }

    /* test overlays */
    #testBtn { display:none; }
    #testLoadingOverlay .panel { border-color:red; }
    #loadingStatus { margin:12px 0; font-size:16px; }
    #loadingTime { font-size:12px; color:#aaa; }
    #loadingProgress {
      background:#444; height:10px; border-radius:4px;
      overflow:hidden; margin-top:8px;
    }
    #loadingBar {
      background:red; width:0%; height:100%; transition:width .3s;
    }

    /* enlarged report */
    #testOverlay .panel {
      width:600px; max-width:95%; height:80%; overflow:auto;
      border-color:red;
    }
    #testReport {
      max-height:60vh; overflow-y:auto; background:#222;
      padding:8px; border-radius:4px; text-align:left;
    }
  </style>
</head>
<body>

  <!-- MAIN MENU -->
  <div id="menuOverlay" class="overlay">
    <div class="panel">
      <img src="https://app.masonnet.org/fbrc.png"
           style="width:100%; max-width:280px; margin-bottom:20px;"
           alt="Flappy Bird"/>
      <button id="startBtn">Start</button>
      <button id="leaderBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
      <button id="testBtn">Test (INTERNAL ONLY)</button>
    </div>
  </div>

  <!-- PROFILE CARD -->
  <div id="profileCard">
    <div id="pc-collapsed">
      <img id="pc-avatar"
           src="https://app.masonnet.org/default-avatar.png"
           alt="Avatar"/>
    </div>
    <div id="pc-options">
      <button id="pc-authBtn">Sign In</button>
      <button id="pc-searchBtn">Search Profiles…</button>
    </div>
  </div>

  <!-- SIGN IN -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <label><input id="loginRemember" type="checkbox"/> Remember me</label>
      <button id="loginSubmit">Submit</button>
      <button id="loginCancel">Cancel</button>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="searchOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Search Profiles</h2>
      <input id="searchInput" placeholder="Username"/>
      <button id="searchSubmit">Search</button>
      <button id="searchCancel">Cancel</button>
      <div id="searchResults" class="scroll-list"></div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Global Top 10</h2>
      <div id="leaderList" class="scroll-list"></div>
      <button id="leaderClose">Back</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsOverlay" class="overlay hidden">
    <div class="panel">
      <button id="soundToggle">🔊 Sound: On</button>
      <button id="darkToggle">🌙 Dark Mode: Off</button>
      <button id="skipToggle">🚀 Skip to GO: Off</button>
      <button id="settingsCloseBtn">Close</button>
    </div>
  </div>

  <!-- PAUSE/GAMEOVER/NAME/SFX -->
  <div id="pauseOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="pauseMenuBtn">Main Menu</button>
    </div>
  </div>
  <div id="gameoverOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button id="restartBtn">Restart</button>
      <button id="goMenuBtn">Main Menu</button>
    </div>
  </div>
  <div id="nameOverlay" class="overlay hidden">
    <div class="panel">
      <h2>🎉 New High Score!</h2>
      <p>Score: <span id="newScore">0</span></p>
      <input id="nameInput" placeholder="Enter your name…"/>
      <button id="saveNameBtn">Save</button>
      <button id="skipNameBtn">Skip</button>
    </div>
  </div>
  <div id="sfxPopup" class="overlay hidden">
    <div class="panel"><p>Playing sound effects…</p></div>
  </div>

  <!-- TEST LOADING & REPORT -->
  <div id="testLoadingOverlay" class="overlay hidden">
    <div class="panel">
      <h2>Running Diagnostics…</h2>
      <div id="loadingStatus">Initializing tests…</div>
      <div id="loadingTime">Estimated time remaining: --s</div>
      <div id="loadingProgress"><div id="loadingBar"></div></div>
    </div>
  </div>
  <div id="testOverlay" class="overlay hidden">
    <div class="panel">
      <h2>🧪 Diagnostics Report</h2>
      <div id="testReport" class="scroll-list"></div>
      <button id="testClose">Close</button>
    </div>
  </div>

  <!-- CANVAS & PAUSE BTN -->
  <canvas id="canvas"></canvas>
  <button id="pauseBtn">Pause</button>

  <!-- FIREBASE SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

  <script>
  // TEST_MODE ON
  window.TEST_MODE = true;

  document.addEventListener('DOMContentLoaded', () => {
    const $ = id=>document.getElementById(id);
    const overlays = [
      'menuOverlay','loginOverlay','searchOverlay','leaderOverlay',
      'settingsOverlay','pauseOverlay','gameoverOverlay','nameOverlay',
      'sfxPopup','testLoadingOverlay','testOverlay'
    ];

    let gameState='menu', bird, pipes=[], score=0, frame=0, rafId, collided=false;
    const gravity=.25, flapPower=-6, speed=2;

    function hideAll(){
      overlays.forEach(id=>$(id)?.classList.add('hidden'));
    }
    function showOverlay(id){
      if((id==='sfxPopup'||id==='nameOverlay')&&gameState!=='dying')return;
      hideAll();
      if(id){
        $(id).classList.remove('hidden');
        $('canvas').style.display='none';
        $('pauseBtn').style.display='none';
      } else {
        $('canvas').style.display='block';
        $('pauseBtn').style.display='block';
      }
    }
    function bind(id,ev,fn){
      const el=$(id); if(el)el.addEventListener(ev,fn);
    }

    // FIREBASE INIT
    const cfg = {
      apiKey:"AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain:"masonnet-app-official.firebaseapp.com",
      databaseURL:"https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId:"masonnet-app-official"
    };
    firebase.initializeApp(cfg);
    const auth = firebase.auth();
    const db   = firebase.database();
    const lbRef   = db.ref("leaderboard");
    const rolesRef= db.ref("roles");
    const adminEmail='admin@masonnet.org', adminUID='Y4ZoHRQaIrVhdvZr15Ebz90Byh62';
    const userEmail='user@masonnet.org',  userUID='YQZhZsoC4OUd7oa11APl3D00gjz2';

    // PROFILE-CARD TOGGLE
    const pc = $('profileCard');
    pc.addEventListener('click', e=>{
      e.stopPropagation();
      pc.classList.toggle('expanded');
    });
    document.addEventListener('click', ()=>{
      if(pc.classList.contains('expanded')){
        pc.classList.remove('expanded');
      }
    });

    // AUTH BUTTON
    const pcAuthBtn = $('pc-authBtn');
    auth.onAuthStateChanged(user=>{
      if(user){
        pcAuthBtn.textContent='Sign Out';
        pcAuthBtn.onclick = ()=> auth.signOut();
      } else {
        pcAuthBtn.textContent='Sign In';
        pcAuthBtn.onclick = ()=> showOverlay('loginOverlay');
      }
    });

    // LOGIN HANDLERS
    bind('loginSubmit','click',async ()=>{
      const e=$('loginEmail').value, p=$('loginPass').value;
      try{
        await auth.signInWithEmailAndPassword(e,p);
        showOverlay('menuOverlay');
      }catch(err){
        alert(err.message);
      }
    });
    bind('loginCancel','click', ()=> showOverlay('menuOverlay'));

    // SEARCH HANDLERS
    bind('searchCancel','click', ()=> showOverlay('menuOverlay'));
    bind('searchSubmit','click', ()=>{
      const q=$('searchInput').value.trim(), res=$('searchResults');
      res.innerHTML = q? `<div>${q}: 42</div>` : '';
      showOverlay('searchOverlay');
    });

    // CANVAS & GAME
    const canvas = $('canvas'), ctx = canvas.getContext('2d');
    function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
    window.addEventListener('resize', resize); resize();

    class Bird {
      constructor(){
        this.x=50; this.y=canvas.height*0.4;
        this.vy=0; this.w=34; this.h=24;
      }
      flap(){ this.vy=flapPower; }
      update(){
        this.vy+=gravity; this.y+=this.vy;
        if(this.y<0) this.y=0;
        if(this.y+this.h>canvas.height) this.die();
      }
      draw(){
        ctx.fillStyle='yellow';
        ctx.fillRect(this.x,this.y,this.w,this.h);
      }
      collides(p){
        return !(
          this.x+this.w<p.x ||
          this.x>p.x+p.w ||
          this.y+this.h<p.top ||
          this.y>p.bottom
        );
      }
      die(){
        if(gameState!=='playing'||collided) return;
        collided=true; gameState='dying';
        cancelAnimationFrame(rafId);
        showOverlay('sfxPopup');
        setTimeout(()=>{ showOverlay(); endGame(); },800);
      }
    }

    function spawnPipe(){
      const gap=120;
      const top=20+Math.random()*(canvas.height-gap-40);
      pipes.push({ x:canvas.width, w:60, top, bottom:top+gap, passed:false });
    }

    function loop(){
      if(gameState!=='playing') return;
      rafId=requestAnimationFrame(loop);
      frame++;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      pipes.forEach((p,i)=>{
        p.x-=speed;
        ctx.fillStyle='green';
        ctx.fillRect(p.x,0,p.w,p.top);
        ctx.fillRect(p.x,p.bottom,p.w,canvas.height-p.bottom);
        if(!p.passed && bird.x>p.x+p.w){
          p.passed=true; score++;
        }
        if(bird.collides(p)) bird.die();
        if(p.x+p.w<0) pipes.splice(i,1);
      });

      bird.update();
      bird.draw();
      if(frame%150===0) spawnPipe();
      ctx.fillStyle='#fff';
      ctx.font='32px "Press Start 2P"';
      ctx.fillText(score,20,50);
    }

    function startGame(){
      if(gameState==='playing') return;
      gameState='playing'; pipes=[]; score=0; frame=0; collided=false;
      bird=new Bird(); hideAll(); $('pauseBtn').style.display='block'; loop();
    }
    function endGame(){
      if(gameState!=='dying') return;
      gameState='menu'; $('finalScore').textContent=score; showOverlay('gameoverOverlay');
    }

    window.addEventListener('mousedown',()=>bird?.flap());
    window.addEventListener('touchstart',()=>bird?.flap(),{passive:true});

    // UI BINDINGS
    bind('startBtn','click', startGame);
    bind('pauseBtn','click', ()=>{
      if(gameState==='playing'){
        cancelAnimationFrame(rafId);
        gameState='paused';
        showOverlay('pauseOverlay');
      }
    });
    bind('resumeBtn','click', ()=>{ gameState='playing'; hideAll(); loop(); });
    bind('pauseMenuBtn','click', ()=> showOverlay('menuOverlay'));
    bind('restartBtn','click', startGame);
    bind('goMenuBtn','click', ()=> showOverlay('menuOverlay'));

    bind('leaderBtn','click', ()=>{
      const list=$('leaderList'); list.innerHTML='';
      lbRef.orderByChild('score').limitToLast(10).once('value',snap=>{
        Object.values(snap.val()||{})
          .sort((a,b)=>b.score-a.score)
          .slice(0,10)
          .forEach(p=>{
            const r=document.createElement('div');
            r.innerHTML=`<span>${p.name}</span><span>${p.score}</span>`;
            list.appendChild(r);
          });
        showOverlay('leaderOverlay');
      });
    });
    bind('leaderClose','click', ()=> showOverlay('menuOverlay'));

    bind('settingsBtn','click', ()=> showOverlay('settingsOverlay'));
    bind('settingsCloseBtn','click', ()=> showOverlay('menuOverlay'));
    bind('soundToggle','click', ()=>{
      const b=$('soundToggle');
      b.textContent=b.textContent.includes('On')
        ? '🔇 Sound: Off'
        : '🔊 Sound: On';
    });
    bind('darkToggle','click', ()=>{
      document.body.classList.toggle('dark-mode');
      const b=$('darkToggle');
      b.textContent=b.textContent.includes('Off')
        ? '🌙 Dark Mode: On'
        : '☀️ Light Mode: Off';
    });
    bind('skipToggle','click', ()=>{
      const b=$('skipToggle');
      b.textContent=b.textContent.includes('Off')
        ? '🚀 Skip to GO: On'
        : '🚀 Skip to GO: Off';
    });

    bind('hubBtn','click', ()=> location.href='https://app.masonnet.org/flappybirdhub');
    bind('pc-searchBtn','click', ()=> showOverlay('searchOverlay'));

    // TEST BUTTON
    if(window.TEST_MODE){
      const t=$('testBtn'); if(t) t.style.display='block';
    }

    // DIAGNOSTICS
    bind('testBtn','click', async ()=>{
      const pwd=prompt('Admin password:');
      if(!pwd) return;
      try{
        const cred=await auth.signInWithEmailAndPassword(adminEmail,pwd);
        const snap=await rolesRef.child(cred.user.uid).once('value');
        if(snap.val()!=='admin') throw new Error();
      }catch{
        return alert('Invalid admin credentials');
      }
      await runDiagnostics();
    });
    bind('testClose','click', ()=>{
      showOverlay('menuOverlay');
      auth.signOut();
    });

    async function runDiagnostics(){
      const report=$('testReport'),
            status=$('loadingStatus'),
            timeEl=$('loadingTime'),
            bar=$('loadingBar');
      const tests=[]; let passed=0;

      function add(label,fn){ tests.push({label,fn}); }

      add('Canvas exists', ()=>!!$('canvas'));
      add('Pause & style', ()=>{
        const b=$('pauseBtn'),
              s=getComputedStyle(b),
              r=b.getBoundingClientRect();
        return s.backgroundColor==='rgb(255, 0, 0)'
          && s.padding.includes('16px')
          && s.borderRadius.includes('4px')
          && r.top<30 && r.right>window.innerWidth-80;
      });
      add('Overlay system', ()=>typeof showOverlay==='function');
      add('startGame defined', ()=>typeof startGame==='function');
      add('Firebase initialized', ()=>!!firebase.app().name);
      add('Roles structure', async ()=>{
        const r=await rolesRef.once('value'); return r.exists();
      });
      add('Leaderboard fetch', async ()=>{
        const s=await lbRef.limitToLast(1).once('value'); return s.exists();
      });
      add('Login inputs style', ()=>{
        const ie=$('loginEmail'), ip=$('loginPass');
        if(!ie||!ip) return false;
        const se=getComputedStyle(ie), sp=getComputedStyle(ip);
        return ie.type==='email'
          && se.padding.includes('10px')
          && parseInt(se.fontSize)>=16
          && ip.type==='password'
          && sp.padding.includes('10px')
          && parseInt(sp.fontSize)>=16;
      });
      add('Admin sign-in works', async ()=>{
        await auth.signInWithEmailAndPassword(adminEmail,'admin123');
        const u=auth.currentUser; await auth.signOut();
        return u && u.uid===adminUID;
      });
      add('Search input style', ()=>{
        const si=$('searchInput'), ss=getComputedStyle(si);
        return si && ss.padding.includes('10px') && parseInt(ss.fontSize)>=16;
      });
      add('ProfileCard toggle works', ()=>{
        const pc=$('profileCard');
        pc.classList.remove('expanded');
        if(pc.classList.contains('expanded')) return false;
        pc.click();
        const exp = pc.classList.contains('expanded');
        pc.click();
        const col = !pc.classList.contains('expanded');
        return exp && col;
      });
      add('Design – Body bg', ()=>getComputedStyle(document.body).backgroundColor==='rgb(0, 0, 0)');
      add('Image assets load', ()=>Promise.all([
        loadImage('https://app.masonnet.org/fbrc.png'),
        loadImage('https://app.masonnet.org/default-avatar.png')
      ]).then(()=>true).catch(()=>false));
      add('Sound assets load', ()=>Promise.all([
        loadAudio('https://app.masonnet.org/flap.mp3'),
        loadAudio('https://app.masonnet.org/point.mp3')
      ]).then(()=>true).catch(()=>false));
      add('Pause/resume flow', async ()=>{
        showOverlay('pauseOverlay'); hideAll(); return true;
      });

      // run them
      showOverlay('testLoadingOverlay');
      report.innerHTML='';
      const total=tests.length, start=Date.now();
      for(let i=0;i<total;i++){
        status.textContent=`Testing: ${tests[i].label}`;
        let ok=false;
        try{ ok=await tests[i].fn(); }catch{}
        const d=document.createElement('div');
        d.innerHTML= ok?`✅ ${tests[i].label}`:`❌ ${tests[i].label}`;
        report.appendChild(d);
        if(ok) passed++;
        const pct=Math.round(((i+1)/total)*100);
        bar.style.width = pct+'%';
        const elapsed=(Date.now()-start)/1000;
        const rem=Math.max(0,((elapsed/(i+1))*(total-(i+1))).toFixed(1));
        timeEl.textContent=`Estimated time remaining: ${rem}s`;
      }
      status.textContent=`Diagnostics complete: ${passed}/${total} passed`;
      setTimeout(()=>showOverlay('testOverlay'),500);
    }

    function loadImage(src){
      return new Promise((res,rej)=>{
        const img=new Image();
        img.onload=res; img.onerror=rej; img.src=src;
      });
    }
    function loadAudio(src){
      return new Promise((res,rej)=>{
        const a=new Audio(src);
        a.oncanplaythrough=res; a.onerror=rej; a.src=src;
      });
    }

    // start at menu
    showOverlay('menuOverlay');
  });
  </script>
</body>
</html>
