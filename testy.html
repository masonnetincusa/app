<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flappy Bird Branded</title>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: Arial, sans-serif; background: #e0f7fa; color: #333; }
    body.dark-mode { background: #121212; color: #eee; }

    /* Header & Nav */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 20px; background: #fff; border-bottom: 1px solid #ddd;
    }
    body.dark-mode header { background: #1e1e1e; border-color: #333; }
    .logo { height: 40px; }
    .nav-buttons button {
      margin-right: 10px; padding: 6px 12px; cursor: pointer;
    }

    /* Profile Card */
    .profile-card { position: relative; }
    .profile-card img {
      width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
    }
    .profile-panel {
      position: absolute; top: 50px; right: 0;
      background: #fff; border: 1px solid #ccc; padding: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); width: 160px;
    }
    body.dark-mode .profile-panel { background: #2a2a2a; border-color: #444; color: #ddd; }
    .profile-panel.hidden { display: none; }
    .profile-options button {
      display: block; width: 100%; margin-top: 8px; padding: 6px; text-align: left; cursor: pointer;
    }

    /* Game Container */
    #gameContainer {
      display: flex; justify-content: center; align-items: center;
      height: calc(100% - 62px);
    }

    /* Modal Base */
    .modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex;
      align-items: center; justify-content: center;
    }
    .modal.hidden { display: none; }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 4px;
      width: 320px; text-align: center;
    }
    body.dark-mode .modal-content { background: #2b2b2b; color: #ddd; }
    .modal-content.small { width: 240px; }
    .modal-content h2 { margin-bottom: 12px; }
    .modal-content label { display: block; margin: 8px 0; cursor: pointer; }
    .modal-content button { margin-top: 12px; padding: 6px 12px; cursor: pointer; }

    /* Leaderboard List */
    #leaderboardList {
      list-style: none; margin: 15px 0; max-height: 200px; overflow-y: auto;
    }
    #leaderboardList li {
      padding: 6px 0; border-bottom: 1px solid #eee;
    }
    body.dark-mode #leaderboardList li { border-color: #444; }

    /* Game Over */
    #finalScore { font-weight: bold; color: #e91e63; }
  </style>
</head>
<body>

  <header>
    <img src="https://app.masonnet.org/fbrc.png" alt="Logo" class="logo">
    <div class="nav-buttons">
      <button id="startBtn">Start</button>
      <button id="hubBtn">Flappy Bird Hub</button>
      <button id="leaderboardBtn">Leaderboard</button>
    </div>
    <div class="profile-card">
      <img id="profileAvatar" src="https://app.masonnet.org/default-avatar.png" alt="Profile">
      <div id="profilePanel" class="profile-panel hidden">
        <p id="username">Guest</p>
        <div class="profile-options">
          <button id="settingsBtn">Settings</button>
          <button id="adminConsoleBtn" class="hidden">Admin Console</button>
          <button id="logoutBtn">Log Out</button>
        </div>
      </div>
    </div>
  </header>

  <main id="gameContainer">
    <canvas id="gameCanvas" width="480" height="640"></canvas>
  </main>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content small">
      <h2>Settings</h2>
      <label><input type="checkbox" id="soundToggle" checked> Sound</label>
      <label><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <label><input type="checkbox" id="skipToggle"> Skip to Game Over</label>
      <button id="closeSettingsBtn">Close</button>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal" class="modal hidden">
    <div class="modal-content">
      <h2>Top 10 Leaderboard</h2>
      <ul id="leaderboardList"></ul>
      <button id="closeLbBtn">Close</button>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div id="gameOverModal" class="modal hidden">
    <div class="modal-content">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button id="submitScoreBtn">Submit Score</button>
      <button id="restartBtn">Restart</button>
    </div>
  </div>

  <!-- Admin Console Modal -->
  <div id="adminModal" class="modal hidden">
    <div class="modal-content">
      <h2>Admin Console</h2>
      <p>⚙️ Diagnostics & controls go here.</p>
      <button id="closeAdminBtn">Close</button>
    </div>
  </div>

  <!-- Firebase + Game Script -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import {
      getFirestore, collection, getDocs, addDoc,
      serverTimestamp, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    // ← YOUR FIREBASE CONFIG BELOW (replace with actual values) →
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID"
    };
    initializeApp(firebaseConfig);
    const db = getFirestore();

    let soundEnabled = true;
    let darkMode = false;
    let skipGameOver = false;
    let currentGame = null;

    const flapSound  = new Audio('https://app.masonnet.org/flap.mp3');
    const scoreSound = new Audio('https://app.masonnet.org/score.mp3');

    const user = { name: 'Guest', isAdmin: false };

    // DOM refs
    const startBtn        = document.getElementById('startBtn');
    const hubBtn          = document.getElementById('hubBtn');
    const leaderboardBtn  = document.getElementById('leaderboardBtn');
    const settingsBtn     = document.getElementById('settingsBtn');
    const settingsModal   = document.getElementById('settingsModal');
    const soundToggle     = document.getElementById('soundToggle');
    const darkToggle      = document.getElementById('darkToggle');
    const skipToggle      = document.getElementById('skipToggle');
    const closeSettingsBtn= document.getElementById('closeSettingsBtn');
    const leaderboardModal= document.getElementById('leaderboardModal');
    const leaderboardList = document.getElementById('leaderboardList');
    const closeLbBtn      = document.getElementById('closeLbBtn');
    const gameOverModal   = document.getElementById('gameOverModal');
    const finalScoreEl    = document.getElementById('finalScore');
    const submitScoreBtn  = document.getElementById('submitScoreBtn');
    const restartBtn      = document.getElementById('restartBtn');
    const adminConsoleBtn = document.getElementById('adminConsoleBtn');
    const adminModal      = document.getElementById('adminModal');
    const closeAdminBtn   = document.getElementById('closeAdminBtn');
    const profileAvatar   = document.getElementById('profileAvatar');
    const profilePanel    = document.getElementById('profilePanel');
    const usernameField   = document.getElementById('username');

    // Init profile
    usernameField.textContent = user.name;
    if (user.isAdmin) adminConsoleBtn.classList.remove('hidden');

    // Toggle panels
    profileAvatar.addEventListener('click', () =>
      profilePanel.classList.toggle('hidden')
    );

    settingsBtn.addEventListener('click', () =>
      settingsModal.classList.remove('hidden')
    );
    closeSettingsBtn.addEventListener('click', () =>
      settingsModal.classList.add('hidden')
    );
    soundToggle.addEventListener('change', e =>
      soundEnabled = e.target.checked
    );
    darkToggle.addEventListener('change', e => {
      darkMode = e.target.checked;
      document.body.classList.toggle('dark-mode', darkMode);
    });
    skipToggle.addEventListener('change', e =>
      skipGameOver = e.target.checked
    );

    adminConsoleBtn.addEventListener('click', () =>
      adminModal.classList.remove('hidden')
    );
    closeAdminBtn.addEventListener('click', () =>
      adminModal.classList.add('hidden')
    );

    hubBtn.addEventListener('click', () =>
      window.location.href = 'https://app.masonnet.org/flappybirdhub'
    );
    leaderboardBtn.addEventListener('click', showLeaderboard);
    closeLbBtn.addEventListener('click', () =>
      leaderboardModal.classList.add('hidden')
    );

    startBtn.addEventListener('click', () => {
      if (skipGameOver) return endGame(0);
      startGame();
    });
    restartBtn.addEventListener('click', () => {
      gameOverModal.classList.add('hidden');
      startGame();
    });

    submitScoreBtn.addEventListener('click', async () => {
      const score = parseInt(finalScoreEl.textContent, 10);
      await addDoc(collection(db, 'scores'), {
        username: user.name,
        score,
        createdAt: serverTimestamp()
      });
      submitScoreBtn.disabled = true;
    });

    async function showLeaderboard() {
      leaderboardList.innerHTML = '';
      const q = query(collection(db, 'scores'), orderBy('score', 'desc'));
      const snap = await getDocs(q);
      snap.docs.slice(0, 10).forEach((doc, i) => {
        const { username, score } = doc.data();
        const li = document.createElement('li');
        li.textContent = `${i+1}. ${username} — ${score}`;
        leaderboardList.append(li);
      });
      leaderboardModal.classList.remove('hidden');
    }

    // Bird, Pipe, Game classes (same as before)…
    class Bird {
      constructor(ctx, x, y) {
        this.ctx = ctx; this.x = x; this.y = y;
        this.vel = 0; this.radius = 12;
      }
      flap() {
        this.vel = -5;
        if (soundEnabled) flapSound.play();
      }
      update() {
        this.vel += 0.25;
        this.y += this.vel;
        if (this.y + this.radius > this.ctx.canvas.height) {
          this.y = this.ctx.canvas.height - this.radius;
          return true;
        }
        if (this.y - this.radius < 0) {
          this.y = this.radius;
        }
        return false;
      }
      draw() {
        const { ctx, x, y, radius } = this;
        ctx.fillStyle = '#ffeb3b';
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI*2);
        ctx.fill();
      }
    }

    class Pipe {
      constructor(ctx, x) {
        this.ctx = ctx; this.x = x;
        this.width = 40; this.gap = 120;
        this.top = Math.random() * (ctx.canvas.height - this.gap - 100) + 50;
        this.passed = false;
      }
      update() { this.x -= 2; }
      draw() {
        const { ctx, x, width, gap, top } = this;
        ctx.fillStyle = '#4caf50';
        ctx.fillRect(x, 0, width, top);
        ctx.fillRect(x, top+gap, width, ctx.canvas.height-top-gap);
      }
    }

    class Game {
      constructor(canvas) {
        this.canvas = canvas;
        this.ctx    = canvas.getContext('2d');
        this.bird   = new Bird(this.ctx, 80, canvas.height/2);
        this.pipes  = [];
        this.frame  = 0;
        this.score  = 0;
        this.anim   = null;
        this.inputHandler = e => {
          if (e.code === 'Space') this.bird.flap();
        };
        document.addEventListener('keydown', this.inputHandler);
      }
      loop = () => {
        this.anim = requestAnimationFrame(this.loop);
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        if (this.frame % 120 === 0) this.pipes.push(new Pipe(this.ctx, this.canvas.width));
        this.pipes.forEach(p => {
          p.update(); p.draw();
          if (!p.passed && p.x + p.width < this.bird.x) {
            p.passed = true; this.score++;
            if (soundEnabled) scoreSound.play();
          }
          const hitTop = this.bird.y - this.bird.radius < p.top;
          const hitBot = this.bird.y + this.bird.radius > p.top + p.gap;
          const inX    = this.bird.x + this.bird.radius > p.x &&
                         this.bird.x - this.bird.radius < p.x + p.width;
          if (inX && (hitTop || hitBot)) return this.end();
        });
        if (this.bird.update()) return this.end();
        this.bird.draw();
        this.ctx.fillStyle = '#fff';
        this.ctx.font = '28px Arial';
        this.ctx.fillText(this.score, this.canvas.width - 60, 40);
        this.frame++;
      }
      start() { this.reset(); this.loop(); }
      reset() {
        cancelAnimationFrame(this.anim);
        this.bird  = new Bird(this.ctx, 80, this.canvas.height/2);
        this.pipes = []; this.frame = 0; this.score = 0;
      }
      end() {
        document.removeEventListener('keydown', this.inputHandler);
        cancelAnimationFrame(this.anim);
        endGame(this.score);
      }
    }

    function startGame() {
      if (currentGame) currentGame.reset();
      currentGame = new Game(document.getElementById('gameCanvas'));
      currentGame.start();
    }

    function endGame(score) {
      finalScoreEl.textContent = score;
      submitScoreBtn.disabled = false;
      gameOverModal.classList.remove('hidden');
    }
  </script>
</body>
</html>
