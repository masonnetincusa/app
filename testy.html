<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Flappy Bird – Complete App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <!-- Pixel Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
        rel="stylesheet"/>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    html,body { width:100%; height:100%; overflow:hidden; background:#000; color:#fff; font-family:Arial,sans-serif; }
    button,input,textarea { font-family:inherit; }

    /* Background & Canvas */
    #background { position:absolute; top:0; left:0; width:100%; height:100%; background:url('https://app.masonnet.org/lightbg.png')center/cover no-repeat; z-index:0; display:none; }
    canvas { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; touch-action:none; }
    #score { position:absolute; top:10px; left:10px; font-family:'Press Start 2P'; font-size:48px; text-shadow:2px 2px 4px rgba(0,0,0,.7); z-index:2; }
    #pauseBtn { position:absolute; top:10px; right:10px; display:none; z-index:2; padding:8px 16px; background:#f00; border:none; cursor:pointer; }

    /* Profile Card */
    #profileCard { position:absolute; top:10px; right:10px; width:64px; height:64px; background:rgba(0,0,0,.7); border:2px solid #f00; border-radius:8px; overflow:hidden; cursor:pointer; z-index:1000; transition:width .2s,height .2s; }
    #profileCard.expanded { width:240px; height:auto; }
    #pc-collapsed { display:flex; align-items:center; justify-content:center; width:100%; height:100%; }
    #pc-collapsed img { width:48px; height:48px; border-radius:50%; }
    #pc-collapsed-text { display:none; margin-top:8px; font-size:14px; }
    #profileCard.expanded #pc-collapsed { flex-direction:column; padding:8px; }
    #profileCard.expanded #pc-collapsed-text { display:block; }
    #pc-options { display:none; flex-direction:column; background:rgba(0,0,0,.85); padding:8px; }
    #profileCard.expanded #pc-options { display:flex; }
    #pc-options button { margin:4px 0; padding:6px; background:#f00; border:none; color:#fff; cursor:pointer; font-size:14px; }

    /* Overlays */
    .overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.85); display:flex; align-items:center; justify-content:center; z-index:500; }
    .hidden { display:none; }
    .overlay-content { width:320px; max-width:90%; text-align:center; }
    .overlay-content h2 { margin-bottom:12px; font-size:24px; }
    .overlay-content input, .overlay-content textarea { width:100%; padding:6px; margin:6px 0; border:none; border-radius:4px; font-size:14px; }
    .overlay-content textarea { height:80px; resize:none; }
    .overlay-content button { width:100%; padding:8px; margin:6px 0; background:#f00; border:none; color:#fff; cursor:pointer; font-size:16px; }
    .overlay-content label { display:flex; align-items:center; justify-content:center; margin:6px 0; }
    .overlay-content label input { margin-right:6px; }

    .scroll-list { max-height:160px; overflow-y:auto; text-align:left; background:#111; padding:6px; border-radius:4px; margin:6px 0; }
    .scroll-list div { padding:4px 0; border-bottom:1px solid #333; }

    /* Admin Tabs */
    .admin-tabs { display:flex; margin:8px 0; }
    .admin-tabs button { flex:1; margin:0 4px; padding:6px; background:#222; color:#fff; border:none; cursor:pointer; font-size:14px; }
    .admin-tab-content { display:none; text-align:left; }
    .admin-tab-content.active { display:block; }
    .badge-icon { width:16px; height:16px; margin-left:4px; }
  </style>
</head>
<body>

  <!-- Background + Canvas -->
  <div id="background"></div>
  <canvas id="canvas"></canvas>
  <div id="score">0</div>
  <button id="pauseBtn">Pause</button>

  <!-- Profile Card -->
  <div id="profileCard">
    <div id="pc-collapsed">
      <img id="pc-avatar" src="https://app.masonnet.org/default-avatar.png" alt="Avatar"/>
      <span id="pc-collapsed-text">Not signed in</span>
    </div>
    <div id="pc-options">
      <button id="pc-authBtn">Sign In</button>
      <button id="pc-feedbackBtn">Submit Feedback</button>
      <button id="pc-accountBtn">Account Settings</button>
      <button id="pc-customizeBtn">Customize Profile</button>
      <button id="pc-adminBtn" style="display:none;">Admin</button>
      <button id="pc-searchBtn">Search Profiles…</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Sign In</h2>
      <input id="loginEmail" type="email" placeholder="Email"/>
      <input id="loginPass" type="password" placeholder="Password"/>
      <label><input id="loginRemember" type="checkbox"/> Remember me</label>
      <button id="loginSubmit">Submit</button>
      <button id="loginCancel">Cancel</button>
    </div>
  </div>

  <!-- MAIN MENU -->
  <div id="menuOverlay" class="overlay">
    <div class="overlay-content">
      <img src="https://app.masonnet.org/fbrc.png" style="max-width:180px; margin-bottom:12px;"/>
      <h2>Main Menu</h2>
      <button id="startBtn">Start</button>
      <button id="leaderboardBtn">Leaderboard</button>
      <button id="settingsBtn">Settings</button>
      <button id="hubBtn">Flappy Bird Hub</button>
    </div>
  </div>

  <!-- ACCOUNT SETTINGS -->
  <div id="accountOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Account Settings</h2>
      <img id="as-avatar" src="https://app.masonnet.org/default-avatar.png"
           style="width:64px;height:64px;border-radius:50%;margin-bottom:8px;"/>
      <div>Username: <span id="as-username"></span></div>
      <h3>Your Scores</h3>
      <div id="as-scoreHistory" class="scroll-list"></div>
      <button id="pc-customizeBtn2">Customize Profile</button>
      <button id="as-closeBtn">Close</button>
    </div>
  </div>

  <!-- CUSTOMIZE PROFILE -->
  <div id="customizeOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Customize Profile</h2>
      <input id="cust-avatarUrl" placeholder="Avatar URL"/>
      <input id="cust-username" placeholder="Username"/>
      <input id="cust-firstName" placeholder="First Name"/>
      <input id="cust-lastName" placeholder="Last Name"/>
      <textarea id="cust-description" placeholder="Description"></textarea>
      <button id="custSaveBtn">Save</button>
      <button id="custCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- PROFILE VIEW -->
  <div id="profileOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Profile</h2>
      <img id="pf-avatar" src="https://app.masonnet.org/default-avatar.png"
           style="width:64px;height:64px;border-radius:50%;margin-bottom:8px;"/>
      <div><strong id="pf-username"></strong><span id="pf-exclBadges"></span></div>
      <div id="pf-name"></div>
      <div>Description: <span id="pf-description"></span></div>
      <div>High Score: <span id="pf-highscore"></span></div>
      <div>Rank: <span id="pf-rank"></span></div>
      <div id="pf-badges"></div>
      <div id="pf-ownerExtras" class="hidden">
        <h3>Your History</h3>
        <div id="pf-history" class="scroll-list"></div>
      </div>
      <button id="pf-closeBtn">Close</button>
    </div>
  </div>

  <!-- FEEDBACK -->
  <div id="feedbackOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Submit Feedback</h2>
      <label><input type="radio" name="fbType" value="feature" checked/> Feature</label>
      <label><input type="radio" name="fbType" value="general"/> General</label>
      <label><input type="radio" name="fbType" value="bug"/> Bug</label>
      <input id="fbSubject" placeholder="Subject"/>
      <textarea id="fbDetails" placeholder="Describe…"></textarea>
      <button id="fbSubmit">Submit</button>
      <button id="fbCancel">Cancel</button>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Settings</h2>
      <button id="soundToggle">🔊 Sound</button>
      <button id="themeToggle">🌙 Dark Mode</button>
      <button id="skipToggle">🚀 Skip to GO</button>
      <button id="settingsCloseBtn">Close</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div id="leaderboardOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Leaderboard</h2>
      <div id="leaderboardList" class="scroll-list"></div>
      <button id="lbCloseBtn">Back</button>
    </div>
  </div>

  <!-- ADMIN CONSOLE -->
  <div id="adminOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Admin Console</h2>
      <div class="admin-tabs">
        <button id="tabHomeBtn">Home</button>
        <button id="tabFeedbackBtn">Feedback</button>
        <button id="tabModerationBtn">Moderation</button>
        <button id="tabOtherBtn">Other</button>
      </div>
      <div id="adminHome" class="admin-tab-content active"><p>Welcome, Admin!</p></div>
      <div id="adminFeedback" class="admin-tab-content"><h3>Feedback</h3><div id="adminFeedbackList" class="scroll-list"></div></div>
      <div id="adminModeration" class="admin-tab-content"><h3>Moderation</h3><input id="modSearch" placeholder="Search…"/><button id="modSearchBtn">Find</button><div id="modUserInfo" class="scroll-list"></div></div>
      <div id="adminOther" class="admin-tab-content"><p>Other tools…</p></div>
      <button id="adminCloseBtn">Close</button>
    </div>
  </div>

  <!-- PAUSE -->
  <div id="pauseOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Paused</h2>
      <button id="resumeBtn">Resume</button>
      <button id="pauseMenuBtn">Main Menu</button>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameoverOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>Game Over</h2>
      <p>Your Score: <span id="finalScore">0</span></p>
      <button id="restartBtn">Restart</button>
      <button id="goMenuBtn">Main Menu</button>
    </div>
  </div>

  <!-- HIGH SCORE PROMPT -->
  <div id="nameOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>🎉 New High Score!</h2>
      <p>Score: <span id="newScore"></span></p>
      <input id="nameInput" placeholder="Enter name…"/>
      <button id="saveNameBtn">Save</button>
      <button id="skipNameBtn">Skip</button>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDtfrpxKaROrq1D0NUAbFl0FZ9E7axOIxE",
      authDomain: "masonnet-app-official.firebaseapp.com",
      databaseURL: "https://masonnet-app-official-default-rtdb.firebaseio.com",
      projectId: "masonnet-app-official",
      storageBucket: "masonnet-app-official.firebasestorage.app",
      messagingSenderId: "783919367562",
      appId: "1:783919367562:web:b7bb809332a4e873f3b473",
      measurementId: "G-X1YKV5VK7J"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.database();
    const lbRef = db.ref("leaderboard"), fbRef = db.ref("feedback");
    const profilesRef = db.ref("profiles"), rolesRef = db.ref("roles");

    // Helpers
    const $ = id => document.getElementById(id),
          elt = (t,c) => { let e = document.createElement(t); if(c) e.className = c; return e; };
    function clearLogin(){ $('loginEmail').value=''; $('loginPass').value=''; }
    function showOverlay(id){
      ['loginOverlay','menuOverlay','accountOverlay','customizeOverlay','profileOverlay','feedbackOverlay','settingsOverlay','leaderboardOverlay','adminOverlay','pauseOverlay','gameoverOverlay','nameOverlay']
        .forEach(x=>$(x).classList.add('hidden'));
      if(id) $(id).classList.remove('hidden');
      $('profileCard').style.display = (id==='menuOverlay'?'block':'none');
      $('profileCard').classList.remove('expanded');
    }
    function renderUser(name,bads=[]){
      let s = elt('span'); s.textContent = name;
      bads.forEach(b=>{ let i = elt('img','badge-icon'); i.src = badgeIcons[b]; s.appendChild(i); });
      return s;
    }
    const badgeIcons = {
      gold:'https://app.masonnet.org/badge-gold.png',
      survivor:'https://app.masonnet.org/badge-survivor.png',
      top10:'https://app.masonnet.org/badge-top10.png',
      accurate:'https://app.masonnet.org/badge-accurate.png',
      verified:'https://app.masonnet.org/badge-verified.png',
      tournament:'https://app.masonnet.org/badge-tourney.png',
      friend:'https://app.masonnet.org/badge-friend.png',
      admin:'https://app.masonnet.org/badge-admin.png',
      employee:'https://app.masonnet.org/badge-employee.png',
      supporter:'https://app.masonnet.org/badge-supporter.png'
   

    // DOM Refs
    const pcAuth=$('pc-authBtn'), pcFb=$('pc-feedbackBtn'), pcAcc=$('pc-accountBtn'),
          pcCus=$('pc-customizeBtn'), pcCus2=$('pc-customizeBtn2'), pcAdm=$('pc-adminBtn'), pcSr=$('pc-searchBtn'),
          lSub=$('loginSubmit'), lCan=$('loginCancel'), lRem=$('loginRemember'),
          csS=$('custSaveBtn'), csC=$('custCancelBtn'), asC=$('as-closeBtn'), pfC=$('pf-closeBtn'),
          fbS=$('fbSubmit'), fbC=$('fbCancel'), lbB=$('leaderboardBtn'), lbC=$('lbCloseBtn'),
          setB=$('settingsBtn'), setC=$('settingsCloseBtn'), hubB=$('hubBtn'),
          pauseB=$('pauseBtn'), resB=$('resumeBtn'), pmB=$('pauseMenuBtn'),
          reB=$('restartBtn'), gmB=$('goMenuBtn'), snB=$('saveNameBtn'), skB=$('skipNameBtn');

    // Assets
    const pointS=new Audio('https://app.masonnet.org/point.mp3'),
          flapS=new Audio('https://app.masonnet.org/flap.mp3'),
          hitS=new Audio('https://app.masonnet.org/hit.mp3'),
          dieS=new Audio('https://app.masonnet.org/die.mp3'),
          birdImg=new Image(), pipeImg=new Image();
    birdImg.src='https://app.masonnet.org/bird.png'; pipeImg.src='https://app.masonnet.org/pipe-green.png';

    // Canvas
    const canvas = $('canvas'), ctx = canvas.getContext('2d');
    function onResize(){ canvas.width=innerWidth; canvas.height=innerHeight; }
    window.addEventListener('resize', onResize); onResize();

    // Game State
    let state='menu', bird, pipes, score, frame, raf, collided, gravity=0.25, speed=2;

    class BirdClass {
      constructor(){ this.x=50; this.y=canvas.height*.4; this.w=36; this.h=30; this.vy=0; }
      flap(){ this.vy=-6; flapS.play().catch(()=>{}); }
      update(){ this.vy+=gravity; this.y+=this.vy; if(this.y<0) this.y=0; if(this.y+this.h>canvas.height) this.die(); }
      draw(){ ctx.drawImage(birdImg,this.x,this.y,this.w,this.h); }
      collides(p){ return !(this.x+this.w<p.x || this.x>p.x+p.w || this.y+this.h<p.top || this.y>p.bottom); }
      die(){ if(state!=='playing'||collided) return; collided=true; state='dying'; cancelAnimationFrame(raf); hitS.play().catch(()=>{}); hitS.onended=()=>{ dieS.play().catch(()=>{}); dieS.onended=endGame; }; }
    }

    function spawnPipe(){ let gap=120, top=20+Math.random()*(canvas.height-gap-40); pipes.push({ x:canvas.width, w:60, top, bottom:top+gap, passed:false }); }
    function loop(){
      if(state!=='playing') return;
      raf=requestAnimationFrame(loop); frame++;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      pipes.forEach((p,i)=>{ p.x-=speed; ctx.drawImage(pipeImg,p.x,0,p.w,p.top); ctx.drawImage(pipeImg,p.x,p.bottom,p.w,canvas.height-p.bottom);
        if(!p.passed && bird.x>p.x+p.w){ p.passed=true; score++; pointS.play().catch(()=>{}); }
        if(bird.collides(p)) bird.die();
        if(p.x+p.w<0) pipes.splice(i,1);
      });

      bird.update(); bird.draw();
      if(frame%150===0) spawnPipe();

      ctx.fillStyle='#fff'; ctx.font='32px Press Start 2P'; ctx.fillText(score,20,50);
    }

    function startGame(){ bird=new BirdClass(); pipes=[]; score=0; frame=0; collided=false; state='playing'; $('pauseBtn').style.display='block'; loop(); }
    function endGame(){ $('finalScore').textContent=score; showOverlay('gameoverOverlay'); }

    canvas.addEventListener('mousedown', ()=>{ if(state==='playing') bird.flap(); });
    canvas.addEventListener('touchstart', e=>{ e.preventDefault(); if(state==='playing') bird.flap(); });

    // UI Hooks
    $('startBtn').onclick=startGame;
    $('pauseBtn').onclick=()=>{ if(state==='playing'){ cancelAnimationFrame(raf); showOverlay('pauseOverlay'); state='paused'; } };
    $('resumeBtn').onclick=()=>{ showOverlay(); state='playing'; loop(); };
    $('pauseMenuBtn').onclick=()=>{ cancelAnimationFrame(raf); $('pauseBtn').style.display='none'; showOverlay('menuOverlay'); state='menu'; };
    $('restartBtn').onclick=startGame;
    $('goMenuBtn').onclick=()=>{ showOverlay('menuOverlay'); $('pauseBtn').style.display='none'; };
    $('saveNameBtn').onclick=()=>{ let n=$('nameInput').value.trim()||'Anonymous'; lbRef.push({ name:n, score, uid:auth.currentUser?.uid, timestamp:Date.now() }); showOverlay('gameoverOverlay'); };
    $('skipNameBtn').onclick=()=>showOverlay('gameoverOverlay');

    // Settings
    let soundOn=true, darkMode=false;
    $('soundToggle').onclick=()=>{ soundOn=!soundOn; $('soundToggle').textContent=soundOn?'🔊 Sound':'🔇 Mute'; };
    $('themeToggle').onclick=()=>{ darkMode=!darkMode; $('themeToggle').textContent=darkMode?'☀️ Light':'🌙 Dark'; $('background').style.backgroundImage=darkMode?"url('https://app.masonnet.org/darkbg.png')":"url('https://app.masonnet.org/lightbg.png')"; };
    $('skipToggle').onclick=()=>alert('Skip to GO toggled');

    // Hub
    $('hubBtn').onclick=()=>window.location.href='https://app.masonnet.org/flappybirdhub';

    // Auth state
    auth.onAuthStateChanged(u=>{
      if(u){
        profilesRef.child(u.uid).once('value', sn=>{ let p=sn.val()||{}; $('pc-avatar').src=p.avatarUrl||$('pc-avatar').src; $('pc-collapsed-text').textContent=p.username||u.email.split('@')[0]; });
        pcAuth.textContent='Sign Out';
        [pcFb,pcAcc,pcCus,pcCus2].forEach(b=>b.style.display='block');
        rolesRef.child(u.uid).once('value', sn=>{ pcAdm.style.display=sn.val()==='admin'?'block':'none'; });
      } else {
        $('pc-avatar').src='https://app.masonnet.org/default-avatar.png';
        $('pc-collapsed-text').textContent='Not signed in';
        pcAuth.textContent='Sign In';
        [pcFb,pcAcc,pcCus,pcCus2,pcAdm].forEach(b=>b.style.display='none');
      }
      showOverlay('menuOverlay');
    });

    // Profile toggle
    $('profileCard').onclick=e=>{ e.stopPropagation(); $('profileCard').classList.toggle('expanded'); };
    document.body.addEventListener('click', ()=>$('profileCard').classList.remove('expanded'));

    // UI Events
    $('pc-authBtn').onclick=()=>auth.currentUser?auth.signOut():showOverlay('loginOverlay');
    $('loginCancel').onclick=()=>{ clearLogin(); showOverlay('menuOverlay'); };
    $('loginSubmit').onclick=()=>auth.setPersistence(lRem.checked?firebase.auth.Auth.Persistence.LOCAL:firebase.auth.Auth.Persistence.SESSION).then(()=>auth.signInWithEmailAndPassword($('loginEmail').value.trim(),$('loginPass').value.trim())).then(()=>{clearLogin();showOverlay('menuOverlay');}).catch(e=>alert(e.message));
    $('pc-feedbackBtn').onclick=()=>showOverlay('feedbackOverlay');
    $('fbCancel').onclick=()=>showOverlay('menuOverlay');
    $('fbSubmit').onclick=()=>{ let u=auth.currentUser; if(!u)return alert("sign in"); let t=[...document.getElementsByName('fbType')].find(r=>r.checked).value; fbRef.push({uid:u.uid,type:t,subject:$('fbSubject').value.trim(),message:$('fbDetails').value.trim(),timestamp:Date.now()}); alert("Thanks!"); showOverlay('menuOverlay'); };
    $('pc-accountBtn').onclick=()=>{ let u=auth.currentUser; if(!u)return alert("sign in"); $('as-username').textContent=$('pc-collapsed-text').textContent; profilesRef.child(u.uid+'/scores').once('value', sn=>{ let lst=$('as-scoreHistory'); lst.innerHTML=''; Object.values(sn.val()||{}).forEach(r=>{ let d=elt('div'); d.textContent=r.score; lst.appendChild(d); }); }); showOverlay('accountOverlay'); };
    $('as-closeBtn').onclick=()=>showOverlay('menuOverlay');
    $('pc-customizeBtn').onclick=()=>showOverlay('customizeOverlay');
    $('pc-customizeBtn2').onclick=()=>showOverlay('customizeOverlay');
    $('custCancelBtn').onclick=()=>showOverlay('accountOverlay');
    $('custSaveBtn').onclick=()=>{ let u=auth.currentUser; if(!u)return alert("sign in"); let d={avatarUrl:$('cust-avatarUrl').value.trim(),username:$('cust-username').value.trim(),firstName:$('cust-firstName').value.trim(),lastName:$('cust-lastName').value.trim(),description:$('cust-description').value.trim()}; profilesRef.child(u.uid).update(d).then(()=>{ $('pc-avatar').src=d.avatarUrl||$('pc-avatar').src; $('pc-collapsed-text').textContent=d.username; showOverlay('accountOverlay'); }).catch(e=>alert(e.message)); };
    lbB.onclick=()=>loadLeaderboard(); lbC.onclick=()=>showOverlay('menuOverlay');
    function loadLeaderboard(){ let L=$('leaderboardList'); L.innerHTML=''; lbRef.orderByChild('score').limitToLast(10).once('value', sn=>{ Object.values(sn.val()||{}).sort((a,b)=>b.score-a.score).forEach(e=>{ let r=elt('div'), s=renderUser(e.name,e.badges?.exclusive); r.appendChild(s); r.append(`: ${e.score}`); r.onclick=()=>openProfile(e.uid); L.appendChild(r); }); showOverlay('leaderboardOverlay'); }); }
    setB.onclick=()=>showOverlay('settingsOverlay'); setC.onclick=()=>showOverlay('menuOverlay');
    hubB.onclick=()=>window.location.href='https://app.masonnet.org/flappybirdhub';
    document.querySelectorAll('.admin-tabs button').forEach(b=>b.onclick=()=>{ document.querySelectorAll('.admin-tabs button').forEach(x=>x.disabled=false); b.disabled=true; document.querySelectorAll('.admin-tab-content').forEach(x=>x.classList.remove('active')); document.getElementById(b.id.replace('Btn','')).classList.add('active'); });
    $('adminCloseBtn').onclick=()=>showOverlay('menuOverlay');
    $('tabFeedbackBtn').click();
    $('tabFeedbackBtn').onclick=()=>{
      let F=$('adminFeedbackList'); F.innerHTML='';
      fbRef.orderByChild('timestamp').once('value',sn=>{ Object.values(sn.val()||{}).forEach(f=>{ let d=elt('div'); d.innerHTML=`<strong>${f.type}</strong>: ${f.subject}<br/>${f.message}`; F.appendChild(d); }); });
      $('tabFeedbackBtn').click();
    };
    $('modSearchBtn').onclick=()=>{
      let q=$('modSearch').value.trim();
      profilesRef.orderByChild('username').startAt(q).endAt(q+"\uf8ff").once('value',sn=>{ let u=Object.keys(sn.val()||{})[0]; if(!u)return alert("not found"); profilesRef.child(u).once('value',sn2=>{ $('modUserInfo').innerHTML=`<strong>${sn2.val().username}</strong><br/>Status:${sn2.val().moderation?.status||'active'}`; }); });
    };
    function performSearch(q){
      profilesRef.orderByChild('username').startAt(q).endAt(q+"\uf8ff").once('value',sn=>{ let u=Object.keys(sn.val()||{})[0]; if(u)openProfile(u); else alert("no user"); });
    }
    function openProfile(uid){
      profilesRef.child(uid).once('value',sn=>{ let p=sn.val()||{}; $('pf-avatar').src=p.avatarUrl||$('pf-avatar').src; $('pf-username').innerHTML=''; $('pf-username').appendChild(renderUser(p.username,p.badges?.exclusive)); $('pf-name').textContent=`${p.firstName||''} ${p.lastName||''}`; $('pf-description').textContent=p.description||''; $('pf-highscore').textContent=p.highscore||0; lbRef.orderByChild('score').once('value',ls=>{ let arr=Object.values(ls.val()||{}).sort((a,b)=>b.score-a.score), idx=arr.findIndex(e=>e.uid===uid); $('pf-rank').textContent=idx>=0?idx+1:'—'; }); $('pf-badges').innerHTML=''; (p.badges?.standard||[]).forEach(b=>{ let i=elt('img','badge-icon'); i.src=badgeIcons[b]; $('pf-badges').appendChild(i); }); if(auth.currentUser?.uid===uid){ $('pf-ownerExtras').classList.remove('hidden'); $('pf-history').innerHTML=''; db.ref(`scores/${uid}`).orderByKey().once('value',h=>{ Object.values(h.val()||{}).forEach(r=>{ let d=elt('div'); d.textContent=`${new Date(r.timestamp).toLocaleDateString()} – ${r.score}`; $('pf-history').appendChild(d); }); }); }else{$('pf-ownerExtras').classList.add('hidden');} showOverlay('profileOverlay');});
    }
    showOverlay('menuOverlay');
  });
  </script>
</body>
</html>
